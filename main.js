/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var __publicField = (obj, key, value) => __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);

// src/main.ts
var main_exports = {};
__export(main_exports, {
  default: () => MemoryGraphPlugin7
});
module.exports = __toCommonJS(main_exports);

// src/utils/api/api_system.ts
var import_obsidian = require("obsidian");
var _APISystemClient = class _APISystemClient {
  constructor() {
    this.config = null;
    this.baseUrl = "";
    this.endpoints = [];
  }
  /**
   * 连接到 Memory Server
   * @param config 服务器配置
   */
  async connect(config) {
    var _a, _b;
    console.log("[API System] \u5F00\u59CB\u8FDE\u63A5\u5230 Memory Server");
    console.log("[API System] API URL:", config.apiUrl);
    this.config = config;
    try {
      console.log("[API System] \u6B63\u5728\u83B7\u53D6 OpenAPI \u89C4\u8303...");
      const response = await (0, import_obsidian.requestUrl)({
        url: config.apiUrl,
        method: "GET",
        headers: this.getHeaders()
      });
      if (response.status !== 200) {
        throw new Error(`HTTP ${response.status}: ${response.text}`);
      }
      const openApiSpec = JSON.parse(response.text);
      console.log("[API System] OpenAPI \u89C4\u8303\u83B7\u53D6\u6210\u529F");
      console.log("[API System] API \u6807\u9898:", (_a = openApiSpec.info) == null ? void 0 : _a.title);
      console.log("[API System] API \u7248\u672C:", (_b = openApiSpec.info) == null ? void 0 : _b.version);
      const url = new URL(config.apiUrl);
      this.baseUrl = `${url.protocol}//${url.host}`;
      console.log("[API System] Base URL:", this.baseUrl);
      this.endpoints = this.parseEndpoints(openApiSpec);
      console.log("[API System] \u2713 \u8FDE\u63A5\u6210\u529F\uFF0C\u627E\u5230", this.endpoints.length, "\u4E2A API \u7AEF\u70B9");
    } catch (error) {
      console.error("[API System] \u2717 \u8FDE\u63A5\u5931\u8D25:", error);
      throw new Error(`\u8FDE\u63A5 Memory Server \u5931\u8D25: ${error.message}`);
    }
  }
  /**
   * 解析 OpenAPI 规范中的所有端点
   */
  parseEndpoints(spec) {
    const endpoints = [];
    if (!spec.paths) {
      return endpoints;
    }
    for (const [path, pathItem] of Object.entries(spec.paths)) {
      for (const [method, operation] of Object.entries(pathItem)) {
        if (typeof operation === "object" && operation !== null && "operationId" in operation) {
          endpoints.push({
            path,
            method: method.toUpperCase(),
            summary: operation.summary || "",
            description: operation.description || "",
            tags: operation.tags || []
          });
        }
      }
    }
    return endpoints;
  }
  /**
   * 获取所有可用的 API 端点
   */
  getEndpoints() {
    return this.endpoints;
  }
  /**
   * 获取请求头
   */
  getHeaders() {
    var _a;
    const headers = {
      "Content-Type": "application/json"
    };
    if ((_a = this.config) == null ? void 0 : _a.apiKey) {
      headers["Authorization"] = `Bearer ${this.config.apiKey}`;
    }
    return headers;
  }
  /**
   * 获取 Base URL
   */
  getBaseUrl() {
    return this.baseUrl;
  }
  /**
   * 发送 API 请求
   */
  async request(path, method = "GET", body) {
    if (!this.config) {
      throw new Error("API \u5BA2\u6237\u7AEF\u672A\u8FDE\u63A5");
    }
    const url = `${this.baseUrl}${path}`;
    console.log(`[API System] ${method} ${url}`);
    if (body) {
      console.log(`[API System] >>> \u8BF7\u6C42\u4F53:`, JSON.stringify(body, null, 2));
    }
    try {
      const response = await (0, import_obsidian.requestUrl)({
        url,
        method,
        headers: this.getHeaders(),
        body: body ? JSON.stringify(body) : void 0
      });
      if (response.status >= 400) {
        console.error(`[API System] <<< \u54CD\u5E94\u9519\u8BEF (${response.status}):`, response.text);
        throw new Error(`HTTP ${response.status}: ${response.text}`);
      }
      return response.json;
    } catch (error) {
      console.error(`[API System] \u8BF7\u6C42\u5931\u8D25:`, error);
      throw error;
    }
  }
  /**
   * 健康检查
   */
  async healthCheck() {
    return this.request("/health", "GET");
  }
  /**
   * 获取服务器状态
   */
  async getStatus() {
    return this.request("/status", "GET");
  }
  /**
   * 断开连接
   */
  async disconnect() {
    console.log("[API System] \u65AD\u5F00\u8FDE\u63A5");
    this.config = null;
    this.baseUrl = "";
    this.endpoints = [];
  }
  /**
   * 检查是否已连接
   */
  isConnected() {
    return this.config !== null && this.baseUrl !== "";
  }
};
__name(_APISystemClient, "APISystemClient");
var APISystemClient = _APISystemClient;

// src/utils/api/api_search.ts
var _APISearchClient = class _APISearchClient {
  constructor(systemClient) {
    this.systemClient = systemClient;
  }
  /**
   * 搜索节点（关键词精确搜索）
   *
   * 在实体名称、类型、观察记录中匹配包含指定关键词的内容
   * 支持多关键词搜索（空格分隔表示 AND 关系）
   *
   * @param query 搜索关键词
   */
  async searchNodes(query) {
    return this.systemClient.request(
      `/tools/search/nodes?query=${encodeURIComponent(query)}`,
      "GET"
    );
  }
  /**
   * 语义相似度搜索
   *
   * 基于向量找出与查询语义相关的实体，适合模糊搜索和概念关联
   *
   * @param query 搜索查询
   * @param limit 返回结果数量限制，默认 10
   */
  async semanticSearch(query, limit = 10) {
    return this.systemClient.request(
      `/tools/search/semantic?query=${encodeURIComponent(query)}&limit=${limit}`,
      "GET"
    );
  }
  /**
   * 读取完整图谱（支持分页）
   *
   * @param limit 返回的实体数量限制（建议使用 20 避免 token 过多）
   * @param offset 偏移量（用于分页，默认 0）
   */
  async readGraph(limit, offset = 0) {
    let url = `/tools/search/read_graph?offset=${offset}`;
    if (limit) {
      url += `&limit=${limit}`;
    }
    return this.systemClient.request(url, "GET");
  }
  /**
   * 按名称检索特定节点
   *
   * 返回指定名称的实体及其关系信息
   *
   * @param names 实体名称列表
   */
  async openNodes(names) {
    return this.systemClient.request("/tools/search/open", "POST", { names });
  }
};
__name(_APISearchClient, "APISearchClient");
var APISearchClient = _APISearchClient;

// src/utils/api/api_create.ts
var _APICreateClient = class _APICreateClient {
  constructor(systemClient) {
    this.systemClient = systemClient;
  }
  /**
   * 创建实体
   *
   * @param entities 实体列表
   */
  async createEntities(entities) {
    return this.systemClient.request("/tools/entities/create", "POST", { entities });
  }
  /**
   * 添加观察记录
   *
   * 支持两种格式：
   * 1. 扁平格式（每个观察一个对象）
   * 2. 嵌套格式（按实体分组）
   *
   * @param observations 观察记录列表
   */
  async addObservations(observations) {
    return this.systemClient.request("/tools/entities/add_observations", "POST", { observations });
  }
  /**
   * 通过 ID 更新观察记录
   *
   * @param updates 更新列表
   */
  async updateObservationsById(updates) {
    return this.systemClient.request("/tools/entities/update_observations", "POST", { updates });
  }
  /**
   * 创建关系
   *
   * @param relations 关系列表
   * @param autoCreateEntities 是否自动创建缺失的实体（默认 false）
   */
  async createRelations(relations, autoCreateEntities = false) {
    const url = `/tools/relations/create?auto_create_entities=${autoCreateEntities}`;
    return this.systemClient.request(url, "POST", { relations });
  }
  /**
   * 生成向量（用于语义搜索）
   *
   * @param entityNames 指定实体名称列表，为空则处理缺失向量的实体
   * @param limit 处理数量限制（仅当 entityNames 为空时生效），默认 20
   */
  async generateEmbeddings(entityNames, limit = 20) {
    const url = `/tools/search/embeddings?limit=${limit}`;
    const body = entityNames ? { entity_names: entityNames } : { entity_names: null };
    return this.systemClient.request(url, "POST", body);
  }
};
__name(_APICreateClient, "APICreateClient");
var APICreateClient = _APICreateClient;

// src/utils/api/api_delete.ts
var _APIDeleteClient = class _APIDeleteClient {
  constructor(systemClient) {
    this.systemClient = systemClient;
  }
  /**
   * 逻辑删除实体及其关联关系（移至回收站）
   *
   * 注意：此方法将逻辑删除实体（标记为已删除），不会物理删除数据
   * 已删除的实体可以通过 viewTrash 查看和 restoreDeleted 恢复
   *
   * @param entityNames 要删除的实体名称列表
   */
  async deleteEntities(entityNames) {
    return this.systemClient.request("/tools/entities/delete", "POST", { entity_names: entityNames });
  }
  /**
   * 逻辑删除实体的特定观察记录（移至回收站）
   *
   * 注意：此方法将逻辑删除观察记录（标记为已删除），不会物理删除数据
   * 已删除的观察记录可以通过 viewTrash 查看和 restoreDeleted 恢复
   *
   * @param deletions 删除列表
   */
  async deleteObservations(deletions) {
    return this.systemClient.request("/tools/entities/delete_observations", "POST", { deletions });
  }
  /**
   * 删除图谱中的特定关系
   *
   * 注意：此方法将逻辑删除关系（标记为已删除），不会物理删除数据
   *
   * @param relations 要删除的关系列表
   */
  async deleteRelations(relations) {
    return this.systemClient.request("/tools/relations/delete", "POST", { relations });
  }
  /**
   * 查看回收站 - 查看已删除的内容
   *
   * @param limit 返回的实体数量限制（默认 20）
   * @param offset 偏移量（用于分页，默认 0）
   */
  async viewTrash(limit = 20, offset = 0) {
    return this.systemClient.request(`/tools/trash/view?limit=${limit}&offset=${offset}`, "GET");
  }
  /**
   * 恢复已删除的记忆
   *
   * 注意：恢复后，实体/观察记录将重新出现在搜索结果中
   *
   * @param entityNames 要恢复的实体名称列表
   * @param observations 要恢复的观察记录列表
   */
  async restoreDeleted(entityNames, observations) {
    const body = {};
    if (entityNames) {
      body.entity_names = entityNames;
    }
    if (observations) {
      body.observations = observations;
    }
    return this.systemClient.request("/tools/trash/restore", "POST", body);
  }
};
__name(_APIDeleteClient, "APIDeleteClient");
var APIDeleteClient = _APIDeleteClient;

// src/utils/api/api_client.ts
var _APIClient = class _APIClient {
  constructor(app) {
    __publicField(this, "systemClient");
    __publicField(this, "search");
    __publicField(this, "create");
    __publicField(this, "delete");
    this.systemClient = new APISystemClient();
    this.search = new APISearchClient(this.systemClient);
    this.create = new APICreateClient(this.systemClient);
    this.delete = new APIDeleteClient(this.systemClient);
  }
  /**
   * 连接到 Memory Server
   * @param config 服务器配置
   */
  async connect(config) {
    return this.systemClient.connect(config);
  }
  /**
   * 健康检查
   */
  async healthCheck() {
    return this.systemClient.healthCheck();
  }
  /**
   * 获取服务器状态
   */
  async getStatus() {
    return this.systemClient.getStatus();
  }
  /**
   * 断开连接
   */
  async disconnect() {
    return this.systemClient.disconnect();
  }
  /**
   * 检查是否已连接
   */
  isConnected() {
    return this.systemClient.isConnected();
  }
  /**
   * 获取所有可用的 API 端点
   */
  getEndpoints() {
    return this.systemClient.getEndpoints();
  }
  // ============ 向后兼容的方法（保留旧的调用方式） ============
  /**
   * @deprecated 使用 search.searchNodes 替代
   */
  async searchNodes(query) {
    return this.search.searchNodes(query);
  }
  /**
   * @deprecated 使用 search.semanticSearch 替代
   */
  async semanticSearch(query, limit = 10) {
    return this.search.semanticSearch(query, limit);
  }
  /**
   * @deprecated 使用 search.readGraph 替代
   */
  async readGraph(limit, offset = 0) {
    return this.search.readGraph(limit, offset);
  }
  /**
   * @deprecated 使用 search.openNodes 替代
   */
  async openNodes(names) {
    return this.search.openNodes(names);
  }
  /**
   * @deprecated 使用 create.createEntities 替代
   */
  async createEntities(entities) {
    return this.create.createEntities(entities);
  }
  /**
   * @deprecated 使用 create.addObservations 替代
   */
  async addObservations(observations) {
    return this.create.addObservations(observations);
  }
};
__name(_APIClient, "APIClient");
var APIClient = _APIClient;

// src/utils/pages/settings_connection.ts
var _SettingsConnectionManager = class _SettingsConnectionManager {
  constructor(app) {
    this.apiClient = null;
    this.app = app;
  }
  /**
   * 获取当前的 API 客户端
   */
  getApiClient() {
    return this.apiClient;
  }
  /**
   * 设置 API 客户端
   */
  setApiClient(client) {
    this.apiClient = client;
  }
  /**
   * 测试连接并返回端点列表
   */
  async testConnection(settings) {
    console.log("[Settings Connection] \u5F00\u59CB\u6D4B\u8BD5\u8FDE\u63A5\u5230 Memory Server");
    if (!settings.mcpApiUrl) {
      return {
        success: false,
        endpoints: [],
        error: "\u8BF7\u5148\u914D\u7F6E API \u5730\u5740"
      };
    }
    try {
      if (this.apiClient) {
        console.log("[Settings Connection] \u65AD\u5F00\u4E4B\u524D\u7684\u8FDE\u63A5...");
        await this.apiClient.disconnect();
      }
      console.log("[Settings Connection] \u521B\u5EFA\u65B0\u7684 API \u5BA2\u6237\u7AEF...");
      this.apiClient = new APIClient(this.app);
      console.log("[Settings Connection] \u8FDE\u63A5\u5230 Memory Server...");
      await this.apiClient.connect({
        apiUrl: settings.mcpApiUrl,
        apiKey: settings.mcpApiKey
      });
      console.log("[Settings Connection] \u2713 \u8FDE\u63A5\u6210\u529F");
      const endpoints = this.apiClient.getEndpoints();
      console.log("[Settings Connection] \u2713 \u83B7\u53D6\u5230", endpoints.length, "\u4E2A API \u7AEF\u70B9");
      return {
        success: true,
        endpoints
      };
    } catch (error) {
      console.error("[Settings Connection] \u2717 \u8FDE\u63A5\u5931\u8D25:", error);
      return {
        success: false,
        endpoints: [],
        error: error.message
      };
    }
  }
  /**
   * 按标签分组端点
   */
  groupEndpointsByTag(endpoints) {
    const grouped = {};
    endpoints.forEach((endpoint) => {
      const tag = endpoint.tags && endpoint.tags.length > 0 ? endpoint.tags[0] : "\u5176\u4ED6";
      if (!grouped[tag]) {
        grouped[tag] = [];
      }
      grouped[tag].push(endpoint);
    });
    return grouped;
  }
  /**
   * 获取 HTTP 方法对应的颜色
   */
  getMethodColor(method) {
    switch (method.toUpperCase()) {
      case "GET":
        return "var(--text-success)";
      case "POST":
        return "var(--text-accent)";
      case "PUT":
        return "var(--text-warning)";
      case "DELETE":
        return "var(--text-error)";
      default:
        return "var(--text-normal)";
    }
  }
};
__name(_SettingsConnectionManager, "SettingsConnectionManager");
var SettingsConnectionManager = _SettingsConnectionManager;

// src/utils/llm/llm_driver_base.ts
var _LLMDriverBase = class _LLMDriverBase {
  constructor(config) {
    this.abortController = null;
    this.config = config;
  }
  setAbortController(controller) {
    this.abortController = controller;
  }
  validateConfig() {
    if (!this.config.apiUrl) {
      return { success: false, message: "\u8BF7\u914D\u7F6E LLM API URL" };
    }
    if (!this.config.apiKey) {
      return { success: false, message: "\u8BF7\u914D\u7F6E LLM API Key" };
    }
    if (!this.config.modelName) {
      return { success: false, message: "\u8BF7\u914D\u7F6E\u6A21\u578B\u540D\u79F0" };
    }
    return null;
  }
  handleError(error, apiType) {
    console.error(`[${apiType} Driver] \u8FDE\u63A5\u5931\u8D25:`, error);
    let errorMessage = "\u8FDE\u63A5\u5931\u8D25";
    if (error.message.includes("401")) {
      errorMessage = "API Key \u65E0\u6548\u6216\u672A\u6388\u6743";
    } else if (error.message.includes("404")) {
      errorMessage = "\u6A21\u578B\u4E0D\u5B58\u5728\u6216 API URL \u9519\u8BEF";
    } else if (error.message.includes("429")) {
      errorMessage = "API \u8BF7\u6C42\u9891\u7387\u8D85\u9650";
    } else if (error.message.includes("500")) {
      errorMessage = "API \u670D\u52A1\u5668\u9519\u8BEF";
    }
    return {
      success: false,
      message: errorMessage,
      error: error.message
    };
  }
};
__name(_LLMDriverBase, "LLMDriverBase");
var LLMDriverBase = _LLMDriverBase;

// src/utils/llm/llm_driver_anthropic.ts
var import_obsidian4 = require("obsidian");
var _AnthropicLLMDriver = class _AnthropicLLMDriver extends LLMDriverBase {
  constructor(config) {
    super(config);
  }
  // 构建完整的 API URL，智能处理路径
  buildApiUrl(path) {
    const baseUrl = this.config.apiUrl.trim();
    if (baseUrl.includes("/messages")) {
      return baseUrl;
    }
    return `${baseUrl}/v1${path}`;
  }
  // 检查是否是智谱 AI
  isZhipuAI() {
    return this.config.apiUrl.includes("bigmodel.cn");
  }
  // 转换 tools 格式以兼容不同的 API 提供商
  convertToolsFormat(tools) {
    if (!tools || tools.length === 0) {
      return tools;
    }
    if (this.isZhipuAI()) {
      return tools.map((tool) => {
        if (tool.type === "function" && tool.function) {
          return {
            type: "function",
            name: tool.function.name,
            description: tool.function.description,
            parameters: tool.function.parameters
          };
        }
        return tool;
      });
    }
    return tools;
  }
  async testConnection() {
    console.log("[Anthropic Driver] \u5F00\u59CB\u6D4B\u8BD5\u8FDE\u63A5...");
    const validationError = this.validateConfig();
    if (validationError) {
      return validationError;
    }
    try {
      const response = await (0, import_obsidian4.requestUrl)({
        url: this.buildApiUrl("/messages"),
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": this.config.apiKey,
          "anthropic-version": "2023-06-01"
        },
        body: JSON.stringify({
          model: this.config.modelName,
          max_tokens: 1,
          messages: [
            {
              role: "user",
              content: "Hi"
            }
          ]
        })
      });
      if (response.status === 200) {
        console.log("[Anthropic Driver] \u2713 \u8FDE\u63A5\u6210\u529F");
        return {
          success: true,
          message: `\u2713 Anthropic API \u8FDE\u63A5\u6210\u529F\uFF0C\u6A21\u578B ${this.config.modelName} \u53EF\u7528`
        };
      } else {
        console.error("[Anthropic Driver] \u2717 \u8FD4\u56DE\u9519\u8BEF\u72B6\u6001:", response.status);
        return {
          success: false,
          message: `API \u8FD4\u56DE\u9519\u8BEF\u72B6\u6001: ${response.status}`,
          error: JSON.stringify(response.json)
        };
      }
    } catch (error) {
      return this.handleError(error, "Anthropic");
    }
  }
  async sendMessage(messages, tools) {
    console.log("[Anthropic Driver] \u53D1\u9001\u6D88\u606F\uFF0C\u5386\u53F2\u8BB0\u5F55\u6570:", messages.length);
    const validationError = this.validateConfig();
    if (validationError) {
      return {
        success: false,
        error: validationError.message
      };
    }
    try {
      const buildAnthropicMessages = /* @__PURE__ */ __name((messages2) => {
        return messages2.map((msg) => {
          if (msg.role === "assistant" && msg.toolCalls && msg.toolCalls.length > 0) {
            const contentBlocks = msg.toolCalls.map((tc) => ({
              type: "tool_use",
              id: tc.id,
              name: tc.function.name,
              input: JSON.parse(tc.function.arguments)
            }));
            if (msg.content && typeof msg.content === "string" && msg.content.trim()) {
              contentBlocks.unshift({
                type: "text",
                text: msg.content
              });
            }
            return {
              role: "assistant",
              content: contentBlocks
            };
          }
          if (msg.role === "tool") {
            return {
              role: "user",
              content: [{
                type: "tool_result",
                tool_use_id: msg.toolCallId,
                content: msg.content
              }]
            };
          }
          return {
            role: msg.role === "system" ? "user" : msg.role,
            content: msg.content
          };
        });
      }, "buildAnthropicMessages");
      const requestBody = {
        model: this.config.modelName,
        max_tokens: (this.config.maxOutputTokens || 96) * 1024,
        messages: buildAnthropicMessages(messages)
      };
      if (this.config.systemRules && this.config.systemRules.trim()) {
        requestBody.system = this.config.systemRules;
        console.log("[Anthropic Driver] \u2713 \u5DF2\u6DFB\u52A0 SYSTEM \u89C4\u5219");
      }
      if (tools && tools.length > 0) {
        const convertedTools = this.convertToolsFormat(tools);
        requestBody.tools = convertedTools;
        console.log("[Anthropic Driver] \u2713 \u5DF2\u6DFB\u52A0 Tools\uFF0C\u6570\u91CF:", convertedTools.length);
        if (this.isZhipuAI()) {
          console.log("[Anthropic Driver] \u2713 \u5DF2\u8F6C\u6362\u4E3A\u667A\u8C31 AI \u683C\u5F0F");
        }
      }
      console.log("[Anthropic Driver] >>> \u8BF7\u6C42\u5185\u5BB9:", JSON.stringify(requestBody, null, 2));
      const response = await (0, import_obsidian4.requestUrl)({
        url: this.buildApiUrl("/messages"),
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": this.config.apiKey,
          "anthropic-version": "2023-06-01"
        },
        body: JSON.stringify(requestBody)
      });
      console.log("[Anthropic Driver] <<< \u54CD\u5E94\u72B6\u6001:", response.status);
      if (response.status === 200) {
        const data = response.json;
        console.log("[Anthropic Driver] <<< \u54CD\u5E94\u5185\u5BB9:", JSON.stringify(data, null, 2));
        let textContent = "";
        const toolCalls = [];
        if (data.content && Array.isArray(data.content)) {
          for (const block of data.content) {
            if (block.type === "text") {
              textContent += block.text;
            } else if (block.type === "tool_use") {
              toolCalls.push({
                id: block.id,
                type: "function",
                function: {
                  name: block.name,
                  arguments: JSON.stringify(block.input)
                }
              });
            }
          }
        }
        console.log("[Anthropic Driver] \u2713 \u6536\u5230\u56DE\u590D\uFF0C\u6587\u672C\u957F\u5EA6:", textContent.length, "\u5DE5\u5177\u8C03\u7528\u6570:", toolCalls.length);
        return {
          success: true,
          message: textContent,
          toolCalls: toolCalls.length > 0 ? toolCalls : void 0,
          stopReason: data.stop_reason
        };
      } else {
        console.error("[Anthropic Driver] \u2717 API \u8FD4\u56DE\u9519\u8BEF:", response.status, response.json);
        return {
          success: false,
          error: `API \u8FD4\u56DE\u9519\u8BEF\u72B6\u6001: ${response.status}`
        };
      }
    } catch (error) {
      console.error("[Anthropic Driver] \u2717 \u53D1\u9001\u6D88\u606F\u5931\u8D25:", error);
      return {
        success: false,
        error: error.message || "\u53D1\u9001\u6D88\u606F\u5931\u8D25"
      };
    }
  }
  async sendMessageStream(messages, tools, onChunk) {
    console.log("[Anthropic Driver] \u5F00\u59CB\u6D41\u5F0F\u53D1\u9001\u6D88\u606F");
    console.log("[Anthropic Driver] Note: Obsidian's requestUrl doesn't support streaming directly");
    console.log("[Anthropic Driver] Falling back to non-streaming request");
    const validationError = this.validateConfig();
    if (validationError) {
      return {
        success: false,
        error: validationError.message
      };
    }
    return await this.sendMessage(messages, tools);
  }
  async fetchModelsList() {
    console.log("[Anthropic Driver] \u5F00\u59CB\u83B7\u53D6\u6A21\u578B\u5217\u8868...");
    if (!this.config.apiUrl || !this.config.apiKey) {
      return {
        success: false,
        error: "\u8BF7\u5148\u914D\u7F6E API URL \u548C API Key"
      };
    }
    console.log("[Anthropic Driver] \u2713 \u8FD4\u56DE\u9884\u5B9A\u4E49\u7684 Anthropic \u6A21\u578B\u5217\u8868");
    const models = [
      { id: "claude-opus-4-5-20251101", name: "Claude Opus 4.5", description: "\u6700\u5F3A\u5927\u7684\u6A21\u578B\uFF0C\u9002\u5408\u590D\u6742\u4EFB\u52A1" },
      { id: "claude-sonnet-4.5-20250514", name: "Claude Sonnet 4.5", description: "\u5E73\u8861\u6027\u80FD\u548C\u901F\u5EA6" },
      { id: "claude-sonnet-4-20250514", name: "Claude Sonnet 4", description: "\u9AD8\u6027\u80FD\u6A21\u578B" },
      { id: "claude-3-5-sonnet-20241022", name: "Claude 3.5 Sonnet", description: "\u4E0A\u4E00\u4EE3\u9AD8\u6027\u80FD\u6A21\u578B" },
      { id: "claude-3-5-haiku-20241022", name: "Claude 3.5 Haiku", description: "\u5FEB\u901F\u54CD\u5E94\u6A21\u578B" },
      { id: "claude-3-opus-20240229", name: "Claude 3 Opus", description: "Claude 3 \u7CFB\u5217\u6700\u5F3A\u6A21\u578B" },
      { id: "claude-3-sonnet-20240229", name: "Claude 3 Sonnet", description: "Claude 3 \u7CFB\u5217\u5E73\u8861\u6A21\u578B" },
      { id: "claude-3-haiku-20240307", name: "Claude 3 Haiku", description: "Claude 3 \u7CFB\u5217\u5FEB\u901F\u6A21\u578B" }
    ];
    return {
      success: true,
      models
    };
  }
};
__name(_AnthropicLLMDriver, "AnthropicLLMDriver");
var AnthropicLLMDriver = _AnthropicLLMDriver;

// src/utils/llm/llm_driver_openai.ts
var import_obsidian5 = require("obsidian");
var _OpenAILLMDriver = class _OpenAILLMDriver extends LLMDriverBase {
  constructor(config) {
    super(config);
  }
  async testConnection() {
    console.log("[OpenAI Driver] \u5F00\u59CB\u6D4B\u8BD5\u8FDE\u63A5...");
    const validationError = this.validateConfig();
    if (validationError) {
      return validationError;
    }
    try {
      const response = await (0, import_obsidian5.requestUrl)({
        url: `${this.config.apiUrl}/chat/completions`,
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${this.config.apiKey}`
        },
        body: JSON.stringify({
          model: this.config.modelName,
          max_tokens: 1,
          messages: [
            {
              role: "user",
              content: "Hi"
            }
          ]
        })
      });
      if (response.status === 200) {
        console.log("[OpenAI Driver] \u2713 \u8FDE\u63A5\u6210\u529F");
        return {
          success: true,
          message: `\u2713 OpenAI API \u8FDE\u63A5\u6210\u529F\uFF0C\u6A21\u578B ${this.config.modelName} \u53EF\u7528`
        };
      } else {
        console.error("[OpenAI Driver] \u2717 \u8FD4\u56DE\u9519\u8BEF\u72B6\u6001:", response.status);
        return {
          success: false,
          message: `API \u8FD4\u56DE\u9519\u8BEF\u72B6\u6001: ${response.status}`,
          error: JSON.stringify(response.json)
        };
      }
    } catch (error) {
      return this.handleError(error, "OpenAI");
    }
  }
  async sendMessage(messages, tools) {
    var _a;
    console.log("[OpenAI Driver] \u53D1\u9001\u6D88\u606F\uFF0C\u5386\u53F2\u8BB0\u5F55\u6570:", messages.length);
    const validationError = this.validateConfig();
    if (validationError) {
      return {
        success: false,
        error: validationError.message
      };
    }
    try {
      const apiMessages = [];
      if (this.config.systemRules && this.config.systemRules.trim()) {
        apiMessages.push({
          role: "system",
          content: this.config.systemRules
        });
        console.log("[OpenAI Driver] \u2713 \u5DF2\u6DFB\u52A0 SYSTEM \u89C4\u5219");
      }
      for (const msg of messages) {
        const apiMsg = {
          role: msg.role,
          content: msg.content
        };
        if (msg.role === "assistant" && msg.toolCalls) {
          apiMsg.tool_calls = msg.toolCalls;
        }
        if (msg.role === "tool" && msg.toolCallId) {
          apiMsg.tool_call_id = msg.toolCallId;
          apiMsg.name = msg.toolName;
        }
        apiMessages.push(apiMsg);
      }
      const requestBody = {
        model: this.config.modelName,
        max_tokens: (this.config.maxOutputTokens || 96) * 1024,
        messages: apiMessages
      };
      if (tools && tools.length > 0) {
        requestBody.tools = tools;
        requestBody.tool_choice = "auto";
        console.log("[OpenAI Driver] \u2713 \u5DF2\u6DFB\u52A0 Tools\uFF0C\u6570\u91CF:", tools.length);
      }
      console.log("[OpenAI Driver] >>> \u8BF7\u6C42\u5185\u5BB9:", JSON.stringify(requestBody, null, 2));
      const response = await (0, import_obsidian5.requestUrl)({
        url: `${this.config.apiUrl}/chat/completions`,
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${this.config.apiKey}`
        },
        body: JSON.stringify(requestBody)
      });
      console.log("[OpenAI Driver] <<< \u54CD\u5E94\u72B6\u6001:", response.status);
      if (response.status === 200) {
        const data = response.json;
        console.log("[OpenAI Driver] <<< \u54CD\u5E94\u5185\u5BB9:", JSON.stringify(data, null, 2));
        const message = data.choices[0].message;
        const toolCalls = message.tool_calls;
        console.log("[OpenAI Driver] \u2713 \u6536\u5230\u56DE\u590D\uFF0C\u5185\u5BB9\u957F\u5EA6:", ((_a = message.content) == null ? void 0 : _a.length) || 0, "\u5DE5\u5177\u8C03\u7528\u6570:", (toolCalls == null ? void 0 : toolCalls.length) || 0);
        return {
          success: true,
          message: message.content || "",
          toolCalls,
          stopReason: data.choices[0].finish_reason
        };
      } else {
        console.error("[OpenAI Driver] \u2717 API \u8FD4\u56DE\u9519\u8BEF:", response.status, response.json);
        return {
          success: false,
          error: `API \u8FD4\u56DE\u9519\u8BEF\u72B6\u6001: ${response.status}`
        };
      }
    } catch (error) {
      console.error("[OpenAI Driver] \u2717 \u53D1\u9001\u6D88\u606F\u5931\u8D25:", error);
      return {
        success: false,
        error: error.message || "\u53D1\u9001\u6D88\u606F\u5931\u8D25"
      };
    }
  }
  async sendMessageStream(messages, tools, onChunk) {
    console.log("[OpenAI Driver] \u5F00\u59CB\u6D41\u5F0F\u53D1\u9001\u6D88\u606F");
    const validationError = this.validateConfig();
    if (validationError) {
      return {
        success: false,
        error: validationError.message
      };
    }
    try {
      const apiMessages = [];
      if (this.config.systemRules && this.config.systemRules.trim()) {
        apiMessages.push({
          role: "system",
          content: this.config.systemRules
        });
      }
      for (const msg of messages) {
        const apiMsg = {
          role: msg.role,
          content: msg.content
        };
        if (msg.role === "assistant" && msg.toolCalls) {
          apiMsg.tool_calls = msg.toolCalls;
        }
        if (msg.role === "tool" && msg.toolCallId) {
          apiMsg.tool_call_id = msg.toolCallId;
          apiMsg.name = msg.toolName;
        }
        apiMessages.push(apiMsg);
      }
      const requestBody = {
        model: this.config.modelName,
        max_tokens: (this.config.maxOutputTokens || 96) * 1024,
        stream: true,
        messages: apiMessages
      };
      if (tools && tools.length > 0) {
        requestBody.tools = tools;
        requestBody.tool_choice = "auto";
      }
      console.log("[OpenAI Driver Stream] >>> \u8BF7\u6C42\u5185\u5BB9:", JSON.stringify(requestBody, null, 2));
      return await this.sendMessage(messages, tools);
    } catch (error) {
      console.error("[OpenAI Driver] \u2717 \u6D41\u5F0F\u53D1\u9001\u5931\u8D25:", error);
      return {
        success: false,
        error: error.message || "\u6D41\u5F0F\u53D1\u9001\u5931\u8D25"
      };
    }
  }
  async fetchModelsList() {
    var _a;
    console.log("[OpenAI Driver] \u5F00\u59CB\u83B7\u53D6\u6A21\u578B\u5217\u8868...");
    if (!this.config.apiUrl || !this.config.apiKey) {
      return {
        success: false,
        error: "\u8BF7\u5148\u914D\u7F6E API URL \u548C API Key"
      };
    }
    try {
      const response = await (0, import_obsidian5.requestUrl)({
        url: `${this.config.apiUrl}/models`,
        method: "GET",
        headers: {
          "Authorization": `Bearer ${this.config.apiKey}`
        }
      });
      if (response.status === 200) {
        const data = response.json;
        console.log("[OpenAI Driver] \u2713 \u83B7\u53D6\u6A21\u578B\u5217\u8868\u6210\u529F\uFF0C\u6A21\u578B\u6570\u91CF:", ((_a = data.data) == null ? void 0 : _a.length) || 0);
        const models = (data.data || []).map((model) => ({
          id: model.id,
          name: model.id,
          description: model.owned_by ? `\u7531 ${model.owned_by} \u63D0\u4F9B` : void 0
        }));
        return {
          success: true,
          models
        };
      } else {
        console.error("[OpenAI Driver] \u2717 \u83B7\u53D6\u6A21\u578B\u5217\u8868\u5931\u8D25:", response.status);
        return {
          success: false,
          error: `API \u8FD4\u56DE\u9519\u8BEF\u72B6\u6001: ${response.status}`
        };
      }
    } catch (error) {
      console.error("[OpenAI Driver] \u2717 \u83B7\u53D6\u6A21\u578B\u5217\u8868\u5931\u8D25:", error);
      return {
        success: false,
        error: error.message || "\u83B7\u53D6\u6A21\u578B\u5217\u8868\u5931\u8D25"
      };
    }
  }
};
__name(_OpenAILLMDriver, "OpenAILLMDriver");
var OpenAILLMDriver = _OpenAILLMDriver;

// src/llm_client.ts
var _LLMClient = class _LLMClient {
  constructor(config) {
    __publicField(this, "driver");
    __publicField(this, "abortController", null);
    if (config.apiType === "anthropic") {
      this.driver = new AnthropicLLMDriver({
        apiUrl: config.apiUrl,
        apiKey: config.apiKey,
        modelName: config.modelName,
        systemRules: config.systemRules,
        contextWindow: config.contextWindow,
        maxOutputTokens: config.maxOutputTokens
      });
    } else {
      this.driver = new OpenAILLMDriver({
        apiUrl: config.apiUrl,
        apiKey: config.apiKey,
        modelName: config.modelName,
        systemRules: config.systemRules,
        contextWindow: config.contextWindow,
        maxOutputTokens: config.maxOutputTokens
      });
    }
  }
  async testConnection() {
    console.log("[LLM Client] \u5F00\u59CB\u6D4B\u8BD5 LLM \u8FDE\u63A5...");
    return await this.driver.testConnection();
  }
  async sendMessage(messages, tools) {
    console.log("[LLM Client] \u53D1\u9001\u804A\u5929\u6D88\u606F\uFF0CTools \u6570\u91CF:", (tools == null ? void 0 : tools.length) || 0);
    return await this.driver.sendMessage(messages, tools);
  }
  async sendMessageStream(messages, tools, onChunk) {
    console.log("[LLM Client] \u6D41\u5F0F\u53D1\u9001\u804A\u5929\u6D88\u606F\uFF0CTools \u6570\u91CF:", (tools == null ? void 0 : tools.length) || 0);
    return await this.driver.sendMessageStream(messages, tools, onChunk);
  }
  /**
   * 设置 AbortController
   */
  setAbortController(controller) {
    this.abortController = controller;
    console.log("[LLM Client] AbortController \u5DF2", controller ? "\u8BBE\u7F6E" : "\u6E05\u7A7A");
  }
  /**
   * 获取当前的中止信号
   */
  getAbortSignal() {
    var _a;
    return ((_a = this.abortController) == null ? void 0 : _a.signal) || null;
  }
  /**
   * 中止当前请求
   */
  abort() {
    if (this.abortController) {
      this.abortController.abort();
      console.log("[LLM Client] \u2713 \u8BF7\u6C42\u5DF2\u4E2D\u6B62");
    }
  }
  /**
   * 获取模型列表
   */
  async fetchModelsList() {
    console.log("[LLM Client] \u83B7\u53D6\u6A21\u578B\u5217\u8868...");
    return await this.driver.fetchModelsList();
  }
};
__name(_LLMClient, "LLMClient");
var LLMClient = _LLMClient;

// src/utils/pages/settings_models.ts
var _SettingsModelsManager = class _SettingsModelsManager {
  constructor() {
    this.availableModels = [];
    this.modelsFetchSuccess = false;
  }
  /**
   * 获取可用模型列表
   */
  getAvailableModels() {
    return this.availableModels;
  }
  /**
   * 获取模型列表获取是否成功
   */
  getModelsFetchSuccess() {
    return this.modelsFetchSuccess;
  }
  /**
   * 当 URL、Key 和接口类型都配置完成时，尝试拉取模型列表
   */
  async fetchModelsListIfReady(settings) {
    if (!settings.llmApiUrl || !settings.llmApiKey || !settings.llmApiType) {
      console.log("[Settings Models] \u914D\u7F6E\u4E0D\u5B8C\u6574\uFF0C\u8DF3\u8FC7\u62C9\u53D6\u6A21\u578B\u5217\u8868");
      this.availableModels = [];
      this.modelsFetchSuccess = false;
      return false;
    }
    console.log("[Settings Models] \u5F00\u59CB\u62C9\u53D6\u6A21\u578B\u5217\u8868...");
    try {
      const llmClient = new LLMClient({
        apiUrl: settings.llmApiUrl,
        apiKey: settings.llmApiKey,
        modelName: settings.llmModelName || "temp",
        apiType: settings.llmApiType,
        systemRules: settings.llmSystemRules,
        contextWindow: settings.llmContextWindow,
        maxOutputTokens: settings.llmMaxOutputTokens
      });
      const result = await llmClient.fetchModelsList();
      if (result.success && result.models && result.models.length > 0) {
        console.log("[Settings Models] \u2713 \u6210\u529F\u62C9\u53D6\u6A21\u578B\u5217\u8868\uFF0C\u6A21\u578B\u6570\u91CF:", result.models.length);
        this.availableModels = result.models.map((m) => m.id);
        this.modelsFetchSuccess = true;
        return true;
      } else {
        console.log("[Settings Models] \u2717 \u62C9\u53D6\u6A21\u578B\u5217\u8868\u5931\u8D25:", result.error);
        this.availableModels = [];
        this.modelsFetchSuccess = false;
        return false;
      }
    } catch (error) {
      console.error("[Settings Models] \u2717 \u62C9\u53D6\u6A21\u578B\u5217\u8868\u5F02\u5E38:", error);
      this.availableModels = [];
      this.modelsFetchSuccess = false;
      return false;
    }
  }
};
__name(_SettingsModelsManager, "SettingsModelsManager");
var SettingsModelsManager = _SettingsModelsManager;

// src/utils/settings/configuration_tester.ts
var _ConfigurationTester = class _ConfigurationTester {
  constructor(app) {
    __publicField(this, "app");
    __publicField(this, "apiClient", null);
    this.app = app;
  }
  setApiClient(apiClient) {
    this.apiClient = apiClient;
  }
  async testAllConfigurations(settings) {
    const results = {};
    if (settings.mcpApiUrl) {
      results.mcpTest = await this.testMcpConnection(settings);
    }
    if (settings.llmApiUrl && settings.llmApiKey && settings.llmModelName) {
      results.llmTest = await this.testLlmConnection(settings);
    }
    return results;
  }
  async testMcpConnection(settings) {
    console.log("[Config Tester] \u6D4B\u8BD5 MCP \u670D\u52A1\u5668\u8FDE\u63A5...");
    try {
      if (this.apiClient) {
        await this.apiClient.disconnect();
      }
      this.apiClient = new APIClient(this.app);
      await this.apiClient.connect({
        apiUrl: settings.mcpApiUrl,
        apiKey: settings.mcpApiKey
      });
      const endpoints = this.apiClient.getEndpoints();
      console.log("[Config Tester] \u2713 MCP \u670D\u52A1\u5668\u8FDE\u63A5\u6210\u529F");
      return {
        success: true,
        message: `\u2713 MCP \u670D\u52A1\u5668\u8FDE\u63A5\u6210\u529F\uFF0C\u627E\u5230 ${endpoints.length} \u4E2A API \u7AEF\u70B9`
      };
    } catch (error) {
      console.error("[Config Tester] \u2717 MCP \u670D\u52A1\u5668\u8FDE\u63A5\u5931\u8D25:", error);
      return {
        success: false,
        message: `\u2717 MCP \u670D\u52A1\u5668\u8FDE\u63A5\u5931\u8D25: ${error.message}`
      };
    }
  }
  async testLlmConnection(settings) {
    console.log("[Config Tester] \u6D4B\u8BD5 LLM API \u8FDE\u63A5...");
    try {
      const llmClient = new LLMClient({
        apiUrl: settings.llmApiUrl,
        apiKey: settings.llmApiKey,
        modelName: settings.llmModelName,
        apiType: settings.llmApiType,
        systemRules: settings.llmSystemRules,
        contextWindow: settings.llmContextWindow,
        maxOutputTokens: settings.llmMaxOutputTokens
      });
      const result = await llmClient.testConnection();
      console.log("[Config Tester] LLM \u6D4B\u8BD5\u7ED3\u679C:", result);
      return result;
    } catch (error) {
      console.error("[Config Tester] \u2717 LLM API \u6D4B\u8BD5\u5931\u8D25:", error);
      return {
        success: false,
        message: `\u2717 LLM API \u6D4B\u8BD5\u5931\u8D25: ${error.message}`,
        error: error.message
      };
    }
  }
  getApiClient() {
    return this.apiClient;
  }
};
__name(_ConfigurationTester, "ConfigurationTester");
var ConfigurationTester = _ConfigurationTester;

// src/utils/settings/test_results_displayer.ts
var _TestResultsDisplayer = class _TestResultsDisplayer {
  displayTestResults(containerEl, results) {
    var _a;
    let resultsEl = containerEl.querySelector(".config-test-results");
    if (!resultsEl) {
      const saveButtonSeparator = containerEl.querySelector("hr:last-of-type");
      if (saveButtonSeparator && saveButtonSeparator.previousElementSibling) {
        resultsEl = containerEl.createEl("div", {
          cls: "config-test-results"
        });
        resultsEl.style.marginTop = "15px";
        resultsEl.style.padding = "15px";
        resultsEl.style.border = "1px solid var(--background-modifier-border)";
        resultsEl.style.borderRadius = "4px";
        resultsEl.style.backgroundColor = "var(--background-secondary)";
        (_a = saveButtonSeparator.parentElement) == null ? void 0 : _a.insertBefore(resultsEl, saveButtonSeparator);
      }
    }
    if (!resultsEl) {
      console.error("[Test Results Displayer] \u65E0\u6CD5\u521B\u5EFA\u6D4B\u8BD5\u7ED3\u679C\u663E\u793A\u533A\u57DF");
      return;
    }
    resultsEl.empty();
    resultsEl.createEl("h4", { text: "\u914D\u7F6E\u6D4B\u8BD5\u7ED3\u679C" });
    if (results.mcpTest) {
      this.displayMcpTestResult(resultsEl, results.mcpTest);
    }
    if (results.llmTest) {
      this.displayLlmTestResult(resultsEl, results.llmTest);
    }
    if (!results.mcpTest && !results.llmTest) {
      const noConfigEl = resultsEl.createEl("div");
      noConfigEl.style.marginTop = "10px";
      noConfigEl.style.fontSize = "13px";
      noConfigEl.style.opacity = "0.7";
      noConfigEl.textContent = "\u672A\u914D\u7F6E\u4EFB\u4F55\u670D\u52A1\uFF0C\u65E0\u9700\u6D4B\u8BD5";
    }
  }
  displayMcpTestResult(containerEl, result) {
    const mcpResultEl = containerEl.createEl("div");
    mcpResultEl.style.marginTop = "10px";
    mcpResultEl.style.padding = "8px";
    mcpResultEl.style.borderRadius = "4px";
    mcpResultEl.style.backgroundColor = result.success ? "var(--background-modifier-success)" : "var(--background-modifier-error)";
    const mcpTitle = mcpResultEl.createEl("div");
    mcpTitle.style.fontWeight = "bold";
    mcpTitle.style.marginBottom = "4px";
    mcpTitle.textContent = "MCP \u670D\u52A1\u5668";
    const mcpMessage = mcpResultEl.createEl("div");
    mcpMessage.style.fontSize = "13px";
    mcpMessage.textContent = result.message;
  }
  displayLlmTestResult(containerEl, result) {
    const llmResultEl = containerEl.createEl("div");
    llmResultEl.style.marginTop = "10px";
    llmResultEl.style.padding = "8px";
    llmResultEl.style.borderRadius = "4px";
    llmResultEl.style.backgroundColor = result.success ? "var(--background-modifier-success)" : "var(--background-modifier-error)";
    const llmTitle = llmResultEl.createEl("div");
    llmTitle.style.fontWeight = "bold";
    llmTitle.style.marginBottom = "4px";
    llmTitle.textContent = "LLM API";
    const llmMessage = llmResultEl.createEl("div");
    llmMessage.style.fontSize = "13px";
    llmMessage.textContent = result.message;
    if (!result.success && result.error) {
      const llmError = llmResultEl.createEl("div");
      llmError.style.fontSize = "12px";
      llmError.style.marginTop = "4px";
      llmError.style.opacity = "0.8";
      llmError.textContent = `\u8BE6\u7EC6\u9519\u8BEF: ${result.error}`;
    }
  }
};
__name(_TestResultsDisplayer, "TestResultsDisplayer");
var TestResultsDisplayer = _TestResultsDisplayer;

// src/utils/pages/settings_ui_builder.ts
var import_obsidian7 = require("obsidian");
var _SettingsUIBuilder = class _SettingsUIBuilder {
  constructor(containerEl, plugin, connectionManager, modelsManager) {
    this.containerEl = containerEl;
    this.plugin = plugin;
    this.connectionManager = connectionManager;
    this.modelsManager = modelsManager;
    this.configTester = new ConfigurationTester(plugin.app);
    this.resultsDisplayer = new TestResultsDisplayer();
  }
  /**
   * 构建完整的设置界面
   */
  build() {
    this.buildHeader();
    this.buildSyncFolderSetting();
    this.buildAutoSyncSection();
    this.buildSeparator();
    this.buildMemoryServerSection();
    this.buildSeparator();
    this.buildLLMAPISection();
    this.buildSeparator();
    this.buildSearchToolsSection();
    this.buildSeparator();
    this.buildSaveButton();
    this.buildSeparator();
    this.buildOpenAPISection();
  }
  /**
   * 标题
   */
  buildHeader() {
    this.containerEl.createEl("h2", { text: "Memory Graph \u63D2\u4EF6\u8BBE\u7F6E" });
  }
  /**
   * 同步目标目录
   */
  buildSyncFolderSetting() {
    const rootFolders = this.plugin.app.vault.getRoot().children.filter((item) => item instanceof import_obsidian7.TFolder).map((folder) => folder.name).sort();
    new import_obsidian7.Setting(this.containerEl).setName("\u540C\u6B65\u76EE\u6807\u76EE\u5F55").setDesc("\u9009\u62E9\u8981\u540C\u6B65\u7684\u76EE\u6807\u76EE\u5F55").addDropdown((dropdown) => {
      dropdown.addOption("", "-\u8BF7\u9009\u62E9-");
      rootFolders.forEach((folder) => {
        dropdown.addOption(folder, folder);
      });
      dropdown.setValue(this.plugin.settings.syncTargetFolder || "");
      dropdown.onChange(async (value) => {
        this.plugin.settings.syncTargetFolder = value;
        await this.plugin.saveSettings();
      });
    });
  }
  /**
   * 自动同步设置
   */
  buildAutoSyncSection() {
    this.containerEl.createEl("h3", { text: "\u81EA\u52A8\u540C\u6B65\u8BBE\u7F6E" });
    new import_obsidian7.Setting(this.containerEl).setName("\u81EA\u52A8\u66F4\u65B0\u89C2\u5BDF\u8BB0\u5F55").setDesc("\u542F\u7528\u540E\uFF0C\u4FEE\u6539\u89C2\u5BDF\u6587\u4EF6\u5C06\u81EA\u52A8\u540C\u6B65\u5230\u670D\u52A1\u5668").addToggle((toggle) => {
      toggle.setValue(this.plugin.settings.autoSyncObservations || false);
      toggle.onChange(async (value) => {
        this.plugin.settings.autoSyncObservations = value;
        if (this.plugin.fileWatcher) {
          this.plugin.fileWatcher.setEnabled(value);
        }
        await this.plugin.saveSettings();
      });
    });
    new import_obsidian7.Setting(this.containerEl).setName("\u624B\u52A8\u89E6\u53D1\u540C\u6B65").setDesc("\u7ACB\u5373\u68C0\u67E5\u6240\u6709\u89C2\u5BDF\u6587\u4EF6\u5E76\u540C\u6B65\u5230\u670D\u52A1\u5668").addButton((button) => {
      button.setButtonText("\u7ACB\u5373\u540C\u6B65");
      button.setClass("mod-cta");
      button.onClick(() => {
        this.handleManualSync();
      });
    });
  }
  /**
   * 手动触发同步
   */
  handleManualSync() {
    console.log("[Settings] \u624B\u52A8\u89E6\u53D1\u540C\u6B65");
  }
  /**
   * 分隔线
   */
  buildSeparator() {
    const separatorEl = this.containerEl.createEl("hr");
    separatorEl.style.marginTop = "20px";
    separatorEl.style.marginBottom = "20px";
  }
  /**
   * MCP 服务器配置区域
   */
  buildMemoryServerSection() {
    this.containerEl.createEl("h3", { text: "Mem \u670D\u52A1\u5668\u914D\u7F6E" });
    new import_obsidian7.Setting(this.containerEl).setName("Mem \u670D\u52A1\u5668API \u5730\u5740\uFF08OpenAPi\uFF09").setDesc("\u8F93\u5165 Mem \u670D\u52A1\u5668\u7684 OpenAPi \u5730\u5740\uFF08\u5B8C\u6574 URL\uFF0C\u4F8B\u5982: https://url/openapi.json\uFF09").addText((text) => {
      text.setValue(this.plugin.settings.mcpApiUrl || "");
      text.onChange(async (value) => {
        this.plugin.settings.mcpApiUrl = value;
        await this.plugin.saveSettings();
      });
    });
    new import_obsidian7.Setting(this.containerEl).setName("\u670D\u52A1\u5668 API Key").setDesc("\u8F93\u5165 Mem \u670D\u52A1\u5668\u7684 API \u5BC6\u94A5\uFF08\u53EF\u9009\uFF09").addText((text) => {
      text.setValue(this.plugin.settings.mcpApiKey || "");
      text.onChange(async (value) => {
        this.plugin.settings.mcpApiKey = value;
        await this.plugin.saveSettings();
      });
    });
    new import_obsidian7.Setting(this.containerEl).setName("\u6D4B\u8BD5\u8FDE\u63A5").setDesc("\u70B9\u51FB\u6309\u94AE\u6D4B\u8BD5\u4E0E Mem \u670D\u52A1\u5668\u7684\u8FDE\u63A5").addButton((button) => {
      button.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5");
      button.setCta();
      button.onClick(async () => {
        button.setDisabled(true);
        button.setButtonText("\u8FDE\u63A5\u4E2D...");
        try {
          await this.handleTestConnection();
        } finally {
          button.setDisabled(false);
          button.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5");
        }
      });
    });
  }
  /**
   * LLM API 配置区域
   */
  buildLLMAPISection() {
    this.containerEl.createEl("h3", { text: "LLM API \u914D\u7F6E" });
    new import_obsidian7.Setting(this.containerEl).setName("LLM API URL").setDesc("\u8F93\u5165 LLM \u670D\u52A1\u7684 API \u5730\u5740\uFF08\u4F8B\u5982: https://api.anthropic.com/v1 \u6216 https://api.openai.com/v1\uFF09").addText((text) => {
      text.setValue(this.plugin.settings.llmApiUrl || "");
      text.onChange(async (value) => {
        this.plugin.settings.llmApiUrl = value;
        await this.plugin.saveSettings();
        await this.modelsManager.fetchModelsListIfReady(this.plugin.settings);
      });
    });
    new import_obsidian7.Setting(this.containerEl).setName("LLM API Key").setDesc("\u8F93\u5165 LLM \u670D\u52A1\u7684 API \u5BC6\u94A5").addText((text) => {
      text.setValue(this.plugin.settings.llmApiKey || "");
      text.setPlaceholder("sk-...");
      text.inputEl.type = "password";
      text.onChange(async (value) => {
        this.plugin.settings.llmApiKey = value;
        await this.plugin.saveSettings();
        await this.modelsManager.fetchModelsListIfReady(this.plugin.settings);
      });
    });
    new import_obsidian7.Setting(this.containerEl).setName("\u5237\u65B0\u6A21\u578B\u5217\u8868").setDesc("\u4ECE LLM API \u83B7\u53D6\u6700\u65B0\u7684\u53EF\u7528\u6A21\u578B\u5217\u8868").addButton((button) => {
      button.setButtonText("\u5237\u65B0\u6A21\u578B\u5217\u8868");
      button.onClick(async () => {
        button.setDisabled(true);
        button.setButtonText("\u5237\u65B0\u4E2D...");
        try {
          await this.modelsManager.fetchModelsListIfReady(this.plugin.settings);
          button.setButtonText("\u2713 \u5237\u65B0\u6210\u529F");
          setTimeout(() => {
            button.setButtonText("\u5237\u65B0\u6A21\u578B\u5217\u8868");
            button.setDisabled(false);
          }, 2e3);
        } catch (error) {
          console.error("[Settings] \u5237\u65B0\u6A21\u578B\u5217\u8868\u5931\u8D25:", error);
          button.setButtonText("\u2717 \u5237\u65B0\u5931\u8D25");
          setTimeout(() => {
            button.setButtonText("\u5237\u65B0\u6A21\u578B\u5217\u8868");
            button.setDisabled(false);
          }, 2e3);
        }
      });
    });
    this.buildModelNameSetting();
    new import_obsidian7.Setting(this.containerEl).setName("\u4E0A\u4E0B\u6587\u7A97\u53E3").setDesc("\u8BBE\u7F6E\u6A21\u578B\u7684\u4E0A\u4E0B\u6587\u7A97\u53E3\u5927\u5C0F\uFF08\u5355\u4F4D\uFF1AK tokens\uFF0C\u4F8B\u5982 128 \u8868\u793A 128K\uFF09").addText((text) => {
      text.setValue(String(this.plugin.settings.llmContextWindow || 128));
      text.setPlaceholder("128");
      text.inputEl.type = "number";
      text.onChange(async (value) => {
        const numValue = parseInt(value) || 128;
        this.plugin.settings.llmContextWindow = numValue;
        await this.plugin.saveSettings();
      });
    });
    new import_obsidian7.Setting(this.containerEl).setName("\u6700\u5927\u8F93\u51FA Tokens").setDesc("\u8BBE\u7F6E\u6A21\u578B\u7684\u6700\u5927\u8F93\u51FA token \u6570\u91CF\uFF08\u5355\u4F4D\uFF1AK tokens\uFF0C\u4F8B\u5982 96 \u8868\u793A 96K\uFF09").addText((text) => {
      text.setValue(String(this.plugin.settings.llmMaxOutputTokens || 96));
      text.setPlaceholder("96");
      text.inputEl.type = "number";
      text.onChange(async (value) => {
        const numValue = parseInt(value) || 96;
        this.plugin.settings.llmMaxOutputTokens = numValue;
        await this.plugin.saveSettings();
      });
    });
    new import_obsidian7.Setting(this.containerEl).setName("\u63A5\u53E3\u7C7B\u578B").setDesc("\u9009\u62E9 LLM API \u7684\u63A5\u53E3\u7C7B\u578B").addDropdown((dropdown) => {
      dropdown.addOption("anthropic", "Anthropic");
      dropdown.addOption("openai", "\u7ECF\u5178 OpenAI");
      dropdown.setValue(this.plugin.settings.llmApiType || "anthropic");
      dropdown.onChange(async (value) => {
        this.plugin.settings.llmApiType = value;
        await this.plugin.saveSettings();
        await this.modelsManager.fetchModelsListIfReady(this.plugin.settings);
      });
    });
    new import_obsidian7.Setting(this.containerEl).setName("SYSTEM \u89C4\u5219").setDesc("\u8F93\u5165 LLM \u7684\u7CFB\u7EDF\u63D0\u793A\u8BCD\u89C4\u5219\uFF08\u652F\u6301\u591A\u884C\uFF09").addTextArea((text) => {
      text.setValue(this.plugin.settings.llmSystemRules || "");
      text.setPlaceholder("\u8BF7\u8F93\u5165\u7CFB\u7EDF\u89C4\u5219...");
      text.inputEl.rows = 10;
      text.inputEl.cols = 50;
      text.onChange(async (value) => {
        this.plugin.settings.llmSystemRules = value;
        await this.plugin.saveSettings();
        this.reinitLLMClient();
      });
    });
  }
  /**
   * 构建模型名称设置（动态下拉框或文本输入）
   */
  buildModelNameSetting() {
    const modelSetting = new import_obsidian7.Setting(this.containerEl).setName("\u6A21\u578B\u540D\u79F0").setDesc(this.modelsManager.getModelsFetchSuccess() ? "\u4ECE\u4E0B\u62C9\u5217\u8868\u4E2D\u9009\u62E9\u6A21\u578B" : "\u8F93\u5165\u8981\u4F7F\u7528\u7684\u6A21\u578B\u540D\u79F0\uFF08\u4F8B\u5982: claude-3-5-sonnet-20241022 \u6216 gpt-4\uFF09");
    if (this.modelsManager.getModelsFetchSuccess() && this.modelsManager.getAvailableModels().length > 0) {
      modelSetting.addDropdown((dropdown) => {
        const currentModel = this.plugin.settings.llmModelName || "";
        if (currentModel && !this.modelsManager.getAvailableModels().includes(currentModel)) {
          dropdown.addOption(currentModel, currentModel);
        }
        this.modelsManager.getAvailableModels().forEach((model) => {
          dropdown.addOption(model, model);
        });
        dropdown.setValue(currentModel);
        dropdown.onChange(async (value) => {
          this.plugin.settings.llmModelName = value;
          await this.plugin.saveSettings();
        });
      });
    } else {
      modelSetting.addText((text) => {
        text.setValue(this.plugin.settings.llmModelName || "");
        text.onChange(async (value) => {
          this.plugin.settings.llmModelName = value;
          await this.plugin.saveSettings();
        });
      });
    }
  }
  /**
   * 搜索工具配置区域
   */
  buildSearchToolsSection() {
    this.containerEl.createEl("h3", { text: "\u641C\u7D22\u5DE5\u5177\u914D\u7F6E" });
    new import_obsidian7.Setting(this.containerEl).setName("\u9ED8\u8BA4\u5F00\u542F\u641C\u7D22").setDesc("AI \u804A\u5929\u65F6\u662F\u5426\u9ED8\u8BA4\u542F\u7528\u8054\u7F51\u641C\u7D22\u529F\u80FD").addToggle((toggle) => {
      toggle.setValue(this.plugin.settings.searchDefaultEnabled || false);
      toggle.onChange(async (value) => {
        this.plugin.settings.searchDefaultEnabled = value;
        await this.plugin.saveSettings();
      });
    });
    new import_obsidian7.Setting(this.containerEl).setName("Whoogle URL").setDesc("\u8F93\u5165 Whoogle \u641C\u7D22\u670D\u52A1\u7684 URL\uFF08\u4F8B\u5982: https://search.example.com\uFF09").addText((text) => {
      text.setValue(this.plugin.settings.searchWhoogleUrl || "");
      text.setPlaceholder("https://search.example.com");
      text.onChange(async (value) => {
        this.plugin.settings.searchWhoogleUrl = value;
        await this.plugin.saveSettings();
      });
    });
    new import_obsidian7.Setting(this.containerEl).setName("\u542F\u7528\u8EAB\u4EFD\u9A8C\u8BC1").setDesc("\u662F\u5426\u5728\u8BF7\u6C42\u5934\u4E2D\u6DFB\u52A0 Authorization Bearer Token").addToggle((toggle) => {
      toggle.setValue(this.plugin.settings.searchAuthEnabled || false);
      toggle.onChange(async (value) => {
        this.plugin.settings.searchAuthEnabled = value;
        await this.plugin.saveSettings();
        this.build();
      });
    });
    if (this.plugin.settings.searchAuthEnabled) {
      new import_obsidian7.Setting(this.containerEl).setName("\u9A8C\u8BC1 Key").setDesc("\u8F93\u5165 Bearer Token \u9A8C\u8BC1\u5BC6\u94A5").addText((text) => {
        text.setValue(this.plugin.settings.searchAuthKey || "");
        text.setPlaceholder("your-bearer-token");
        text.inputEl.type = "password";
        text.onChange(async (value) => {
          this.plugin.settings.searchAuthKey = value;
          await this.plugin.saveSettings();
        });
      });
    }
  }
  /**
   * 保存配置按钮
   */
  buildSaveButton() {
    new import_obsidian7.Setting(this.containerEl).setName("\u4FDD\u5B58\u914D\u7F6E").setDesc("\u4FDD\u5B58\u6240\u6709\u914D\u7F6E\u66F4\u6539\u5E76\u6D4B\u8BD5\u8FDE\u63A5").addButton((button) => {
      button.setButtonText("\u4FDD\u5B58\u914D\u7F6E");
      button.setCta();
      button.onClick(async () => {
        button.setDisabled(true);
        button.setButtonText("\u4FDD\u5B58\u4E2D...");
        try {
          await this.plugin.saveSettings();
          console.log("[Settings] \u2713 \u914D\u7F6E\u5DF2\u4FDD\u5B58");
          button.setButtonText("\u6D4B\u8BD5\u914D\u7F6E\u4E2D...");
          this.configTester.setApiClient(this.connectionManager.getApiClient());
          const testResults = await this.configTester.testAllConfigurations(this.plugin.settings);
          this.connectionManager.setApiClient(this.configTester.getApiClient());
          this.resultsDisplayer.displayTestResults(this.containerEl, testResults);
          button.setButtonText("\u2713 \u5DF2\u4FDD\u5B58");
          setTimeout(() => {
            button.setButtonText("\u4FDD\u5B58\u914D\u7F6E");
            button.setDisabled(false);
          }, 2e3);
        } catch (error) {
          console.error("[Settings] \u4FDD\u5B58\u914D\u7F6E\u5931\u8D25:", error);
          button.setButtonText("\u2717 \u4FDD\u5B58\u5931\u8D25");
          setTimeout(() => {
            button.setButtonText("\u4FDD\u5B58\u914D\u7F6E");
            button.setDisabled(false);
          }, 2e3);
        }
      });
    });
  }
  /**
   * OpenAPI 接口列表展示区域
   */
  buildOpenAPISection() {
    const toolsContainerEl = this.containerEl.createEl("div");
    toolsContainerEl.createEl("h3", { text: "OpenApi \u63A5\u53E3\u5217\u8868" });
    const toolsListEl = this.containerEl.createEl("div", {
      cls: "setting-item-description mcp-tools-list"
    });
    toolsListEl.style.marginTop = "10px";
    toolsListEl.style.minHeight = "50px";
    toolsListEl.style.padding = "10px";
    toolsListEl.style.border = "1px solid var(--background-modifier-border)";
    toolsListEl.style.borderRadius = "4px";
    toolsListEl.style.backgroundColor = "var(--background-secondary)";
    toolsListEl.textContent = '\u70B9\u51FB"\u6D4B\u8BD5\u8FDE\u63A5"\u540E\u5C06\u663E\u793A API \u63A5\u53E3\u5217\u8868';
  }
  /**
   * 处理测试连接
   */
  async handleTestConnection() {
    const toolsListElements = this.containerEl.querySelectorAll(".mcp-tools-list");
    if (toolsListElements.length === 0) {
      console.error("[Settings UI] \u672A\u627E\u5230\u663E\u793A\u5143\u7D20");
      return;
    }
    const toolsListEl = toolsListElements[0];
    toolsListEl.empty();
    toolsListEl.textContent = "\u6B63\u5728\u8FDE\u63A5 Memory Server...";
    const result = await this.connectionManager.testConnection(this.plugin.settings);
    if (!result.success) {
      toolsListEl.empty();
      const errorEl = toolsListEl.createEl("div");
      errorEl.style.color = "var(--text-error)";
      if (result.error === "\u8BF7\u5148\u914D\u7F6E API \u5730\u5740") {
        errorEl.textContent = result.error;
      } else {
        errorEl.innerHTML = `
					<strong>\u8FDE\u63A5\u5931\u8D25</strong><br/>
					\u9519\u8BEF\u4FE1\u606F\uFF1A${result.error}<br/><br/>
					\u8BF7\u68C0\u67E5\uFF1A<br/>
					1. API \u5730\u5740\u662F\u5426\u6B63\u786E\uFF08\u5E94\u8BE5\u662F OpenAPI JSON \u6587\u4EF6\u7684 URL\uFF09<br/>
					2. API Key \u662F\u5426\u6709\u6548\uFF08\u5982\u679C\u9700\u8981\uFF09<br/>
					3. Memory Server \u662F\u5426\u6B63\u5E38\u8FD0\u884C<br/>
				`;
      }
      return;
    }
    const { endpoints } = result;
    toolsListEl.empty();
    if (endpoints.length === 0) {
      toolsListEl.textContent = "\u672A\u627E\u5230\u4EFB\u4F55 API \u7AEF\u70B9";
      return;
    }
    toolsListEl.createEl("div", {
      text: `\u5171\u627E\u5230 ${endpoints.length} \u4E2A API \u7AEF\u70B9\uFF1A`,
      cls: "setting-item-description"
    }).style.marginBottom = "10px";
    const groupedEndpoints = this.connectionManager.groupEndpointsByTag(endpoints);
    for (const [tag, tagEndpoints] of Object.entries(groupedEndpoints)) {
      const tagHeader = toolsListEl.createEl("div");
      tagHeader.style.marginTop = "15px";
      tagHeader.style.marginBottom = "8px";
      tagHeader.createEl("strong", { text: tag });
      tagEndpoints.forEach((endpoint) => {
        const endpointItem = toolsListEl.createEl("div");
        endpointItem.style.marginBottom = "8px";
        endpointItem.style.padding = "8px";
        endpointItem.style.backgroundColor = "var(--background-primary)";
        endpointItem.style.borderRadius = "4px";
        endpointItem.style.border = "1px solid var(--background-modifier-border)";
        const methodPath = endpointItem.createEl("div");
        const methodSpan = methodPath.createEl("span");
        methodSpan.style.fontWeight = "bold";
        methodSpan.style.color = this.connectionManager.getMethodColor(endpoint.method);
        methodSpan.textContent = endpoint.method;
        methodPath.appendText(" " + endpoint.path);
        if (endpoint.summary) {
          const summary = endpointItem.createEl("div", {
            cls: "setting-item-description"
          });
          summary.style.marginTop = "4px";
          summary.textContent = endpoint.summary;
        }
        if (endpoint.description && endpoint.description !== endpoint.summary) {
          const descToggle = endpointItem.createEl("details");
          descToggle.style.marginTop = "4px";
          const descSummary = descToggle.createEl("summary", {
            text: "\u67E5\u770B\u8BE6\u7EC6\u8BF4\u660E",
            cls: "setting-item-description"
          });
          descSummary.style.cursor = "pointer";
          descSummary.style.fontSize = "12px";
          const descContent = descToggle.createEl("div", {
            cls: "setting-item-description"
          });
          descContent.style.marginTop = "4px";
          descContent.style.fontSize = "12px";
          descContent.style.whiteSpace = "pre-wrap";
          descContent.textContent = endpoint.description;
        }
      });
    }
  }
  /**
   * 重新初始化LLM客户端（当system规则等配置更新时）
   */
  reinitLLMClient() {
    try {
      const leaves = this.plugin.app.workspace.getLeavesOfType("memory-search-view");
      if (leaves.length > 0) {
        const searchView = leaves[0].view;
        if (searchView && typeof searchView.reinitLLMClient === "function") {
          searchView.reinitLLMClient();
          console.log("[Settings UI] \u2713 LLM\u5BA2\u6237\u7AEF\u5DF2\u91CD\u65B0\u521D\u59CB\u5316");
        }
      }
    } catch (error) {
      console.error("[Settings UI] \u91CD\u65B0\u521D\u59CB\u5316LLM\u5BA2\u6237\u7AEF\u5931\u8D25:", error);
    }
  }
};
__name(_SettingsUIBuilder, "SettingsUIBuilder");
var SettingsUIBuilder = _SettingsUIBuilder;

// src/utils/pages/settings.ts
var import_obsidian8 = require("obsidian");
var _MemoryGraphSettingTab = class _MemoryGraphSettingTab extends import_obsidian8.PluginSettingTab {
  constructor(app, plugin) {
    super(app, plugin);
    __publicField(this, "plugin");
    __publicField(this, "connectionManager");
    __publicField(this, "modelsManager");
    this.plugin = plugin;
    this.connectionManager = new SettingsConnectionManager(app);
    this.modelsManager = new SettingsModelsManager();
  }
  display() {
    const { containerEl } = this;
    containerEl.empty();
    const uiBuilder = new SettingsUIBuilder(
      containerEl,
      this.plugin,
      this.connectionManager,
      this.modelsManager
    );
    uiBuilder.build();
  }
  /**
   * 获取连接管理器（供外部使用）
   */
  getConnectionManager() {
    return this.connectionManager;
  }
};
__name(_MemoryGraphSettingTab, "MemoryGraphSettingTab");
var MemoryGraphSettingTab = _MemoryGraphSettingTab;

// src/settings.ts
var DEFAULT_SETTINGS = {
  syncTargetFolder: "",
  mcpApiUrl: "",
  mcpApiKey: "",
  llmApiUrl: "",
  llmApiKey: "",
  llmModelName: "",
  llmContextWindow: 128,
  llmMaxOutputTokens: 96,
  llmApiType: "anthropic",
  llmSystemRules: "",
  searchWhoogleUrl: "",
  searchAuthEnabled: false,
  searchAuthKey: "",
  searchDefaultEnabled: false,
  autoSyncObservations: false
  // 默认关闭自动同步
};

// src/utils/tools/tool_executor_base.ts
var _ToolExecutorBase = class _ToolExecutorBase {
  constructor() {
    this.whoogleClient = null;
    this.updateTitleCallback = null;
    this.readDocCallback = null;
    this.apiClient = null;
    this.globalSearchCallback = null;
    this.openFileCallback = null;
  }
  /**
   * 设置 Whoogle 客户端
   */
  setWhoogleClient(client) {
    this.whoogleClient = client;
    console.log("[Tool Executor] Whoogle \u5BA2\u6237\u7AEF\u5DF2", client ? "\u8BBE\u7F6E" : "\u6E05\u7A7A");
  }
  /**
   * 设置 API 客户端（记忆图谱）
   */
  setAPIClient(client) {
    this.apiClient = client;
    console.log("[Tool Executor] API \u5BA2\u6237\u7AEF\u5DF2", client ? "\u8BBE\u7F6E" : "\u6E05\u7A7A");
  }
  /**
   * 设置标题更新回调
   */
  setUpdateTitleCallback(callback) {
    this.updateTitleCallback = callback;
    console.log("[Tool Executor] \u6807\u9898\u66F4\u65B0\u56DE\u8C03\u5DF2", callback ? "\u8BBE\u7F6E" : "\u6E05\u7A7A");
  }
  /**
   * 设置文档读取回调
   */
  setReadDocCallback(callback) {
    this.readDocCallback = callback;
    console.log("[Tool Executor] \u6587\u6863\u8BFB\u53D6\u56DE\u8C03\u5DF2", callback ? "\u8BBE\u7F6E" : "\u6E05\u7A7A");
  }
  /**
   * 设置全局搜索回调
   */
  setGlobalSearchCallback(callback) {
    this.globalSearchCallback = callback;
    console.log("[Tool Executor] \u5168\u5C40\u641C\u7D22\u56DE\u8C03\u5DF2", callback ? "\u8BBE\u7F6E" : "\u6E05\u7A7A");
  }
  /**
   * 设置打开文件回调
   */
  setOpenFileCallback(callback) {
    this.openFileCallback = callback;
    console.log("[Tool Executor] \u6253\u5F00\u6587\u4EF6\u56DE\u8C03\u5DF2", callback ? "\u8BBE\u7F6E" : "\u6E05\u7A7A");
  }
  /**
   * 检查 API 客户端是否可用
   */
  checkAPIClient(toolName) {
    if (!this.apiClient) {
      return {
        success: false,
        toolName,
        error: "API \u5BA2\u6237\u7AEF\u672A\u914D\u7F6E"
      };
    }
    if (!this.apiClient.isConnected()) {
      return {
        success: false,
        toolName,
        error: "\u672A\u8FDE\u63A5\u5230\u8BB0\u5FC6\u56FE\u8C31\u670D\u52A1"
      };
    }
    return null;
  }
};
__name(_ToolExecutorBase, "ToolExecutorBase");
var ToolExecutorBase = _ToolExecutorBase;

// src/utils/tools/tool_executor_basic.ts
var _ToolExecutorBasic = class _ToolExecutorBasic extends ToolExecutorBase {
  /**
   * 执行 Whoogle 搜索
   */
  async executeWhoogleSearch(args) {
    if (!this.whoogleClient) {
      return {
        success: false,
        toolName: "whoogle_search",
        error: "Whoogle \u5BA2\u6237\u7AEF\u672A\u914D\u7F6E"
      };
    }
    try {
      console.log("[Tool Executor] \u5F00\u59CB Whoogle \u641C\u7D22\uFF0C\u5173\u952E\u8BCD:", args.query);
      const response = await this.whoogleClient.search({
        query: args.query,
        pageno: args.pageno || 1
      });
      console.log("[Tool Executor] \u2713 \u641C\u7D22\u5B8C\u6210\uFF0C\u7ED3\u679C\u6570\u91CF:", response.number_of_results);
      return {
        success: true,
        toolName: "whoogle_search",
        result: response,
        displayText: `\u627E\u5230 ${response.number_of_results} \u6761\u641C\u7D22\u7ED3\u679C`
      };
    } catch (error) {
      console.error("[Tool Executor] \u2717 Whoogle \u641C\u7D22\u5931\u8D25:", error);
      return {
        success: false,
        toolName: "whoogle_search",
        error: error.message
      };
    }
  }
  /**
   * 执行修改聊天标题
   */
  async executeUpdateChatTitle(args) {
    var _a;
    if (!this.updateTitleCallback) {
      return {
        success: false,
        toolName: "update_chat_title",
        error: "\u6807\u9898\u66F4\u65B0\u56DE\u8C03\u672A\u914D\u7F6E"
      };
    }
    try {
      const newTitle = (_a = args.title) == null ? void 0 : _a.trim();
      if (!newTitle) {
        return {
          success: false,
          toolName: "update_chat_title",
          error: "\u6807\u9898\u4E0D\u80FD\u4E3A\u7A7A"
        };
      }
      console.log("[Tool Executor] \u66F4\u65B0\u804A\u5929\u6807\u9898:", newTitle);
      this.updateTitleCallback(newTitle);
      return {
        success: true,
        toolName: "update_chat_title",
        result: { title: newTitle },
        displayText: `\u5DF2\u5C06\u6807\u9898\u4FEE\u6539\u4E3A: ${newTitle}`
      };
    } catch (error) {
      console.error("[Tool Executor] \u2717 \u66F4\u65B0\u6807\u9898\u5931\u8D25:", error);
      return {
        success: false,
        toolName: "update_chat_title",
        error: error.message
      };
    }
  }
  /**
   * 执行读取文档
   */
  async executeReadDoc(args) {
    if (!this.readDocCallback) {
      return {
        success: false,
        toolName: "read_doc",
        error: "\u6587\u6863\u8BFB\u53D6\u56DE\u8C03\u672A\u914D\u7F6E"
      };
    }
    try {
      console.log("[Tool Executor] \u8BFB\u53D6\u5F53\u524D\u6587\u6863\u5185\u5BB9");
      const content = await this.readDocCallback();
      if (!content || content.trim() === "") {
        return {
          success: false,
          toolName: "read_doc",
          error: "\u6587\u6863\u5185\u5BB9\u4E3A\u7A7A\u6216\u4E0D\u5B58\u5728"
        };
      }
      console.log("[Tool Executor] \u2713 \u6587\u6863\u8BFB\u53D6\u6210\u529F\uFF0C\u957F\u5EA6:", content.length);
      return {
        success: true,
        toolName: "read_doc",
        result: { content },
        displayText: `\u5DF2\u8BFB\u53D6\u6587\u6863\u5185\u5BB9\uFF08${content.length} \u5B57\u7B26\uFF09`
      };
    } catch (error) {
      console.error("[Tool Executor] \u2717 \u8BFB\u53D6\u6587\u6863\u5931\u8D25:", error);
      return {
        success: false,
        toolName: "read_doc",
        error: error.message
      };
    }
  }
  /**
   * 执行 Obsidian 全局搜索
   */
  async executeObsidianGlobalSearch(args) {
    var _a, _b;
    if (!this.globalSearchCallback) {
      return {
        success: false,
        toolName: "obsidian_global_search",
        error: "\u5168\u5C40\u641C\u7D22\u56DE\u8C03\u672A\u914D\u7F6E"
      };
    }
    try {
      console.log("[Tool Executor] \u6267\u884C\u5168\u5C40\u641C\u7D22\uFF0C\u5173\u952E\u8BCD:", args.query);
      const result = await this.globalSearchCallback(args.query, args.limit || 20);
      console.log("[Tool Executor] \u2713 \u5168\u5C40\u641C\u7D22\u5B8C\u6210\uFF0C\u7ED3\u679C\u6570\u91CF:", ((_a = result == null ? void 0 : result.results) == null ? void 0 : _a.length) || 0);
      return {
        success: true,
        toolName: "obsidian_global_search",
        result,
        displayText: `\u5173\u952E\u8BCD"${args.query}"\u627E\u5230 ${((_b = result == null ? void 0 : result.results) == null ? void 0 : _b.length) || 0} \u6761\u7ED3\u679C`
      };
    } catch (error) {
      console.error("[Tool Executor] \u2717 \u5168\u5C40\u641C\u7D22\u5931\u8D25:", error);
      return {
        success: false,
        toolName: "obsidian_global_search",
        error: error.message
      };
    }
  }
  /**
   * 执行 Web 抓取
   */
  async executeWebFetch(args) {
    try {
      console.log("[Tool Executor] \u6293\u53D6\u7F51\u9875:", args.url);
      const Obsidian = window.Obsidian;
      if (!Obsidian || !Obsidian.requestUrl) {
        return {
          success: false,
          toolName: "web_fetch",
          error: "Obsidian requestUrl API \u4E0D\u53EF\u7528"
        };
      }
      const response = await Obsidian.requestUrl({
        url: args.url,
        method: "GET"
      });
      if (response.status !== 200) {
        return {
          success: false,
          toolName: "web_fetch",
          error: `HTTP ${response.status}: ${response.statusText}`
        };
      }
      const content = response.text || "";
      console.log("[Tool Executor] \u2713 \u7F51\u9875\u6293\u53D6\u6210\u529F\uFF0C\u957F\u5EA6:", content.length);
      return {
        success: true,
        toolName: "web_fetch",
        result: { url: args.url, content, format: args.returnFormat || "markdown" },
        displayText: `\u5DF2\u6293\u53D6\u7F51\u9875\u5185\u5BB9\uFF08${content.length} \u5B57\u7B26\uFF09`
      };
    } catch (error) {
      console.error("[Tool Executor] \u2717 \u6293\u53D6\u7F51\u9875\u5931\u8D25:", error);
      return {
        success: false,
        toolName: "web_fetch",
        error: error.message
      };
    }
  }
  /**
   * 执行打开文档
   */
  async executeObsidianOpenFile(args) {
    if (!this.openFileCallback) {
      return {
        success: false,
        toolName: "obsidian_open_file",
        error: "\u6253\u5F00\u6587\u4EF6\u56DE\u8C03\u672A\u914D\u7F6E"
      };
    }
    try {
      console.log("[Tool Executor] \u6253\u5F00\u6587\u6863:", args.path);
      await this.openFileCallback(args.path);
      console.log("[Tool Executor] \u2713 \u6587\u6863\u5DF2\u6253\u5F00");
      return {
        success: true,
        toolName: "obsidian_open_file",
        result: { path: args.path },
        displayText: `\u5DF2\u6253\u5F00\u6587\u6863: ${args.path}`
      };
    } catch (error) {
      console.error("[Tool Executor] \u2717 \u6253\u5F00\u6587\u6863\u5931\u8D25:", error);
      return {
        success: false,
        toolName: "obsidian_open_file",
        error: error.message
      };
    }
  }
};
__name(_ToolExecutorBasic, "ToolExecutorBasic");
var ToolExecutorBasic = _ToolExecutorBasic;

// src/utils/tools/tool_executor_memory.ts
var _ToolExecutorMemory = class _ToolExecutorMemory extends ToolExecutorBase {
  // ==================== 创建类工具 ====================
  /**
   * 执行创建实体
   */
  async executeCreateEntities(args) {
    const errorResult = this.checkAPIClient("memory_create_entities");
    if (errorResult) return errorResult;
    try {
      let fixedEntities = args.entities;
      if (typeof fixedEntities === "string") {
        console.log("[Tool Executor] \u68C0\u6D4B\u5230 entities \u662F\u5B57\u7B26\u4E32\uFF0C\u5C1D\u8BD5\u89E3\u6790...");
        try {
          fixedEntities = JSON.parse(fixedEntities);
          console.log("[Tool Executor] \u2713 \u89E3\u6790\u6210\u529F:", fixedEntities);
        } catch (e) {
          console.error("[Tool Executor] \u2717 \u89E3\u6790\u5931\u8D25:", e);
          throw new Error("entities \u53C2\u6570\u683C\u5F0F\u9519\u8BEF\uFF1A\u65E0\u6CD5\u89E3\u6790 JSON \u5B57\u7B26\u4E32");
        }
      }
      const result = await this.apiClient.create.createEntities(fixedEntities);
      const createdEntities = result.new_entities || [];
      const entityNames = createdEntities.map((e) => e.name).join("\u3001");
      return {
        success: true,
        toolName: "memory_create_entities",
        result,
        displayText: `\u5DF2\u521B\u5EFA ${createdEntities.length} \u4E2A\u5B9E\u4F53: ${entityNames}`
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_create_entities",
        error: error.message
      };
    }
  }
  /**
   * 执行添加观察记录
   */
  async executeAddObservations(args) {
    var _a;
    const errorResult = this.checkAPIClient("memory_add_observations");
    if (errorResult) return errorResult;
    try {
      let fixedObservations = args.observations;
      if (typeof fixedObservations === "string") {
        console.log("[Tool Executor] \u68C0\u6D4B\u5230 observations \u662F\u5B57\u7B26\u4E32\uFF0C\u5C1D\u8BD5\u89E3\u6790...");
        try {
          fixedObservations = JSON.parse(fixedObservations);
          console.log("[Tool Executor] \u2713 \u89E3\u6790\u6210\u529F:", fixedObservations);
        } catch (e) {
          console.error("[Tool Executor] \u2717 \u89E3\u6790\u5931\u8D25:", e);
          throw new Error("observations \u53C2\u6570\u683C\u5F0F\u9519\u8BEF\uFF1A\u65E0\u6CD5\u89E3\u6790 JSON \u5B57\u7B26\u4E32");
        }
      }
      const result = await this.apiClient.create.addObservations(fixedObservations);
      return {
        success: true,
        toolName: "memory_add_observations",
        result,
        displayText: `\u5DF2\u4E3A ${((_a = result.results) == null ? void 0 : _a.length) || 0} \u4E2A\u5B9E\u4F53\u6DFB\u52A0\u89C2\u5BDF\u8BB0\u5F55`
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_add_observations",
        error: error.message
      };
    }
  }
  /**
   * 执行创建关系
   */
  async executeCreateRelations(args) {
    var _a;
    const errorResult = this.checkAPIClient("memory_create_relations");
    if (errorResult) return errorResult;
    try {
      let fixedRelations = args.relations;
      if (typeof fixedRelations === "string") {
        console.log("[Tool Executor] \u68C0\u6D4B\u5230 relations \u662F\u5B57\u7B26\u4E32\uFF0C\u5C1D\u8BD5\u89E3\u6790...");
        try {
          fixedRelations = JSON.parse(fixedRelations);
          console.log("[Tool Executor] \u2713 \u89E3\u6790\u6210\u529F:", fixedRelations);
        } catch (e) {
          console.error("[Tool Executor] \u2717 \u89E3\u6790\u5931\u8D25:", e);
          throw new Error("relations \u53C2\u6570\u683C\u5F0F\u9519\u8BEF\uFF1A\u65E0\u6CD5\u89E3\u6790 JSON \u5B57\u7B26\u4E32");
        }
      }
      const result = await this.apiClient.create.createRelations(fixedRelations, args.autoCreateEntities);
      return {
        success: true,
        toolName: "memory_create_relations",
        result,
        displayText: `\u5DF2\u521B\u5EFA ${((_a = result.relations) == null ? void 0 : _a.length) || 0} \u6761\u5173\u7CFB`
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_create_relations",
        error: error.message
      };
    }
  }
  // ==================== 搜索类工具 ====================
  /**
   * 执行关键词搜索
   */
  async executeSearchNodes(args) {
    var _a;
    const errorResult = this.checkAPIClient("memory_search_nodes");
    if (errorResult) return errorResult;
    try {
      const result = await this.apiClient.search.searchNodes(args.query);
      return {
        success: true,
        toolName: "memory_search_nodes",
        result,
        displayText: `\u5173\u952E\u8BCD"${args.query}"\u627E\u5230 ${((_a = result.results) == null ? void 0 : _a.length) || 0} \u4E2A\u5339\u914D\u8282\u70B9`
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_search_nodes",
        error: error.message
      };
    }
  }
  /**
   * 执行语义搜索
   */
  async executeSemanticSearch(args) {
    var _a;
    const errorResult = this.checkAPIClient("memory_semantic_search");
    if (errorResult) return errorResult;
    try {
      const result = await this.apiClient.search.semanticSearch(args.query, args.limit || 10);
      return {
        success: true,
        toolName: "memory_semantic_search",
        result,
        displayText: `\u8BED\u4E49\u641C\u7D22\u627E\u5230 ${((_a = result.results) == null ? void 0 : _a.length) || 0} \u4E2A\u76F8\u5173\u8282\u70B9`
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_semantic_search",
        error: error.message
      };
    }
  }
  /**
   * 执行读取图谱
   */
  async executeReadGraph(args) {
    var _a;
    const errorResult = this.checkAPIClient("memory_read_graph");
    if (errorResult) return errorResult;
    try {
      const result = await this.apiClient.search.readGraph(args.limit, args.offset);
      return {
        success: true,
        toolName: "memory_read_graph",
        result,
        displayText: `\u5DF2\u8BFB\u53D6\u56FE\u8C31\uFF0C\u5305\u542B ${((_a = result.results) == null ? void 0 : _a.length) || 0} \u4E2A\u5B9E\u4F53`
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_read_graph",
        error: error.message
      };
    }
  }
  /**
   * 执行按名称检索节点
   */
  async executeOpenNodes(args) {
    var _a;
    const errorResult = this.checkAPIClient("memory_open_nodes");
    if (errorResult) return errorResult;
    try {
      let fixedNames = args.names;
      if (typeof fixedNames === "string") {
        console.log("[Tool Executor] \u68C0\u6D4B\u5230 names \u662F\u5B57\u7B26\u4E32\uFF0C\u5C1D\u8BD5\u89E3\u6790...");
        try {
          fixedNames = JSON.parse(fixedNames);
          console.log("[Tool Executor] \u2713 \u89E3\u6790\u6210\u529F:", fixedNames);
        } catch (e) {
          console.error("[Tool Executor] \u2717 \u89E3\u6790\u5931\u8D25:", e);
          throw new Error("names \u53C2\u6570\u683C\u5F0F\u9519\u8BEF\uFF1A\u65E0\u6CD5\u89E3\u6790 JSON \u5B57\u7B26\u4E32");
        }
      }
      const result = await this.apiClient.search.openNodes(fixedNames);
      return {
        success: true,
        toolName: "memory_open_nodes",
        result,
        displayText: `\u5DF2\u68C0\u7D22 ${((_a = result.results) == null ? void 0 : _a.length) || 0} \u4E2A\u8282\u70B9`
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_open_nodes",
        error: error.message
      };
    }
  }
  // ==================== 删除类工具 ====================
  /**
   * 执行删除实体
   */
  async executeDeleteEntities(args) {
    const errorResult = this.checkAPIClient("memory_delete_entities");
    if (errorResult) return errorResult;
    try {
      const result = await this.apiClient.delete.deleteEntities(args.entityNames);
      return {
        success: true,
        toolName: "memory_delete_entities",
        result,
        displayText: `\u5DF2\u5220\u9664 ${result.deleted_count || 0} \u4E2A\u5B9E\u4F53`
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_delete_entities",
        error: error.message
      };
    }
  }
  /**
   * 执行删除观察记录
   */
  async executeDeleteObservations(args) {
    const errorResult = this.checkAPIClient("memory_delete_observations");
    if (errorResult) return errorResult;
    try {
      let fixedDeletions = args.deletions;
      if (typeof fixedDeletions === "string") {
        console.log("[Tool Executor] \u68C0\u6D4B\u5230 deletions \u662F\u5B57\u7B26\u4E32\uFF0C\u5C1D\u8BD5\u89E3\u6790...");
        try {
          fixedDeletions = JSON.parse(fixedDeletions);
          console.log("[Tool Executor] \u2713 \u89E3\u6790\u6210\u529F:", fixedDeletions);
        } catch (e) {
          console.error("[Tool Executor] \u2717 \u89E3\u6790\u5931\u8D25:", e);
          throw new Error("deletions \u53C2\u6570\u683C\u5F0F\u9519\u8BEF\uFF1A\u65E0\u6CD5\u89E3\u6790 JSON \u5B57\u7B26\u4E32");
        }
      }
      const result = await this.apiClient.delete.deleteObservations(fixedDeletions);
      return {
        success: true,
        toolName: "memory_delete_observations",
        result,
        displayText: `\u5DF2\u5220\u9664 ${result.deleted_count || 0} \u6761\u89C2\u5BDF\u8BB0\u5F55`
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_delete_observations",
        error: error.message
      };
    }
  }
  /**
   * 执行删除关系
   */
  async executeDeleteRelations(args) {
    const errorResult = this.checkAPIClient("memory_delete_relations");
    if (errorResult) return errorResult;
    try {
      let fixedRelations = args.relations;
      if (typeof fixedRelations === "string") {
        console.log("[Tool Executor] \u68C0\u6D4B\u5230 relations \u662F\u5B57\u7B26\u4E32\uFF0C\u5C1D\u8BD5\u89E3\u6790...");
        try {
          fixedRelations = JSON.parse(fixedRelations);
          console.log("[Tool Executor] \u2713 \u89E3\u6790\u6210\u529F:", fixedRelations);
        } catch (e) {
          console.error("[Tool Executor] \u2717 \u89E3\u6790\u5931\u8D25:", e);
          throw new Error("relations \u53C2\u6570\u683C\u5F0F\u9519\u8BEF\uFF1A\u65E0\u6CD5\u89E3\u6790 JSON \u5B57\u7B26\u4E32");
        }
      }
      const result = await this.apiClient.delete.deleteRelations(fixedRelations);
      return {
        success: true,
        toolName: "memory_delete_relations",
        result,
        displayText: `\u5DF2\u5220\u9664 ${result.deleted_count || 0} \u6761\u5173\u7CFB`
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_delete_relations",
        error: error.message
      };
    }
  }
  // ==================== 管理类工具 ====================
  /**
   * 执行生成向量
   */
  async executeGenerateEmbeddings(args) {
    const errorResult = this.checkAPIClient("memory_generate_embeddings");
    if (errorResult) return errorResult;
    try {
      const result = await this.apiClient.create.generateEmbeddings(args.entityNames, args.limit);
      return {
        success: true,
        toolName: "memory_generate_embeddings",
        result,
        displayText: "\u5DF2\u751F\u6210\u5411\u91CF\u5D4C\u5165"
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_generate_embeddings",
        error: error.message
      };
    }
  }
  /**
   * 执行查看回收站
   */
  async executeViewTrash(args) {
    var _a;
    const errorResult = this.checkAPIClient("memory_view_trash");
    if (errorResult) return errorResult;
    try {
      const result = await this.apiClient.delete.viewTrash(args.limit, args.offset);
      return {
        success: true,
        toolName: "memory_view_trash",
        result,
        displayText: `\u56DE\u6536\u7AD9\u4E2D\u6709 ${((_a = result.results) == null ? void 0 : _a.length) || 0} \u4E2A\u9879\u76EE`
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_view_trash",
        error: error.message
      };
    }
  }
  /**
   * 执行恢复已删除内容
   */
  async executeRestoreDeleted(args) {
    const errorResult = this.checkAPIClient("memory_restore_deleted");
    if (errorResult) return errorResult;
    try {
      const result = await this.apiClient.delete.restoreDeleted(args.entityNames, args.observations);
      return {
        success: true,
        toolName: "memory_restore_deleted",
        result,
        displayText: "\u5DF2\u6062\u590D\u5220\u9664\u7684\u5185\u5BB9"
      };
    } catch (error) {
      return {
        success: false,
        toolName: "memory_restore_deleted",
        error: error.message
      };
    }
  }
};
__name(_ToolExecutorMemory, "ToolExecutorMemory");
var ToolExecutorMemory = _ToolExecutorMemory;

// src/utils/tools/tool_executor.ts
var _ToolExecutor = class _ToolExecutor {
  constructor() {
    __publicField(this, "basicExecutor");
    __publicField(this, "memoryExecutor");
    this.basicExecutor = new ToolExecutorBasic();
    this.memoryExecutor = new ToolExecutorMemory();
  }
  /**
   * 设置 Whoogle 客户端
   */
  setWhoogleClient(client) {
    this.basicExecutor.setWhoogleClient(client);
  }
  /**
   * 设置 API 客户端（记忆图谱）
   */
  setAPIClient(client) {
    this.basicExecutor.setAPIClient(client);
    this.memoryExecutor.setAPIClient(client);
  }
  /**
   * 设置标题更新回调
   */
  setUpdateTitleCallback(callback) {
    this.basicExecutor.setUpdateTitleCallback(callback);
  }
  /**
   * 设置文档读取回调
   */
  setReadDocCallback(callback) {
    this.basicExecutor.setReadDocCallback(callback);
  }
  /**
   * 设置全局搜索回调
   */
  setGlobalSearchCallback(callback) {
    this.basicExecutor.setGlobalSearchCallback(callback);
  }
  /**
   * 设置打开文件回调
   */
  setOpenFileCallback(callback) {
    this.basicExecutor.setOpenFileCallback(callback);
  }
  /**
   * 执行单个工具调用
   *
   * @param toolCall - LLM 返回的工具调用对象
   * @returns 工具执行结果
   */
  async executeToolCall(toolCall) {
    const functionName = toolCall.function.name;
    const rawArgs = toolCall.function.arguments;
    console.log(`[Tool Executor] \u539F\u59CB\u53C2\u6570 (${functionName}):`, rawArgs);
    let args;
    try {
      args = JSON.parse(rawArgs);
    } catch (e) {
      console.error(`[Tool Executor] JSON \u89E3\u6790\u5931\u8D25:`, e);
      throw new Error(`\u5DE5\u5177\u53C2\u6570\u683C\u5F0F\u9519\u8BEF: ${e.message}`);
    }
    console.log(`[Tool Executor] \u89E3\u6790\u540E\u53C2\u6570 (${functionName}):`, args);
    try {
      switch (functionName) {
        case "whoogle_search":
          return await this.basicExecutor.executeWhoogleSearch(args);
        case "update_chat_title":
          return await this.basicExecutor.executeUpdateChatTitle(args);
        case "read_doc":
          return await this.basicExecutor.executeReadDoc(args);
        case "obsidian_global_search":
          return await this.basicExecutor.executeObsidianGlobalSearch(args);
        case "web_fetch":
          return await this.basicExecutor.executeWebFetch(args);
        case "obsidian_open_file":
          return await this.basicExecutor.executeObsidianOpenFile(args);
      }
      switch (functionName) {
        // 创建类工具
        case "memory_create_entities":
          return await this.memoryExecutor.executeCreateEntities(args);
        case "memory_add_observations":
          return await this.memoryExecutor.executeAddObservations(args);
        case "memory_create_relations":
          return await this.memoryExecutor.executeCreateRelations(args);
        // 搜索类工具
        case "memory_search_nodes":
          return await this.memoryExecutor.executeSearchNodes(args);
        case "memory_semantic_search":
          return await this.memoryExecutor.executeSemanticSearch(args);
        case "memory_read_graph":
          return await this.memoryExecutor.executeReadGraph(args);
        case "memory_open_nodes":
          return await this.memoryExecutor.executeOpenNodes(args);
        // 删除类工具
        case "memory_delete_entities":
          return await this.memoryExecutor.executeDeleteEntities(args);
        case "memory_delete_observations":
          return await this.memoryExecutor.executeDeleteObservations(args);
        case "memory_delete_relations":
          return await this.memoryExecutor.executeDeleteRelations(args);
        // 管理类工具
        case "memory_generate_embeddings":
          return await this.memoryExecutor.executeGenerateEmbeddings(args);
        case "memory_view_trash":
          return await this.memoryExecutor.executeViewTrash(args);
        case "memory_restore_deleted":
          return await this.memoryExecutor.executeRestoreDeleted(args);
      }
      console.error(`[Tool Executor] \u2717 \u672A\u77E5\u7684\u5DE5\u5177: ${functionName}`);
      return {
        success: false,
        toolName: functionName,
        error: `\u672A\u77E5\u7684\u5DE5\u5177: ${functionName}`
      };
    } catch (error) {
      console.error(`[Tool Executor] \u2717 \u5DE5\u5177\u6267\u884C\u5F02\u5E38:`, error);
      return {
        success: false,
        toolName: functionName,
        error: error.message
      };
    }
  }
  /**
   * 批量执行多个工具调用
   *
   * @param toolCalls - 工具调用列表
   * @returns 执行结果列表
   */
  async executeToolCalls(toolCalls) {
    console.log("[Tool Executor] \u6279\u91CF\u6267\u884C\u5DE5\u5177\uFF0C\u6570\u91CF:", toolCalls.length);
    const results = [];
    for (const toolCall of toolCalls) {
      const result = await this.executeToolCall(toolCall);
      results.push(result);
    }
    console.log("[Tool Executor] \u2713 \u6279\u91CF\u6267\u884C\u5B8C\u6210\uFF0C\u6210\u529F:", results.filter((r) => r.success).length, "\u5931\u8D25:", results.filter((r) => !r.success).length);
    return results;
  }
};
__name(_ToolExecutor, "ToolExecutor");
var ToolExecutor = _ToolExecutor;

// src/utils/chat/chat_state.ts
var _ChatStateManager = class _ChatStateManager {
  constructor(initialWebSearchEnabled = false) {
    __publicField(this, "state");
    this.state = {
      messages: [],
      title: "\u65B0\u7684\u5BF9\u8BDD",
      webSearchEnabled: initialWebSearchEnabled,
      isGenerating: false,
      abortController: null,
      contextFile: null
    };
  }
  /**
   * 获取完整状态
   */
  getState() {
    return { ...this.state };
  }
  /**
   * 获取消息历史
   */
  getMessages() {
    return [...this.state.messages];
  }
  /**
   * 添加消息到历史
   */
  addMessage(message) {
    this.state.messages.push(message);
    console.log("[Chat State] \u6DFB\u52A0\u6D88\u606F\uFF0C\u5F53\u524D\u5386\u53F2\u957F\u5EA6:", this.state.messages.length);
  }
  /**
   * 移除最后一条消息
   */
  removeLastMessage() {
    const removed = this.state.messages.pop();
    if (removed) {
      console.log("[Chat State] \u79FB\u9664\u6700\u540E\u4E00\u6761\u6D88\u606F");
    }
    return removed || null;
  }
  /**
   * 清空消息历史
   */
  clearMessages() {
    this.state.messages = [];
    console.log("[Chat State] \u6E05\u7A7A\u6D88\u606F\u5386\u53F2");
  }
  /**
   * 获取标题
   */
  getTitle() {
    return this.state.title;
  }
  /**
   * 设置标题
   */
  setTitle(title) {
    this.state.title = title;
    console.log("[Chat State] \u6807\u9898\u5DF2\u66F4\u65B0:", title);
  }
  /**
   * 获取联网搜索状态
   */
  isWebSearchEnabled() {
    return this.state.webSearchEnabled;
  }
  /**
   * 切换联网搜索状态
   */
  toggleWebSearch() {
    this.state.webSearchEnabled = !this.state.webSearchEnabled;
    console.log("[Chat State] \u8054\u7F51\u641C\u7D22\u5DF2", this.state.webSearchEnabled ? "\u542F\u7528" : "\u7981\u7528");
    return this.state.webSearchEnabled;
  }
  /**
   * 获取生成状态
   */
  getIsGenerating() {
    return this.state.isGenerating;
  }
  /**
   * 设置生成状态
   */
  setGenerating(isGenerating, abortController) {
    this.state.isGenerating = isGenerating;
    if (abortController !== void 0) {
      this.state.abortController = abortController;
    }
    console.log("[Chat State] \u751F\u6210\u72B6\u6001:", isGenerating ? "\u751F\u6210\u4E2D" : "\u7A7A\u95F2");
  }
  /**
   * 获取 AbortController
   */
  getAbortController() {
    return this.state.abortController;
  }
  /**
   * 获取上下文文件
   */
  getContextFile() {
    return this.state.contextFile;
  }
  /**
   * 设置上下文文件
   */
  setContextFile(file) {
    this.state.contextFile = file;
    if (file) {
      console.log("[Chat State] \u4E0A\u4E0B\u6587\u6587\u4EF6\u5DF2\u8BBE\u7F6E:", file.name);
    } else {
      console.log("[Chat State] \u4E0A\u4E0B\u6587\u6587\u4EF6\u5DF2\u6E05\u9664");
    }
  }
  /**
   * 检查是否有上下文文件
   */
  hasContextFile() {
    return this.state.contextFile !== null;
  }
  /**
   * 重置状态（新建聊天时使用）
   */
  reset(initialWebSearchEnabled = false) {
    this.state.messages = [];
    this.state.title = "\u65B0\u7684\u5BF9\u8BDD";
    this.state.webSearchEnabled = initialWebSearchEnabled;
    this.state.isGenerating = false;
    this.state.abortController = null;
    this.state.contextFile = null;
    console.log("[Chat State] \u72B6\u6001\u5DF2\u91CD\u7F6E");
  }
};
__name(_ChatStateManager, "ChatStateManager");
var ChatStateManager = _ChatStateManager;

// src/utils/pages/chat_view.css.ts
var chatViewStyles = `
	/* AI\u804A\u5929\u754C\u9762\u6837\u5F0F */
	.ai-chat-container {
		flex: 1;
		display: flex;
		flex-direction: column;
		overflow: hidden;
	}

	.ai-chat-toolbar {
		display: flex;
		gap: 4px;
		padding: 8px 12px;
		border-bottom: 1px solid var(--background-modifier-border);
		background: var(--background-primary);
		justify-content: space-between;
		align-items: center;
	}

	.ai-chat-title {
		flex: 1;
		font-size: 14px;
		font-weight: 500;
		color: var(--text-normal);
		cursor: pointer;
		padding: 4px 8px;
		border-radius: 3px;
		transition: all 0.15s ease;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		max-width: 300px;
	}

	.ai-chat-title:hover {
		background: var(--background-modifier-hover);
		color: var(--text-accent);
	}

	.ai-chat-title-input {
		width: 100%;
		max-width: 300px;
		padding: 4px 8px;
		border: 1px solid var(--interactive-accent);
		border-radius: 3px;
		background: var(--background-primary);
		color: var(--text-normal);
		font-size: 14px;
		font-weight: 500;
		font-family: inherit;
	}

	.ai-chat-title-input:focus {
		outline: none;
		border-color: var(--interactive-accent);
	}

	.ai-chat-toolbar-buttons {
		display: flex;
		gap: 4px;
		align-items: center;
	}

	.ai-chat-toolbar-button {
		width: 28px;
		height: 28px;
		padding: 0;
		border: none;
		border-radius: 3px;
		background: transparent;
		color: var(--text-muted);
		cursor: pointer;
		transition: all 0.15s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		opacity: 0.7;
	}

	.ai-chat-toolbar-button:hover {
		background: transparent;
		color: var(--text-normal);
		opacity: 1;
	}

	.ai-chat-toolbar-button svg {
		width: 16px;
		height: 16px;
	}

	.ai-chat-messages {
		flex: 1;
		overflow-y: auto;
		padding: 15px;
		display: flex;
		flex-direction: column;
		gap: 12px;
	}

	.ai-chat-welcome {
		text-align: center;
		padding: 40px 20px;
		color: var(--text-muted);
		font-size: 14px;
	}

	.ai-chat-message {
		display: flex;
		flex-direction: column;
		gap: 6px;
		max-width: 85%;
		animation: fadeIn 0.3s ease-in;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.ai-chat-message.user {
		align-self: flex-end;
	}

	.ai-chat-message.assistant {
		align-self: flex-start;
	}

	.ai-chat-message-role {
		font-size: 12px;
		font-weight: 500;
		color: var(--text-muted);
		padding: 0 8px;
	}

	.ai-chat-message.user .ai-chat-message-role {
		text-align: right;
	}

	.ai-chat-message-content {
		padding: 10px 14px;
		border-radius: 8px;
		font-size: 14px;
		line-height: 1.5;
		word-wrap: break-word;
		white-space: pre-wrap;
		user-select: text;
		-webkit-user-select: text;
		-moz-user-select: text;
		-ms-user-select: text;
		cursor: text;
	}

	.ai-chat-message.user .ai-chat-message-content {
		background: var(--background-secondary);
		color: var(--text-normal);
		border: 2px solid var(--interactive-accent);
		border-bottom-right-radius: 2px;
	}

	/* \u7528\u6237\u6D88\u606F\u9009\u4E2D\u6587\u5B57\u6837\u5F0F */
	.ai-chat-message.user .ai-chat-message-content ::selection {
		background: var(--text-selection);
		color: var(--text-normal);
	}

	.ai-chat-message.user .ai-chat-message-content ::-moz-selection {
		background: var(--text-selection);
		color: var(--text-normal);
	}

	.ai-chat-message.assistant .ai-chat-message-content {
		background: var(--background-secondary);
		color: var(--text-normal);
		border: 1px solid var(--background-modifier-border);
		border-bottom-left-radius: 2px;
	}

	/* AI\u6D88\u606F\u9009\u4E2D\u6587\u5B57\u6837\u5F0F */
	.ai-chat-message.assistant .ai-chat-message-content ::selection {
		background: var(--text-selection);
		color: var(--text-normal);
	}

	.ai-chat-message.assistant .ai-chat-message-content ::-moz-selection {
		background: var(--text-selection);
		color: var(--text-normal);
	}

	.ai-chat-message-content.thinking {
		font-style: italic;
		opacity: 0.7;
		animation: pulse 1.5s ease-in-out infinite;
	}

	@keyframes pulse {
		0%, 100% {
			opacity: 0.7;
		}
		50% {
			opacity: 1;
		}
	}

	.ai-chat-input-container {
		display: flex;
		flex-direction: column;
		gap: 8px;
		padding: 12px;
		border-top: 1px solid var(--background-modifier-border);
		background: var(--background-primary);
	}

	.ai-chat-input-toolbar {
		display: flex;
		gap: 6px;
		align-items: center;
		padding: 4px 0;
	}

	.ai-chat-input-toolbar-button {
		width: 32px;
		height: 32px;
		padding: 0;
		border: 1px solid transparent;
		border-radius: 6px;
		background: transparent;
		color: var(--text-muted);
		cursor: pointer;
		transition: all 0.2s ease;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.ai-chat-input-toolbar-button:hover {
		background: var(--background-modifier-hover);
		color: var(--text-normal);
		border-color: var(--background-modifier-border);
	}

	.ai-chat-input-toolbar-button.active {
		background: var(--interactive-accent);
		color: var(--text-on-accent);
		border-color: var(--interactive-accent);
	}

	.ai-chat-input-toolbar-button svg {
		width: 18px;
		height: 18px;
	}

	/* \u4E0A\u4E0B\u6587\u6587\u4EF6\u6807\u7B7E */
	.ai-chat-context-file-tag {
		display: flex;
		align-items: center;
		gap: 6px;
		padding: 6px 10px;
		border: 1px dashed var(--background-modifier-border);
		border-radius: 6px;
		background: var(--background-secondary);
		font-size: 13px;
		color: var(--text-muted);
		transition: all 0.2s ease;
	}

	.ai-chat-context-file-tag:hover {
		border-color: var(--text-muted);
		background: var(--background-modifier-hover);
	}

	.ai-chat-context-file-name {
		max-width: 200px;
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
		color: var(--text-normal);
	}

	.ai-chat-context-file-close {
		width: 18px;
		height: 18px;
		padding: 0;
		border: none;
		background: transparent;
		color: var(--text-muted);
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 3px;
		transition: all 0.15s ease;
	}

	.ai-chat-context-file-close:hover {
		background: var(--background-modifier-error);
		color: var(--text-error);
	}

	.ai-chat-context-file-close svg {
		width: 14px;
		height: 14px;
	}

	.ai-chat-input-wrapper {
		display: flex;
		gap: 8px;
		align-items: center;
	}

	.ai-chat-input {
		flex: 1;
		height: 40px;
		padding: 0 12px;
		border: 1px solid var(--background-modifier-border);
		border-radius: 6px;
		background: var(--background-primary);
		color: var(--text-normal);
		font-size: 14px;
		font-family: inherit;
	}

	.ai-chat-input:focus {
		outline: none;
		border-color: var(--interactive-accent);
	}

	.ai-chat-send-button {
		padding: 10px 24px;
		height: 40px;
		border: none;
		border-radius: 6px;
		background: var(--interactive-accent);
		color: var(--text-on-accent);
		font-size: 14px;
		font-weight: 500;
		cursor: pointer;
		transition: all 0.2s;
	}

	.ai-chat-send-button:hover {
		background: var(--interactive-accent-hover);
	}

	.ai-chat-send-button:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}

	/* \u505C\u6B62\u6309\u94AE\u6837\u5F0F\uFF08\u7EA2\u8272\uFF09 */
	.ai-chat-send-button.ai-chat-stop-button {
		background: var(--text-error);
		color: var(--text-on-accent);
	}

	.ai-chat-send-button.ai-chat-stop-button:hover {
		background: #dc2626; /* \u66F4\u6DF1\u7684\u7EA2\u8272 */
	}

	/* Markdown \u5185\u5BB9\u6837\u5F0F */
	.ai-chat-message-content.markdown-content {
		line-height: 1.6;
	}

	.ai-chat-message-content.markdown-content > * {
		margin: 0.3em 0;
	}

	.ai-chat-message-content.markdown-content > *:first-child {
		margin-top: 0;
	}

	.ai-chat-message-content.markdown-content > *:last-child {
		margin-bottom: 0;
	}

	.ai-chat-message-content.markdown-content p {
		margin: 0.3em 0;
	}

	.ai-chat-message-content.markdown-content p:first-child {
		margin-top: 0;
	}

	.ai-chat-message-content.markdown-content p:last-child {
		margin-bottom: 0;
	}

	.ai-chat-message-content.markdown-content ul,
	.ai-chat-message-content.markdown-content ol {
		margin: 0.2em 0;
		padding-left: 1.5em;
	}

	.ai-chat-message-content.markdown-content code {
		background: var(--code-background);
		padding: 2px 6px;
		border-radius: 3px;
		font-family: var(--font-monospace);
		font-size: 0.9em;
	}

	.ai-chat-message-content.markdown-content pre {
		background: var(--code-background);
		padding: 12px;
		border-radius: 6px;
		overflow-x: auto;
		margin: 0.3em 0;
	}

	.ai-chat-message-content.markdown-content pre code {
		background: transparent;
		padding: 0;
	}

	.ai-chat-message-content.markdown-content a {
		color: var(--link-color);
		text-decoration: none;
	}

	.ai-chat-message-content.markdown-content a:hover {
		text-decoration: underline;
	}

	.ai-chat-message-content.markdown-content strong {
		font-weight: 600;
	}

	.ai-chat-message-content.markdown-content em {
		font-style: italic;
	}

	.ai-chat-message-content.markdown-content h1,
	.ai-chat-message-content.markdown-content h2,
	.ai-chat-message-content.markdown-content h3,
	.ai-chat-message-content.markdown-content h4,
	.ai-chat-message-content.markdown-content h5,
	.ai-chat-message-content.markdown-content h6 {
		margin-top: 0.4em;
		margin-bottom: 0.2em;
		font-weight: 600;
	}

	.ai-chat-message-content.markdown-content h1 {
		font-size: 1.5em;
	}

	.ai-chat-message-content.markdown-content h2 {
		font-size: 1.3em;
	}

	.ai-chat-message-content.markdown-content h3 {
		font-size: 1.15em;
	}

	.ai-chat-message-content.markdown-content blockquote {
		border-left: 3px solid var(--interactive-accent);
		padding-left: 1em;
		margin: 0.3em 0;
		color: var(--text-muted);
	}

	/* \u52A0\u8F7D\u52A8\u753B\u6837\u5F0F */
	.ai-chat-loading-animation {
		display: flex;
		gap: 6px;
		align-items: center;
		padding: 4px 0;
	}

	.ai-chat-loading-dot {
		width: 8px;
		height: 8px;
		border-radius: 50%;
		background: var(--text-muted);
		animation: loadingDot 1.4s ease-in-out infinite;
	}

	.ai-chat-loading-dot:nth-child(1) {
		animation-delay: 0s;
	}

	.ai-chat-loading-dot:nth-child(2) {
		animation-delay: 0.2s;
	}

	.ai-chat-loading-dot:nth-child(3) {
		animation-delay: 0.4s;
	}

	@keyframes loadingDot {
		0%, 80%, 100% {
			opacity: 0.3;
			transform: scale(0.8);
		}
		40% {
			opacity: 1;
			transform: scale(1.2);
		}
	}

	/* \u79FB\u52A8\u7AEF\u9002\u914D */
	@media (max-width: 768px) {
		.ai-chat-container {
			flex: 1;
			display: flex;
			flex-direction: column;
			min-height: 0;
		}

		.ai-chat-toolbar {
			padding: 8px 12px;
			gap: 4px;
			flex-shrink: 0;
		}

		.ai-chat-title {
			font-size: 14px;
			font-weight: 500;
			color: var(--text-normal);
			cursor: pointer;
			padding: 4px 8px;
			border-radius: 3px;
			transition: all 0.15s ease;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			max-width: 300px;
		}

		.ai-chat-toolbar-button {
			width: 28px;
			height: 28px;
			padding: 0;
			border: none;
			border-radius: 3px;
			background: transparent;
			color: var(--text-muted);
			cursor: pointer;
			transition: all 0.15s ease;
			display: flex;
			align-items: center;
			justify-content: center;
			opacity: 0.7;
		}

		.ai-chat-toolbar-button svg {
			width: 16px;
			height: 16px;
		}

		.ai-chat-messages {
			flex: 1;
			overflow-y: auto;
			padding: 15px;
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.ai-chat-message {
			max-width: 85%;
		}

		.ai-chat-input-container {
			display: flex;
			flex-direction: column;
			gap: 8px;
			padding: 12px;
			border-top: 1px solid var(--background-modifier-border);
			background: var(--background-primary);
			flex-shrink: 0;
		}

		.ai-chat-input-toolbar {
			display: flex;
			gap: 6px;
			align-items: center;
			padding: 4px 0;
		}

		.ai-chat-input-toolbar-button {
			width: 32px;
			height: 32px;
			padding: 0;
			border: 1px solid transparent;
			border-radius: 6px;
			background: transparent;
			color: var(--text-muted);
			cursor: pointer;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.ai-chat-input-toolbar-button svg {
			width: 18px;
			height: 18px;
		}

		.ai-chat-input-wrapper {
			display: flex;
			gap: 8px;
			align-items: center;
		}

		.ai-chat-input {
			flex: 1;
			height: 40px;
			padding: 0 12px;
			border: 1px solid var(--background-modifier-border);
			border-radius: 6px;
			background: var(--background-primary);
			color: var(--text-normal);
			font-size: 14px;
			font-family: inherit;
		}

		.ai-chat-input:focus {
			outline: none;
			border-color: var(--interactive-accent);
		}

		.ai-chat-send-button {
			padding: 10px 24px;
			height: 40px;
			border: none;
			border-radius: 6px;
			background: var(--interactive-accent);
			color: var(--text-on-accent);
			font-size: 14px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.2s;
		}
	}
`;

// src/utils/chat/chat_ui.ts
var import_obsidian9 = require("obsidian");
var _ChatUIManager = class _ChatUIManager {
  constructor(container, dependencies) {
    __publicField(this, "ui");
    __publicField(this, "dependencies");
    this.dependencies = dependencies;
    this.ui = this.createInterface(container);
    this.setupMobileKeyboardHandling();
  }
  /**
   * 清理文本中的多余空行
   * 将多个连续换行符替换为单个换行符
   */
  cleanupText(content) {
    if (!content) return content;
    let cleaned = content.trim();
    cleaned = cleaned.replace(/\n{2,}/g, "\n");
    return cleaned;
  }
  /**
   * 获取 UI 元素
   */
  getUI() {
    return this.ui;
  }
  /**
   * 创建聊天界面
   */
  createInterface(container) {
    const chatContainer = container.createDiv({ cls: "ai-chat-container" });
    chatContainer.style.display = "none";
    const toolbar = this.createToolbar(chatContainer);
    const messagesContainer = this.createMessagesContainer(chatContainer);
    const inputContainer = this.createInputContainer(chatContainer);
    return {
      container: chatContainer,
      toolbar,
      title: toolbar.querySelector(".ai-chat-title"),
      messagesContainer,
      inputContainer,
      inputToolbar: inputContainer.querySelector(".ai-chat-input-toolbar"),
      input: inputContainer.querySelector(".ai-chat-input"),
      sendButton: inputContainer.querySelector(".ai-chat-send-button"),
      searchButton: inputContainer.querySelector(".ai-chat-input-toolbar-button"),
      contextFileTag: inputContainer.querySelector(".ai-chat-context-file-tag")
    };
  }
  /**
   * 创建顶部工具栏
   */
  createToolbar(container) {
    const toolbar = container.createDiv({ cls: "ai-chat-toolbar" });
    const title = toolbar.createDiv({
      cls: "ai-chat-title",
      text: "\u65B0\u7684\u5BF9\u8BDD"
    });
    const toolButtons = toolbar.createDiv({ cls: "ai-chat-toolbar-buttons" });
    const newChatButton = toolButtons.createEl("button", {
      cls: "ai-chat-toolbar-button",
      attr: { "aria-label": "\u65B0\u5EFA\u804A\u5929" }
    });
    (0, import_obsidian9.setIcon)(newChatButton, "plus");
    const historyButton = toolButtons.createEl("button", {
      cls: "ai-chat-toolbar-button",
      attr: { "aria-label": "\u67E5\u770B\u5386\u53F2" }
    });
    (0, import_obsidian9.setIcon)(historyButton, "clock");
    return toolbar;
  }
  /**
   * 创建消息显示区
   */
  createMessagesContainer(container) {
    const messagesContainer = container.createDiv({ cls: "ai-chat-messages" });
    messagesContainer.createEl("div", {
      text: "\u5F00\u59CB\u4E0EAI\u5BF9\u8BDD\u5427\uFF01",
      cls: "ai-chat-welcome"
    });
    return messagesContainer;
  }
  /**
   * 创建底部输入区
   */
  createInputContainer(container) {
    const inputContainer = container.createDiv({ cls: "ai-chat-input-container" });
    const inputToolbar = inputContainer.createDiv({ cls: "ai-chat-input-toolbar" });
    const searchButton = inputToolbar.createEl("button", {
      cls: "ai-chat-input-toolbar-button",
      attr: { "aria-label": "\u8054\u7F51\u641C\u7D22" }
    });
    (0, import_obsidian9.setIcon)(searchButton, "globe");
    const contextFileTag = inputToolbar.createDiv({ cls: "ai-chat-context-file-tag" });
    contextFileTag.style.display = "none";
    const inputWrapper = inputContainer.createDiv({ cls: "ai-chat-input-wrapper" });
    const input = inputWrapper.createEl("input", {
      type: "text",
      placeholder: "\u8F93\u5165\u6D88\u606F...",
      cls: "ai-chat-input"
    });
    const sendButton = inputWrapper.createEl("button", {
      text: "\u53D1\u9001",
      cls: "ai-chat-send-button"
    });
    return inputContainer;
  }
  /**
   * 添加消息到界面（纯文本）
   */
  addMessage(role, content) {
    const cleanedContent = this.cleanupText(content);
    const messageDiv = this.ui.messagesContainer.createDiv({
      cls: `ai-chat-message ${role}`
    });
    const roleLabel = messageDiv.createEl("div", {
      text: role === "user" ? "\u6211" : "AI",
      cls: "ai-chat-message-role"
    });
    const contentDiv = messageDiv.createEl("div", {
      cls: "ai-chat-message-content"
    });
    contentDiv.textContent = cleanedContent;
    this.scrollToBottom();
    return messageDiv;
  }
  /**
   * 添加消息到界面（Markdown 渲染）
   */
  async addMarkdownMessage(role, content) {
    const cleanedContent = this.cleanupText(content);
    const messageDiv = this.ui.messagesContainer.createDiv({
      cls: `ai-chat-message ${role}`
    });
    const roleLabel = messageDiv.createEl("div", {
      text: role === "user" ? "\u6211" : "AI",
      cls: "ai-chat-message-role"
    });
    const contentDiv = messageDiv.createEl("div", {
      cls: "ai-chat-message-content markdown-content"
    });
    await import_obsidian9.MarkdownRenderer.render(
      this.dependencies.app,
      cleanedContent,
      contentDiv,
      "",
      // sourcePath
      this.dependencies.markdownComponent
    );
    this.scrollToBottom();
    return messageDiv;
  }
  /**
   * 创建流式消息容器
   */
  createStreamingMessage(role) {
    const messageDiv = this.ui.messagesContainer.createDiv({
      cls: `ai-chat-message ${role}`
    });
    const roleLabel = messageDiv.createEl("div", {
      text: role === "user" ? "\u6211" : "AI",
      cls: "ai-chat-message-role"
    });
    const contentDiv = messageDiv.createEl("div", {
      cls: "ai-chat-message-content markdown-content"
    });
    const loadingDiv = contentDiv.createEl("div", {
      cls: "ai-chat-loading-animation"
    });
    loadingDiv.createEl("span", { cls: "ai-chat-loading-dot" });
    loadingDiv.createEl("span", { cls: "ai-chat-loading-dot" });
    loadingDiv.createEl("span", { cls: "ai-chat-loading-dot" });
    this.scrollToBottom();
    return {
      messageDiv,
      contentDiv,
      buffer: { text: "" }
    };
  }
  /**
   * 更新流式消息内容
   */
  async updateStreamingMessage(contentDiv, buffer, newText) {
    buffer.text += newText;
    const cleanedText = this.cleanupText(buffer.text);
    contentDiv.empty();
    await import_obsidian9.MarkdownRenderer.render(
      this.dependencies.app,
      cleanedText,
      contentDiv,
      "",
      this.dependencies.markdownComponent
    );
    this.scrollToBottom();
  }
  /**
   * 创建思考中提示
   */
  createThinkingIndicator() {
    const thinkingDiv = this.ui.messagesContainer.createDiv({ cls: "ai-chat-message assistant" });
    const thinkingContent = thinkingDiv.createEl("div", {
      cls: "ai-chat-message-content thinking"
    });
    thinkingContent.createEl("div", { text: "AI\u601D\u8003\u4E2D..." });
    return thinkingDiv;
  }
  /**
   * 滚动到底部
   */
  scrollToBottom() {
    this.ui.messagesContainer.scrollTop = this.ui.messagesContainer.scrollHeight;
  }
  /**
   * 更新发送按钮状态
   */
  updateSendButtonState(isGenerating) {
    if (isGenerating) {
      this.ui.sendButton.textContent = "\u505C\u6B62";
      this.ui.sendButton.addClass("ai-chat-stop-button");
    } else {
      this.ui.sendButton.textContent = "\u53D1\u9001";
      this.ui.sendButton.removeClass("ai-chat-stop-button");
    }
  }
  /**
   * 更新搜索按钮状态
   */
  updateSearchButtonState(isEnabled) {
    if (isEnabled) {
      this.ui.searchButton.addClass("active");
    } else {
      this.ui.searchButton.removeClass("active");
    }
  }
  /**
   * 更新标题
   */
  updateTitle(title) {
    this.ui.title.textContent = title;
  }
  /**
   * 显示容器
   */
  show() {
    this.ui.container.style.display = "flex";
  }
  /**
   * 隐藏容器
   */
  hide() {
    this.ui.container.style.display = "none";
  }
  /**
   * 获取输入框内容
   */
  getInputValue() {
    return this.ui.input.value.trim();
  }
  /**
   * 清空输入框
   */
  clearInput() {
    this.ui.input.value = "";
  }
  /**
   * 设置输入框禁用状态
   */
  setInputDisabled(disabled) {
    this.ui.input.disabled = disabled;
  }
  /**
   * 聚焦输入框
   */
  focusInput() {
    this.ui.input.focus();
  }
  /**
   * 清空消息显示区
   */
  clearMessages() {
    this.ui.messagesContainer.empty();
    this.ui.messagesContainer.createEl("div", {
      text: "\u5F00\u59CB\u4E0EAI\u5BF9\u8BDD\u5427\uFF01",
      cls: "ai-chat-welcome"
    });
  }
  /**
   * 更新上下文文件标签
   */
  updateContextFileTag(fileName, onRemove) {
    if (!fileName) {
      this.ui.contextFileTag.style.display = "none";
      this.ui.contextFileTag.empty();
      return;
    }
    this.ui.contextFileTag.empty();
    this.ui.contextFileTag.style.display = "flex";
    this.ui.contextFileTag.createSpan({
      text: fileName,
      cls: "ai-chat-context-file-name"
    });
    const closeButton = this.ui.contextFileTag.createEl("button", {
      cls: "ai-chat-context-file-close",
      attr: { "aria-label": "\u79FB\u9664\u4E0A\u4E0B\u6587" }
    });
    (0, import_obsidian9.setIcon)(closeButton, "x");
    if (onRemove) {
      closeButton.addEventListener("click", onRemove);
    }
  }
  /**
   * 设置移动端键盘处理
   * 由于无法检测键盘状态，采用简化方案：
   * 输入框获得焦点时，滚动消息区域到底部
   */
  setupMobileKeyboardHandling() {
    const { Notice: Notice10 } = require("obsidian");
    const isMobile = window.innerWidth <= 768;
    if (!isMobile) return;
    const input = this.ui.input;
    const messagesContainer = this.ui.messagesContainer;
    input.addEventListener("focus", () => {
      new Notice10("\u8F93\u5165\u6846\u83B7\u5F97\u7126\u70B9\uFF0C\u6EDA\u52A8\u5230\u5E95\u90E8", 2e3);
      setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 300);
    });
    new Notice10("\u79FB\u52A8\u7AEF\uFF1A\u4F7F\u7528\u7B80\u5316\u7B56\u7565");
  }
  /**
   * 获取样式
   */
  static getStyles() {
    return chatViewStyles;
  }
};
__name(_ChatUIManager, "ChatUIManager");
var ChatUIManager = _ChatUIManager;

// src/utils/chat/chat_tool_handler.ts
var import_obsidian10 = require("obsidian");
var _ChatToolHandler = class _ChatToolHandler {
  constructor(toolExecutor, ui) {
    __publicField(this, "toolExecutor");
    __publicField(this, "ui");
    this.toolExecutor = toolExecutor;
    this.ui = ui;
  }
  /**
   * 处理工具调用
   */
  async handleToolCalls(toolCalls) {
    console.log("[Tool Handler] \u5F00\u59CB\u5904\u7406\u5DE5\u5177\u8C03\u7528\uFF0C\u6570\u91CF:", toolCalls.length);
    const results = [];
    try {
      for (const toolCall of toolCalls) {
        const result = await this.executeToolCall(toolCall);
        results.push(result);
      }
      return { success: true, results };
    } catch (error) {
      console.error("[Tool Handler] \u2717 \u5904\u7406\u5DE5\u5177\u8C03\u7528\u5F02\u5E38:", error);
      new import_obsidian10.Notice(`\u5DE5\u5177\u8C03\u7528\u5931\u8D25: ${error.message}`);
      return { success: false, results };
    }
  }
  /**
   * 执行单个工具调用
   */
  async executeToolCall(toolCall) {
    const toolName = toolCall.function.name;
    const toolArgs = JSON.parse(toolCall.function.arguments);
    console.log("[Tool Handler] \u6267\u884C\u5DE5\u5177:", toolName, "\u53C2\u6570:", toolArgs);
    const statusDiv = this.ui.addMessage("assistant", `\u{1F527} \u8C03\u7528\u5DE5\u5177: ${toolName}
\u6267\u884C\u4E2D...`);
    const result = await this.toolExecutor.executeToolCall(toolCall);
    statusDiv.remove();
    if (result.success) {
      console.log("[Tool Handler] \u2713 \u5DE5\u5177\u6267\u884C\u6210\u529F:", result.displayText);
      let statusText = `\u{1F527} \u8C03\u7528\u5DE5\u5177: ${toolName}
\u2713 ${result.displayText}`;
      if (result.result && result.result.results && result.result.results.length > 0) {
        const results = result.result.results.slice(0, 6);
        const validResults = results.filter((r) => r.title && r.title.trim() !== "" && r.url && r.url.trim() !== "");
        if (validResults.length > 0) {
          const resultsList = validResults.map(
            (r, i) => `${i + 1}. [${r.title}](${r.url})`
          ).join("\n");
          statusText += `

**\u641C\u7D22\u7ED3\u679C\uFF1A**
${resultsList}`;
        }
      }
      await this.ui.addMarkdownMessage("assistant", statusText);
    } else {
      console.error("[Tool Handler] \u2717 \u5DE5\u5177\u6267\u884C\u5931\u8D25:", result.error);
      await this.ui.addMarkdownMessage("assistant", `\u{1F527} \u8C03\u7528\u5DE5\u5177: ${toolName}
\u2717 \u6267\u884C\u5931\u8D25: ${result.error}`);
    }
    return result;
  }
};
__name(_ChatToolHandler, "ChatToolHandler");
var ChatToolHandler = _ChatToolHandler;

// src/utils/tools/whoogle_search_tool.ts
var whoogleSearchTool = {
  type: "function",
  function: {
    name: "whoogle_search",
    description: "\u4F7F\u7528 Whoogle \u8FDB\u884C\u7F51\u7EDC\u641C\u7D22\uFF0C\u83B7\u53D6\u5B9E\u65F6\u4FE1\u606F\u3002\u9002\u7528\u4E8E\u9700\u8981\u67E5\u8BE2\u6700\u65B0\u8D44\u8BAF\u3001\u4E8B\u5B9E\u6838\u67E5\u3001\u83B7\u53D6\u7F51\u9875\u5185\u5BB9\u7B49\u573A\u666F\u3002",
    parameters: {
      type: "object",
      properties: {
        query: {
          type: "string",
          description: '\u641C\u7D22\u5173\u952E\u8BCD\u6216\u95EE\u9898\uFF0C\u4F8B\u5982\uFF1A"\u4E0A\u6D77\u4ECA\u5929\u5929\u6C14"\u3001"2024\u5E74\u4EBA\u5DE5\u667A\u80FD\u53D1\u5C55\u8D8B\u52BF"'
        },
        pageno: {
          type: "integer",
          description: "\u641C\u7D22\u7ED3\u679C\u9875\u7801\uFF0C\u9ED8\u8BA4\u4E3A 1",
          default: 1
        }
      },
      required: ["query"]
    }
  }
};

// src/utils/tools/update_title_tool.ts
var updateChatTitleTool = {
  type: "function",
  function: {
    name: "update_chat_title",
    description: "\u4FEE\u6539\u5F53\u524D\u804A\u5929\u5BF9\u8BDD\u7684\u6807\u9898\u3002\u6BCF\u6B21\u5F00\u59CB\u5BF9\u8BDD\u90FD\u5E94\u8BE5\u4FEE\u6539\u6807\u9898\uFF0C\u4EE5\u786E\u4FDD\u6807\u9898\u80FD\u51C6\u786E\u6982\u62EC\u5BF9\u8BDD\u4E3B\u9898\u3002",
    parameters: {
      type: "object",
      properties: {
        title: {
          type: "string",
          description: "\u65B0\u7684\u804A\u5929\u6807\u9898\uFF0C\u5E94\u7B80\u6D01\u660E\u4E86\u5730\u6982\u62EC\u5BF9\u8BDD\u4E3B\u9898\uFF0C\u5EFA\u8BAE\u4E0D\u8D85\u8FC720\u4E2A\u5B57\u7B26"
        }
      },
      required: ["title"]
    }
  }
};

// src/utils/tools/read_doc_tool.ts
var readDocTool = {
  type: "function",
  function: {
    name: "read_doc",
    description: '\u8BFB\u53D6\u5F53\u524D\u6253\u5F00\u7684\u7B14\u8BB0\u6587\u6863\u5185\u5BB9\u3002\u5F53\u7528\u6237\u63D0\u5230"\u5F53\u524D\u6587\u6863"\u3001"\u8FD9\u4E2A\u7B14\u8BB0"\u3001"\u6587\u4EF6\u5185\u5BB9"\u7B49\u65F6\uFF0C\u53EF\u4EE5\u4F7F\u7528\u6B64\u5DE5\u5177\u83B7\u53D6\u5B8C\u6574\u5185\u5BB9\u3002',
    parameters: {
      type: "object",
      properties: {},
      required: []
    }
  }
};

// src/utils/tools/obsidian_global_search_tool.ts
var obsidianGlobalSearchTool = {
  type: "function",
  function: {
    name: "obsidian_global_search",
    description: "\u5728\u6574\u4E2A Obsidian \u7B14\u8BB0\u5E93\u4E2D\u641C\u7D22\u5173\u952E\u8BCD\u3002\u53EF\u4EE5\u641C\u7D22\u6240\u6709 Markdown \u6587\u4EF6\u7684\u5185\u5BB9\u548C\u6807\u9898\uFF0C\u652F\u6301\u591A\u5173\u952E\u8BCD\u641C\u7D22\u3002",
    parameters: {
      type: "object",
      properties: {
        query: {
          type: "string",
          description: '\u641C\u7D22\u5173\u952E\u8BCD\uFF0C\u4F8B\u5982\uFF1A"Python \u7F16\u7A0B" \u6216 "\u4EBA\u5DE5\u667A\u80FD"'
        },
        limit: {
          type: "number",
          description: "\u6700\u5927\u8FD4\u56DE\u7ED3\u679C\u6570\u91CF\uFF0C\u9ED8\u8BA4 20",
          default: 20
        }
      },
      required: ["query"]
    }
  }
};

// src/utils/tools/web_fetch_tool.ts
var webFetchTool = {
  type: "function",
  function: {
    name: "web_fetch",
    description: "\u83B7\u53D6\u6307\u5B9A URL \u7684\u7F51\u9875\u5185\u5BB9\u3002\u53EF\u4EE5\u8BFB\u53D6\u7F51\u9875\u7684\u5B8C\u6574\u5185\u5BB9\uFF0C\u652F\u6301\u8F6C\u6362\u4E3A Markdown \u6216\u7EAF\u6587\u672C\u683C\u5F0F\u3002\u9002\u7528\u4E8E\u8BFB\u53D6\u6587\u7AE0\u3001\u6587\u6863\u7B49\u7F51\u9875\u5185\u5BB9\u3002",
    parameters: {
      type: "object",
      properties: {
        url: {
          type: "string",
          description: '\u8981\u6293\u53D6\u7684\u7F51\u9875 URL\uFF0C\u4F8B\u5982\uFF1A"https://example.com/article"'
        },
        returnFormat: {
          type: "string",
          description: "\u8FD4\u56DE\u683C\u5F0F\uFF1Amarkdown\uFF08\u9ED8\u8BA4\uFF09\u6216 text",
          enum: ["markdown", "text"],
          default: "markdown"
        }
      },
      required: ["url"]
    }
  }
};

// src/utils/tools/obsidian_open_file_tool.ts
var obsidianOpenFileTool = {
  type: "function",
  function: {
    name: "obsidian_open_file",
    description: "\u5728 Obsidian \u4E2D\u6253\u5F00\u6307\u5B9A\u7684\u7B14\u8BB0\u6587\u4EF6\u3002\u53EF\u4EE5\u7528\u4E8E\u5F15\u5BFC\u7528\u6237\u67E5\u770B\u67D0\u4E2A\u7279\u5B9A\u7684\u7B14\u8BB0\u6216\u6587\u6863\u3002",
    parameters: {
      type: "object",
      properties: {
        path: {
          type: "string",
          description: '\u7B14\u8BB0\u7684\u76F8\u5BF9\u8DEF\u5F84\u6216\u6587\u4EF6\u540D\uFF0C\u4F8B\u5982\uFF1A"\u6211\u7684\u7B14\u8BB0.md" \u6216 "\u6587\u4EF6\u5939/\u5B50\u7B14\u8BB0.md"'
        }
      },
      required: ["path"]
    }
  }
};

// src/utils/tools/memory_create_entities_tool.ts
var createEntitiesTool = {
  type: "function",
  function: {
    name: "memory_create_entities",
    description: "\u5728\u77E5\u8BC6\u56FE\u8C31\u4E2D\u521B\u5EFA\u65B0\u7684\u5B9E\u4F53\u3002\u53EF\u4EE5\u521B\u5EFA\u4EBA\u7269\u3001\u6982\u5FF5\u3001\u4E8B\u4EF6\u3001\u5730\u70B9\u7B49\u7C7B\u578B\u7684\u5B9E\u4F53\uFF0C\u5E76\u6DFB\u52A0\u89C2\u5BDF\u8BB0\u5F55\u3002\u652F\u6301\u6279\u91CF\u521B\u5EFA\u3002",
    parameters: {
      type: "object",
      properties: {
        entities: {
          type: "array",
          description: "\u8981\u521B\u5EFA\u7684\u5B9E\u4F53\u5217\u8868",
          items: {
            type: "object",
            properties: {
              name: {
                type: "string",
                description: '\u5B9E\u4F53\u540D\u79F0\uFF0C\u4F8B\u5982\uFF1A"\u5F20\u4E09"\u3001"Python\u7F16\u7A0B"\u3001"2024\u5E74AI\u5CF0\u4F1A"'
              },
              entityType: {
                type: "string",
                description: '\u5B9E\u4F53\u7C7B\u578B\uFF0C\u4F8B\u5982\uFF1A"\u4EBA\u7269"\u3001"\u6280\u672F\u6982\u5FF5"\u3001"\u4E8B\u4EF6"\u3001"\u5730\u70B9"\u3001"\u7EC4\u7EC7"'
              },
              observations: {
                type: "array",
                description: "\u5173\u4E8E\u8BE5\u5B9E\u4F53\u7684\u89C2\u5BDF\u8BB0\u5F55\u5217\u8868\uFF08\u53EF\u9009\uFF09",
                items: {
                  type: "string"
                }
              }
            },
            required: ["name", "entityType"]
          }
        }
      },
      required: ["entities"]
    }
  }
};

// src/utils/tools/memory_add_observations_tool.ts
var addObservationsTool = {
  type: "function",
  function: {
    name: "memory_add_observations",
    description: "\u4E3A\u5DF2\u6709\u5B9E\u4F53\u6DFB\u52A0\u65B0\u7684\u89C2\u5BDF\u8BB0\u5F55\u3002\u7528\u4E8E\u8865\u5145\u5B9E\u4F53\u4FE1\u606F\u3001\u66F4\u65B0\u5B9E\u4F53\u72B6\u6001\u6216\u8BB0\u5F55\u65B0\u53D1\u73B0\u3002\u652F\u6301\u6279\u91CF\u6DFB\u52A0\u3002",
    parameters: {
      type: "object",
      properties: {
        observations: {
          type: "array",
          description: "\u89C2\u5BDF\u8BB0\u5F55\u5217\u8868",
          items: {
            type: "object",
            properties: {
              entityName: {
                type: "string",
                description: "\u5B9E\u4F53\u540D\u79F0\uFF0C\u5FC5\u987B\u662F\u5DF2\u5B58\u5728\u7684\u5B9E\u4F53"
              },
              content: {
                type: "string",
                description: "\u89C2\u5BDF\u5185\u5BB9\uFF0C\u63CF\u8FF0\u5173\u4E8E\u8BE5\u5B9E\u4F53\u7684\u65B0\u4FE1\u606F\u6216\u53D1\u73B0"
              }
            },
            required: ["entityName", "content"]
          }
        }
      },
      required: ["observations"]
    }
  }
};

// src/utils/tools/memory_create_relations_tool.ts
var createRelationsTool = {
  type: "function",
  function: {
    name: "memory_create_relations",
    description: "\u5728\u5B9E\u4F53\u4E4B\u95F4\u521B\u5EFA\u5173\u7CFB\u3002\u7528\u4E8E\u8868\u8FBE\u5B9E\u4F53\u95F4\u7684\u8054\u7CFB\uFF0C\u5982\u4EBA\u7269\u5173\u7CFB\u3001\u4ECE\u5C5E\u5173\u7CFB\u3001\u56E0\u679C\u5173\u7CFB\u7B49\u3002\u652F\u6301\u6279\u91CF\u521B\u5EFA\u3002",
    parameters: {
      type: "object",
      properties: {
        relations: {
          type: "array",
          description: "\u5173\u7CFB\u5217\u8868",
          items: {
            type: "object",
            properties: {
              from: {
                type: "string",
                description: "\u6E90\u5B9E\u4F53\u540D\u79F0"
              },
              to: {
                type: "string",
                description: "\u76EE\u6807\u5B9E\u4F53\u540D\u79F0"
              },
              relationType: {
                type: "string",
                description: '\u5173\u7CFB\u7C7B\u578B\uFF0C\u4F8B\u5982\uFF1A"\u8BA4\u8BC6"\u3001"\u5C5E\u4E8E"\u3001"\u5F71\u54CD"\u3001"\u4F4D\u4E8E"\u3001"\u521B\u5EFA"'
              }
            },
            required: ["from", "to", "relationType"]
          }
        },
        autoCreateEntities: {
          type: "boolean",
          description: "\u662F\u5426\u81EA\u52A8\u521B\u5EFA\u7F3A\u5931\u7684\u5B9E\u4F53\uFF08\u9ED8\u8BA4 false\uFF09",
          default: false
        }
      },
      required: ["relations"]
    }
  }
};

// src/utils/tools/memory_search_nodes_tool.ts
var searchNodesTool = {
  type: "function",
  function: {
    name: "memory_search_nodes",
    description: "\u5728\u77E5\u8BC6\u56FE\u8C31\u4E2D\u8FDB\u884C\u5173\u952E\u8BCD\u7CBE\u786E\u641C\u7D22\u3002\u5728\u5B9E\u4F53\u540D\u79F0\u3001\u7C7B\u578B\u3001\u89C2\u5BDF\u8BB0\u5F55\u4E2D\u5339\u914D\u5305\u542B\u6307\u5B9A\u5173\u952E\u8BCD\u7684\u5185\u5BB9\u3002\u652F\u6301\u591A\u5173\u952E\u8BCD\u641C\u7D22\uFF08\u7A7A\u683C\u5206\u9694\u8868\u793A AND \u5173\u7CFB\uFF09\u3002",
    parameters: {
      type: "object",
      properties: {
        query: {
          type: "string",
          description: '\u641C\u7D22\u5173\u952E\u8BCD\u3002\u652F\u6301\u591A\u5173\u952E\u8BCD\uFF0C\u7A7A\u683C\u5206\u9694\u8868\u793A AND \u5173\u7CFB\u3002\u4F8B\u5982\uFF1A"Python \u7F16\u7A0B" \u4F1A\u641C\u7D22\u540C\u65F6\u5305\u542B Python \u548C\u7F16\u7A0B\u7684\u5B9E\u4F53'
        }
      },
      required: ["query"]
    }
  }
};

// src/utils/tools/memory_semantic_search_tool.ts
var semanticSearchTool = {
  type: "function",
  function: {
    name: "memory_semantic_search",
    description: "\u57FA\u4E8E\u8BED\u4E49\u76F8\u4F3C\u5EA6\u641C\u7D22\u77E5\u8BC6\u56FE\u8C31\u3002\u4F7F\u7528\u5411\u91CF\u627E\u51FA\u4E0E\u67E5\u8BE2\u8BED\u4E49\u76F8\u5173\u7684\u5B9E\u4F53\uFF0C\u9002\u5408\u6A21\u7CCA\u641C\u7D22\u548C\u6982\u5FF5\u5173\u8054\u3002\u6BD4\u5173\u952E\u8BCD\u641C\u7D22\u66F4\u667A\u80FD\uFF0C\u80FD\u7406\u89E3\u8BED\u4E49\u3002",
    parameters: {
      type: "object",
      properties: {
        query: {
          type: "string",
          description: '\u641C\u7D22\u67E5\u8BE2\uFF0C\u53EF\u4EE5\u662F\u95EE\u9898\u3001\u63CF\u8FF0\u6216\u6982\u5FF5\u3002\u4F8B\u5982\uFF1A"\u5982\u4F55\u5B66\u4E60\u7F16\u7A0B"\u3001"\u4EBA\u5DE5\u667A\u80FD\u76F8\u5173\u6280\u672F"'
        },
        limit: {
          type: "integer",
          description: "\u8FD4\u56DE\u7ED3\u679C\u6570\u91CF\u9650\u5236\uFF0C\u9ED8\u8BA4 10",
          default: 10
        }
      },
      required: ["query"]
    }
  }
};

// src/utils/tools/memory_read_graph_tool.ts
var readGraphTool = {
  type: "function",
  function: {
    name: "memory_read_graph",
    description: "\u8BFB\u53D6\u5B8C\u6574\u7684\u77E5\u8BC6\u56FE\u8C31\u3002\u652F\u6301\u5206\u9875\u8BFB\u53D6\uFF0C\u907F\u514D\u4E00\u6B21\u6027\u8FD4\u56DE\u8FC7\u591A\u6570\u636E\u3002\u5EFA\u8BAE\u4F7F\u7528\u5206\u9875\u53C2\u6570\u63A7\u5236\u6570\u636E\u91CF\u3002",
    parameters: {
      type: "object",
      properties: {
        limit: {
          type: "integer",
          description: "\u8FD4\u56DE\u7684\u5B9E\u4F53\u6570\u91CF\u9650\u5236\u3002\u5EFA\u8BAE\u4F7F\u7528 20 \u907F\u514D token \u8FC7\u591A"
        },
        offset: {
          type: "integer",
          description: "\u504F\u79FB\u91CF\uFF0C\u7528\u4E8E\u5206\u9875\u3002\u9ED8\u8BA4 0",
          default: 0
        }
      }
    }
  }
};

// src/utils/tools/memory_open_nodes_tool.ts
var openNodesTool = {
  type: "function",
  function: {
    name: "memory_open_nodes",
    description: "\u6309\u540D\u79F0\u7CBE\u786E\u68C0\u7D22\u7279\u5B9A\u8282\u70B9\u3002\u8FD4\u56DE\u6307\u5B9A\u540D\u79F0\u7684\u5B9E\u4F53\u53CA\u5176\u6240\u6709\u5173\u7CFB\u4FE1\u606F\uFF0C\u5305\u62EC\u5173\u8054\u7684\u5176\u4ED6\u5B9E\u4F53\u3002",
    parameters: {
      type: "object",
      properties: {
        names: {
          type: "array",
          description: "\u5B9E\u4F53\u540D\u79F0\u5217\u8868",
          items: {
            type: "string"
          }
        }
      },
      required: ["names"]
    }
  }
};

// src/utils/tools/memory_delete_entities_tool.ts
var deleteEntitiesTool = {
  type: "function",
  function: {
    name: "memory_delete_entities",
    description: "\u903B\u8F91\u5220\u9664\u5B9E\u4F53\u53CA\u5176\u5173\u8054\u5173\u7CFB\uFF08\u79FB\u81F3\u56DE\u6536\u7AD9\uFF09\u3002\u6CE8\u610F\uFF1A\u8FD9\u662F\u903B\u8F91\u5220\u9664\uFF0C\u4E0D\u4F1A\u7269\u7406\u5220\u9664\u6570\u636E\uFF0C\u53EF\u4EE5\u901A\u8FC7\u56DE\u6536\u7AD9\u6062\u590D\u3002",
    parameters: {
      type: "object",
      properties: {
        entityNames: {
          type: "array",
          description: "\u8981\u5220\u9664\u7684\u5B9E\u4F53\u540D\u79F0\u5217\u8868",
          items: {
            type: "string"
          }
        }
      },
      required: ["entityNames"]
    }
  }
};

// src/utils/tools/memory_delete_observations_tool.ts
var deleteObservationsTool = {
  type: "function",
  function: {
    name: "memory_delete_observations",
    description: "\u903B\u8F91\u5220\u9664\u5B9E\u4F53\u7684\u7279\u5B9A\u89C2\u5BDF\u8BB0\u5F55\uFF08\u79FB\u81F3\u56DE\u6536\u7AD9\uFF09\u3002\u6CE8\u610F\uFF1A\u8FD9\u662F\u903B\u8F91\u5220\u9664\uFF0C\u4E0D\u4F1A\u7269\u7406\u5220\u9664\u6570\u636E\uFF0C\u53EF\u4EE5\u901A\u8FC7\u56DE\u6536\u7AD9\u6062\u590D\u3002",
    parameters: {
      type: "object",
      properties: {
        deletions: {
          type: "array",
          description: "\u5220\u9664\u5217\u8868",
          items: {
            type: "object",
            properties: {
              entityName: {
                type: "string",
                description: "\u5B9E\u4F53\u540D\u79F0"
              },
              observations: {
                type: "array",
                description: "\u8981\u5220\u9664\u7684\u89C2\u5BDF\u5185\u5BB9\u5217\u8868",
                items: {
                  type: "string"
                }
              }
            },
            required: ["entityName", "observations"]
          }
        }
      },
      required: ["deletions"]
    }
  }
};

// src/utils/tools/memory_delete_relations_tool.ts
var deleteRelationsTool = {
  type: "function",
  function: {
    name: "memory_delete_relations",
    description: "\u5220\u9664\u77E5\u8BC6\u56FE\u8C31\u4E2D\u7684\u7279\u5B9A\u5173\u7CFB\u3002\u6CE8\u610F\uFF1A\u8FD9\u662F\u903B\u8F91\u5220\u9664\uFF0C\u4E0D\u4F1A\u7269\u7406\u5220\u9664\u6570\u636E\u3002",
    parameters: {
      type: "object",
      properties: {
        relations: {
          type: "array",
          description: "\u8981\u5220\u9664\u7684\u5173\u7CFB\u5217\u8868",
          items: {
            type: "object",
            properties: {
              from: {
                type: "string",
                description: "\u6E90\u5B9E\u4F53\u540D\u79F0"
              },
              to: {
                type: "string",
                description: "\u76EE\u6807\u5B9E\u4F53\u540D\u79F0"
              },
              relationType: {
                type: "string",
                description: "\u5173\u7CFB\u7C7B\u578B"
              }
            },
            required: ["from", "to", "relationType"]
          }
        }
      },
      required: ["relations"]
    }
  }
};

// src/utils/tools/memory_generate_embeddings_tool.ts
var generateEmbeddingsTool = {
  type: "function",
  function: {
    name: "memory_generate_embeddings",
    description: "\u4E3A\u5B9E\u4F53\u751F\u6210\u5411\u91CF\uFF08\u7528\u4E8E\u8BED\u4E49\u641C\u7D22\uFF09\u3002\u53EF\u4EE5\u4E3A\u6307\u5B9A\u5B9E\u4F53\u751F\u6210\u5411\u91CF\uFF0C\u6216\u81EA\u52A8\u5904\u7406\u7F3A\u5931\u5411\u91CF\u7684\u5B9E\u4F53\u3002",
    parameters: {
      type: "object",
      properties: {
        entityNames: {
          type: "array",
          description: "\u6307\u5B9A\u5B9E\u4F53\u540D\u79F0\u5217\u8868\u3002\u5982\u679C\u4E3A\u7A7A\uFF0C\u5219\u5904\u7406\u7F3A\u5931\u5411\u91CF\u7684\u5B9E\u4F53",
          items: {
            type: "string"
          }
        },
        limit: {
          type: "integer",
          description: "\u5904\u7406\u6570\u91CF\u9650\u5236\uFF08\u4EC5\u5F53 entityNames \u4E3A\u7A7A\u65F6\u751F\u6548\uFF09\uFF0C\u9ED8\u8BA4 20",
          default: 20
        }
      }
    }
  }
};

// src/utils/tools/memory_view_trash_tool.ts
var viewTrashTool = {
  type: "function",
  function: {
    name: "memory_view_trash",
    description: "\u67E5\u770B\u56DE\u6536\u7AD9\u4E2D\u5DF2\u5220\u9664\u7684\u5185\u5BB9\uFF0C\u5305\u62EC\u5B9E\u4F53\u548C\u89C2\u5BDF\u8BB0\u5F55\u3002\u652F\u6301\u5206\u9875\u67E5\u770B\u3002",
    parameters: {
      type: "object",
      properties: {
        limit: {
          type: "integer",
          description: "\u8FD4\u56DE\u7684\u5B9E\u4F53\u6570\u91CF\u9650\u5236\uFF0C\u9ED8\u8BA4 20",
          default: 20
        },
        offset: {
          type: "integer",
          description: "\u504F\u79FB\u91CF\uFF0C\u7528\u4E8E\u5206\u9875\u3002\u9ED8\u8BA4 0",
          default: 0
        }
      }
    }
  }
};

// src/utils/tools/memory_restore_deleted_tool.ts
var restoreDeletedTool = {
  type: "function",
  function: {
    name: "memory_restore_deleted",
    description: "\u4ECE\u56DE\u6536\u7AD9\u6062\u590D\u5DF2\u5220\u9664\u7684\u8BB0\u5FC6\u3002\u6062\u590D\u540E\uFF0C\u5B9E\u4F53\u6216\u89C2\u5BDF\u8BB0\u5F55\u5C06\u91CD\u65B0\u51FA\u73B0\u5728\u641C\u7D22\u7ED3\u679C\u4E2D\u3002",
    parameters: {
      type: "object",
      properties: {
        entityNames: {
          type: "array",
          description: "\u8981\u6062\u590D\u7684\u5B9E\u4F53\u540D\u79F0\u5217\u8868\uFF08\u53EF\u9009\uFF09",
          items: {
            type: "string"
          }
        },
        observations: {
          type: "array",
          description: "\u8981\u6062\u590D\u7684\u89C2\u5BDF\u8BB0\u5F55\u5217\u8868\uFF08\u53EF\u9009\uFF09",
          items: {
            type: "object",
            properties: {
              entityName: {
                type: "string",
                description: "\u5B9E\u4F53\u540D\u79F0"
              },
              content: {
                type: "string",
                description: "\u89C2\u5BDF\u5185\u5BB9"
              }
            },
            required: ["entityName", "content"]
          }
        }
      }
    }
  }
};

// src/utils/tools/tool_definitions.ts
function getAvailableTools(enableWebSearch, hasContextDoc = false, enableMemoryGraph = true) {
  const tools = [];
  tools.push(updateChatTitleTool);
  if (enableWebSearch) {
    tools.push(whoogleSearchTool);
  }
  if (hasContextDoc) {
    tools.push(readDocTool);
  }
  tools.push(obsidianGlobalSearchTool);
  tools.push(webFetchTool);
  tools.push(obsidianOpenFileTool);
  if (enableMemoryGraph) {
    tools.push(createEntitiesTool);
    tools.push(addObservationsTool);
    tools.push(createRelationsTool);
    tools.push(searchNodesTool);
    tools.push(semanticSearchTool);
    tools.push(readGraphTool);
    tools.push(openNodesTool);
    tools.push(deleteEntitiesTool);
    tools.push(deleteObservationsTool);
    tools.push(deleteRelationsTool);
    tools.push(generateEmbeddingsTool);
    tools.push(viewTrashTool);
    tools.push(restoreDeletedTool);
  }
  console.log(
    "[Tool Definitions] \u53EF\u7528\u5DE5\u5177\u6570\u91CF:",
    tools.length,
    "| \u8054\u7F51\u641C\u7D22:",
    enableWebSearch,
    "| \u6587\u6863\u8BFB\u53D6:",
    hasContextDoc,
    "| \u8BB0\u5FC6\u56FE\u8C31:",
    enableMemoryGraph
  );
  return tools;
}
__name(getAvailableTools, "getAvailableTools");

// src/utils/chat/response_filter.ts
function isNoiseResponse(message, toolResults) {
  if (!message || message.trim() === "") {
    return true;
  }
  const trimmedMessage = message.trim();
  const lowerMessage = trimmedMessage.toLowerCase();
  const toolCallPatterns = [
    /^(好的|ok|收到)[，,。！!]*$/i,
    /^(正在|开始|已经)(调用|执行|使用).*(工具|tool)[，,。！!]*$/i,
    /^(工具|tool).*(调用|执行)(成功|完成)[，,。！!]*$/i,
    /^(已|正在)(搜索|查询|检索)[，,。！!]*$/i
  ];
  if (toolCallPatterns.some((pattern) => pattern.test(trimmedMessage))) {
    return true;
  }
  if (trimmedMessage.length < 10) {
    const meaningfulShortPatterns = [
      /\d+/,
      // 包含数字
      /https?:\/\//,
      // 包含链接
      /```/
      // 包含代码块
    ];
    if (!meaningfulShortPatterns.some((pattern) => pattern.test(trimmedMessage))) {
      return true;
    }
  }
  if (toolResults && toolResults.length > 0) {
    const toolNames = toolResults.map((r) => r.toolName).filter(Boolean);
    const isOnlyToolName = toolNames.some(
      (name) => trimmedMessage === name || lowerMessage === name.toLowerCase()
    );
    if (isOnlyToolName) {
      return true;
    }
  }
  const emojiOnlyPattern = /^[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\s]+$/u;
  if (emojiOnlyPattern.test(trimmedMessage)) {
    return true;
  }
  const noiseIntroPatterns = [
    /^(我|已经|正在)(读取|获取|查看|分析|检索|搜索)(了|到)?[，,。！!]*$/i,
    /^(让我|我来)(看看|查看|分析|检索|搜索)[，,。！!]*$/i,
    /^(查询|搜索|分析)(中|完成)[，,。！!]*$/i
  ];
  if (noiseIntroPatterns.some((pattern) => pattern.test(trimmedMessage))) {
    return true;
  }
  if (toolResults && toolResults.length > 0) {
    const toolResultTexts = toolResults.map((r) => r.displayText || JSON.stringify(r.result)).filter(Boolean);
    let matchedLength = 0;
    for (const resultText of toolResultTexts) {
      if (trimmedMessage.includes(resultText)) {
        matchedLength += resultText.length;
      }
    }
    const matchRatio = matchedLength / trimmedMessage.length;
    if (matchRatio > 0.9) {
      return true;
    }
  }
  return false;
}
__name(isNoiseResponse, "isNoiseResponse");
function hasSubstantiveAnalysis(message) {
  if (!message || message.trim() === "") {
    return false;
  }
  const lowerMessage = message.toLowerCase();
  const analyticalKeywords = [
    "\u56E0\u4E3A",
    "\u6240\u4EE5",
    "\u56E0\u6B64",
    "\u5BFC\u81F4",
    "\u8BF4\u660E",
    "\u8868\u660E",
    "\u5206\u6790",
    "\u603B\u7ED3",
    "\u5EFA\u8BAE",
    "\u63A8\u8350",
    "\u5E94\u8BE5",
    "\u53EF\u4EE5",
    "\u610F\u5473\u7740",
    "\u663E\u793A",
    "\u8BC1\u660E",
    "\u53CD\u6620",
    "\u63ED\u793A",
    "\u9996\u5148",
    "\u5176\u6B21",
    "\u53E6\u5916",
    "\u6B64\u5916",
    "\u540C\u65F6",
    "\u4F18\u70B9",
    "\u7F3A\u70B9",
    "\u4F18\u52BF",
    "\u52A3\u52BF",
    "\u95EE\u9898",
    "\u89E3\u51B3",
    "\u4E0D\u540C",
    "\u76F8\u540C",
    "\u6BD4\u8F83",
    "\u5BF9\u6BD4",
    "\u533A\u522B"
  ];
  const hasAnalysis = analyticalKeywords.some((keyword) => lowerMessage.includes(keyword));
  const hasStructure = /[-*]\s|\d+\.\s|#\s/.test(message);
  const hasCodeOrQuote = /```|>/.test(message);
  const isLongEnough = message.trim().length > 50;
  return hasAnalysis || hasStructure || hasCodeOrQuote || isLongEnough && !isNoiseResponse(message);
}
__name(hasSubstantiveAnalysis, "hasSubstantiveAnalysis");

// src/utils/chat/chat_controller.ts
var import_obsidian11 = require("obsidian");
var _ChatController = class _ChatController {
  // 输入法输入状态标志
  constructor(state, ui, dependencies, initialWebSearchEnabled = false) {
    __publicField(this, "state");
    __publicField(this, "ui");
    __publicField(this, "dependencies");
    __publicField(this, "toolHandler");
    __publicField(this, "initialWebSearchEnabled");
    __publicField(this, "isComposing", false);
    this.state = state;
    this.ui = ui;
    this.dependencies = dependencies;
    this.toolHandler = new ChatToolHandler(dependencies.toolExecutor, ui);
    this.initialWebSearchEnabled = initialWebSearchEnabled;
    this.dependencies.toolExecutor.setUpdateTitleCallback((title) => {
      this.state.setTitle(title);
      this.ui.updateTitle(title);
    });
    this.dependencies.toolExecutor.setReadDocCallback(async () => {
      const contextFile = this.state.getContextFile();
      if (!contextFile) {
        throw new Error("\u6CA1\u6709\u53EF\u8BFB\u53D6\u7684\u6587\u6863");
      }
      return contextFile.content;
    });
    this.dependencies.toolExecutor.setGlobalSearchCallback(async (query, limit) => {
      const allFiles = this.dependencies.app.vault.getMarkdownFiles();
      const matchedFiles = allFiles.filter((file) => {
        const lowerPath = file.path.toLowerCase();
        const lowerQuery = query.toLowerCase();
        return lowerPath.includes(lowerQuery);
      });
      const limitedResults = matchedFiles.slice(0, limit);
      const searchResults = limitedResults.map((file) => ({
        title: file.basename,
        // 文件名（不含扩展名）
        url: `obsidian://open?vault=${encodeURIComponent(this.dependencies.app.vault.getName())}&file=${encodeURIComponent(file.path)}`,
        path: file.path,
        name: file.name
      }));
      return { results: searchResults };
    });
    this.dependencies.toolExecutor.setOpenFileCallback(async (path) => {
      const file = this.dependencies.app.vault.getAbstractFileByPath(path);
      if (file instanceof import_obsidian11.TFile) {
        await this.dependencies.app.workspace.getLeaf(false).openFile(file);
      } else {
        throw new Error(`\u6587\u4EF6\u4E0D\u5B58\u5728: ${path}`);
      }
    });
    this.setupEventListeners();
  }
  /**
   * 设置事件监听器
   */
  setupEventListeners() {
    this.ui.getUI().sendButton.addEventListener("click", () => {
      this.handleSendOrStop();
    });
    this.ui.getUI().input.addEventListener("compositionstart", () => {
      this.isComposing = true;
    });
    this.ui.getUI().input.addEventListener("compositionend", () => {
      this.isComposing = false;
    });
    this.ui.getUI().input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !this.isComposing) {
        e.preventDefault();
        this.handleSendOrStop();
      }
    });
    this.ui.getUI().searchButton.addEventListener("click", () => {
      this.handleToggleSearch();
    });
    const newChatButton = this.ui.getUI().toolbar.querySelector(".ai-chat-toolbar-button:nth-child(1)");
    newChatButton == null ? void 0 : newChatButton.addEventListener("click", () => {
      this.handleNewChat();
    });
    const historyButton = this.ui.getUI().toolbar.querySelector(".ai-chat-toolbar-button:nth-child(2)");
    historyButton == null ? void 0 : historyButton.addEventListener("click", () => {
      this.handleViewHistory();
    });
    this.ui.getUI().title.addEventListener("click", () => {
      this.handleEditTitle();
    });
    this.updateContextFileUI();
  }
  /**
   * 处理发送或停止
   */
  async handleSendOrStop() {
    if (this.state.getIsGenerating()) {
      await this.handleStopGeneration();
    } else {
      await this.handleSendMessage();
    }
  }
  /**
   * 处理发送消息
   */
  async handleSendMessage() {
    const message = this.ui.getInputValue();
    if (!message) {
      new import_obsidian11.Notice("\u8BF7\u8F93\u5165\u6D88\u606F\u5185\u5BB9");
      return;
    }
    if (!this.dependencies.llmClient) {
      new import_obsidian11.Notice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6ELLM API");
      return;
    }
    console.log("[Chat Controller] \u53D1\u9001\u6D88\u606F:", message, "\u8054\u7F51\u641C\u7D22:", this.state.isWebSearchEnabled());
    const abortController = new AbortController();
    this.state.setGenerating(true, abortController);
    this.ui.updateSendButtonState(true);
    this.dependencies.llmClient.setAbortController(abortController);
    this.ui.setInputDisabled(true);
    const thinkingDiv = this.ui.createThinkingIndicator();
    try {
      this.ui.addMessage("user", message);
      let messageToSend = message;
      const contextFile = this.state.getContextFile();
      if (contextFile) {
        messageToSend = `[\u7CFB\u7EDF\u63D0\u793A\uFF1A\u5F53\u524D\u6253\u5F00\u4E86\u6587\u6863 "${contextFile.name}"\uFF0C\u4F60\u53EF\u4EE5\u4F7F\u7528 read_doc \u5DE5\u5177\u6765\u8BFB\u53D6\u5B8C\u6574\u5185\u5BB9]

${message}`;
        console.log("[Chat Controller] \u5DF2\u6DFB\u52A0\u6587\u6863\u63D0\u793A:", contextFile.name);
      }
      this.state.addMessage({ role: "user", content: messageToSend });
      this.ui.clearInput();
      const tools = getAvailableTools(
        this.state.isWebSearchEnabled(),
        this.state.hasContextFile()
      );
      console.log("[Chat Controller] \u53EF\u7528\u5DE5\u5177\u6570\u91CF:", tools.length);
      thinkingDiv.remove();
      const streamingMsg = this.ui.createStreamingMessage("assistant");
      console.log("[Chat Controller] \u8C03\u7528LLM API (\u6D41\u5F0F)\uFF0C\u6D88\u606F\u5386\u53F2\u957F\u5EA6:", this.state.getMessages().length);
      const response = await this.dependencies.llmClient.sendMessageStream(
        this.state.getMessages(),
        tools,
        async (chunk) => {
          if (abortController.signal.aborted) {
            return;
          }
          if (chunk.type === "text" && chunk.content) {
            await this.ui.updateStreamingMessage(
              streamingMsg.contentDiv,
              streamingMsg.buffer,
              chunk.content
            );
          }
        }
      );
      if (abortController.signal.aborted) {
        console.log("[Chat Controller] \u8BF7\u6C42\u5DF2\u88AB\u4E2D\u6B62");
        return;
      }
      if (response.success && response.toolCalls && response.toolCalls.length > 0) {
        console.log("[Chat Controller] \u2713 AI \u8BF7\u6C42\u8C03\u7528\u5DE5\u5177\uFF0C\u6570\u91CF:", response.toolCalls.length);
        if (response.message && response.message.trim()) {
          if (streamingMsg.buffer.text === "") {
            await this.ui.updateStreamingMessage(
              streamingMsg.contentDiv,
              streamingMsg.buffer,
              response.message
            );
          }
          console.log("[Chat Controller] \u2713 \u5DF2\u663E\u793A AI \u7684\u6587\u672C\u5185\u5BB9:", response.message.substring(0, 50) + "...");
        } else {
          streamingMsg.messageDiv.remove();
        }
        await this.handleToolCalls(response.toolCalls, tools);
      } else if (response.success && response.message && response.message.trim()) {
        if (streamingMsg.buffer.text === "") {
          await this.ui.updateStreamingMessage(
            streamingMsg.contentDiv,
            streamingMsg.buffer,
            response.message
          );
        }
        this.state.addMessage({ role: "assistant", content: response.message });
        console.log("[Chat Controller] \u2713 \u6536\u5230AI\u56DE\u590D\uFF0C\u5F53\u524D\u5BF9\u8BDD\u5386\u53F2\u957F\u5EA6:", this.state.getMessages().length);
      } else {
        const errorMessage = response.error || "API\u8FD4\u56DE\u4E86\u7A7A\u54CD\u5E94\uFF0C\u53EF\u80FD\u662F\u7531\u4E8E\u5185\u5BB9\u8FC7\u6EE4\u3001\u5B89\u5168\u9650\u5236\u6216\u5176\u4ED6\u539F\u56E0";
        console.error("[Chat Controller] \u2717 LLM API\u8FD4\u56DE\u9519\u8BEF:", errorMessage);
        new import_obsidian11.Notice(`AI\u56DE\u590D\u5931\u8D25: ${errorMessage}`);
        streamingMsg.messageDiv.remove();
        this.state.removeLastMessage();
        this.ui.addMessage("assistant", `\u62B1\u6B49\uFF0C\u6211\u9047\u5230\u4E86\u4E00\u4E9B\u95EE\u9898\uFF1A${errorMessage}`);
      }
    } catch (error) {
      console.error("[Chat Controller] \u2717 \u53D1\u9001\u6D88\u606F\u5F02\u5E38:", error);
      if (abortController.signal.aborted) {
        console.log("[Chat Controller] \u2713 \u5DF2\u505C\u6B62\u751F\u6210");
        this.ui.addMessage("assistant", "\u23F8 \u5DF2\u505C\u6B62\u751F\u6210");
      } else {
        new import_obsidian11.Notice(`\u53D1\u9001\u5931\u8D25: ${error.message}`);
        thinkingDiv.remove();
        if (this.state.getMessages().length > 0 && this.state.getMessages()[this.state.getMessages().length - 1].role === "user") {
          this.state.removeLastMessage();
        }
        this.ui.addMessage("assistant", `\u62B1\u6B49\uFF0C\u53D1\u751F\u4E86\u9519\u8BEF\uFF1A${error.message}`);
      }
    } finally {
      this.state.setGenerating(false, null);
      if (this.dependencies.llmClient) {
        this.dependencies.llmClient.setAbortController(null);
      }
      this.ui.updateSendButtonState(false);
      this.ui.setInputDisabled(false);
      this.ui.focusInput();
    }
  }
  /**
   * 处理停止生成
   */
  async handleStopGeneration() {
    console.log("[Chat Controller] \u7528\u6237\u8BF7\u6C42\u505C\u6B62\u751F\u6210");
    const abortController = this.state.getAbortController();
    if (abortController) {
      abortController.abort();
      new import_obsidian11.Notice("\u6B63\u5728\u505C\u6B62...");
    }
  }
  /**
   * 处理工具调用
   */
  async handleToolCalls(toolCalls, tools) {
    const { success, results } = await this.toolHandler.handleToolCalls(toolCalls);
    this.state.addMessage({
      role: "assistant",
      content: "",
      toolCalls
    });
    for (let i = 0; i < results.length; i++) {
      const result = results[i];
      const toolCall = toolCalls[i];
      let toolResultContent;
      if (result.success) {
        toolResultContent = JSON.stringify(result.result || { status: "success", message: result.displayText });
      } else {
        toolResultContent = JSON.stringify({
          status: "error",
          error: result.error,
          message: `\u5DE5\u5177 ${result.toolName} \u6267\u884C\u5931\u8D25: ${result.error}`
        });
      }
      this.state.addMessage({
        role: "tool",
        content: toolResultContent,
        toolCallId: toolCall.id,
        toolName: toolCall.function.name
      });
    }
    console.log("[Chat Controller] \u57FA\u4E8E\u5DE5\u5177\u7ED3\u679C\u518D\u6B21\u8BF7\u6C42 AI");
    const finalResponse = await this.dependencies.llmClient.sendMessage(this.state.getMessages(), tools);
    if (finalResponse.success && finalResponse.toolCalls && finalResponse.toolCalls.length > 0) {
      console.log("[Chat Controller] \u2713 AI \u518D\u6B21\u8BF7\u6C42\u8C03\u7528\u5DE5\u5177\uFF0C\u6570\u91CF:", finalResponse.toolCalls.length);
      if (finalResponse.message && finalResponse.message.trim()) {
        if (!isNoiseResponse(finalResponse.message, results)) {
          await this.ui.addMarkdownMessage("assistant", finalResponse.message);
          console.log("[Chat Controller] \u2713 \u5DF2\u663E\u793A AI \u7684\u6587\u672C\u5185\u5BB9");
        } else {
          console.log("[Chat Controller] \u2298 \u8FC7\u6EE4\u65E0\u610F\u4E49\u56DE\u590D:", finalResponse.message.substring(0, 50));
        }
      }
      await this.handleToolCalls(finalResponse.toolCalls, tools);
    } else if (finalResponse.success && finalResponse.message) {
      if (!isNoiseResponse(finalResponse.message, results)) {
        await this.ui.addMarkdownMessage("assistant", finalResponse.message);
        this.state.addMessage({ role: "assistant", content: finalResponse.message });
        console.log("[Chat Controller] \u2713 \u663E\u793A\u6700\u7EC8\u56DE\u590D\uFF0C\u957F\u5EA6:", finalResponse.message.length);
      } else {
        console.log("[Chat Controller] \u2298 \u8FC7\u6EE4\u65E0\u610F\u4E49\u7684\u6700\u7EC8\u56DE\u590D");
        this.state.addMessage({ role: "assistant", content: "[\u5DF2\u8FC7\u6EE4\u65E0\u610F\u4E49\u56DE\u590D]" });
      }
    } else if (!finalResponse.success) {
      const errorMsg = `\u62B1\u6B49,\u5904\u7406\u5DE5\u5177\u7ED3\u679C\u65F6\u51FA\u9519: ${finalResponse.error || "\u672A\u77E5\u9519\u8BEF"}`;
      await this.ui.addMarkdownMessage("assistant", errorMsg);
      this.state.addMessage({ role: "assistant", content: errorMsg });
    }
  }
  /**
   * 处理切换搜索
   */
  handleToggleSearch() {
    const enabled = this.state.toggleWebSearch();
    this.ui.updateSearchButtonState(enabled);
    new import_obsidian11.Notice(`\u8054\u7F51\u641C\u7D22\u5DF2${enabled ? "\u542F\u7528" : "\u7981\u7528"}`);
  }
  /**
   * 设置上下文文件
   */
  setContextFile(fileName, content) {
    this.state.setContextFile({ name: fileName, content });
    this.updateContextFileUI();
    console.log("[Chat Controller] \u4E0A\u4E0B\u6587\u6587\u4EF6\u5DF2\u8BBE\u7F6E:", fileName);
  }
  /**
   * 移除上下文文件
   */
  removeContextFile() {
    this.state.setContextFile(null);
    this.updateContextFileUI();
    new import_obsidian11.Notice("\u5DF2\u79FB\u9664\u4E0A\u4E0B\u6587\u6587\u4EF6");
    console.log("[Chat Controller] \u4E0A\u4E0B\u6587\u6587\u4EF6\u5DF2\u79FB\u9664");
  }
  /**
   * 更新上下文文件UI
   */
  updateContextFileUI() {
    const contextFile = this.state.getContextFile();
    this.ui.updateContextFileTag(
      (contextFile == null ? void 0 : contextFile.name) || null,
      () => this.removeContextFile()
    );
  }
  /**
   * 处理新建聊天
   */
  handleNewChat() {
    console.log("[Chat Controller] \u65B0\u5EFA\u804A\u5929");
    this.state.reset(this.initialWebSearchEnabled);
    this.ui.clearMessages();
    this.ui.updateTitle(this.state.getTitle());
    this.ui.updateSearchButtonState(this.initialWebSearchEnabled);
    this.updateContextFileUI();
    new import_obsidian11.Notice("\u5DF2\u521B\u5EFA\u65B0\u5BF9\u8BDD");
  }
  /**
   * 处理查看历史
   */
  handleViewHistory() {
    console.log("[Chat Controller] \u67E5\u770B\u5386\u53F2");
    new import_obsidian11.Notice("\u5386\u53F2\u804A\u5929\u529F\u80FD\u5F00\u53D1\u4E2D...");
  }
  /**
   * 处理编辑标题
   */
  handleEditTitle() {
    const currentTitle = this.state.getTitle();
    const titleEl = this.ui.getUI().title;
    titleEl.empty();
    const titleInput = titleEl.createEl("input", {
      type: "text",
      value: currentTitle,
      cls: "ai-chat-title-input"
    });
    titleInput.focus();
    titleInput.select();
    const saveTitle = /* @__PURE__ */ __name(() => {
      const newTitle = titleInput.value.trim() || "\u65B0\u7684\u5BF9\u8BDD";
      this.state.setTitle(newTitle);
      this.ui.updateTitle(newTitle);
      console.log("[Chat Controller] \u6807\u9898\u5DF2\u66F4\u65B0:", newTitle);
    }, "saveTitle");
    titleInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        saveTitle();
      } else if (e.key === "Escape") {
        titleEl.empty();
        titleEl.textContent = currentTitle;
      }
    });
    titleInput.addEventListener("blur", () => {
      saveTitle();
    });
  }
};
__name(_ChatController, "ChatController");
var ChatController = _ChatController;

// src/utils/pages/chat_view.ts
var import_obsidian12 = require("obsidian");
var _ChatView = class _ChatView {
  constructor(parentContainer, app, llmClient, initialWebSearchEnabled = false) {
    // MVC 组件
    __publicField(this, "state");
    __publicField(this, "ui");
    __publicField(this, "controller");
    __publicField(this, "markdownComponent");
    __publicField(this, "dependencies");
    __publicField(this, "initialWebSearchEnabled");
    // 公开的 UI 元素（保持向后兼容）
    __publicField(this, "chatContainer");
    __publicField(this, "chatToolbar");
    __publicField(this, "chatTitle");
    __publicField(this, "chatMessagesContainer");
    __publicField(this, "chatInputContainer");
    __publicField(this, "chatInputToolbar");
    __publicField(this, "chatInput");
    __publicField(this, "chatSendButton");
    __publicField(this, "searchButton");
    // 公开的数据（保持向后兼容）
    __publicField(this, "currentChatMessages", []);
    __publicField(this, "currentChatTitle", "\u65B0\u7684\u5BF9\u8BDD");
    this.initialWebSearchEnabled = initialWebSearchEnabled;
    this.markdownComponent = new import_obsidian12.Component();
    this.markdownComponent.load();
    const toolExecutor = new ToolExecutor();
    this.dependencies = {
      app,
      markdownComponent: this.markdownComponent,
      llmClient: llmClient || null,
      toolExecutor,
      whoogleClient: null
    };
    this.state = new ChatStateManager(initialWebSearchEnabled);
    this.ui = new ChatUIManager(parentContainer, this.dependencies);
    this.controller = new ChatController(this.state, this.ui, this.dependencies, this.initialWebSearchEnabled);
    const uiElements = this.ui.getUI();
    this.chatContainer = uiElements.container;
    this.chatToolbar = uiElements.toolbar;
    this.chatTitle = uiElements.title;
    this.chatMessagesContainer = uiElements.messagesContainer;
    this.chatInputContainer = uiElements.inputContainer;
    this.chatInputToolbar = uiElements.inputToolbar;
    this.chatInput = uiElements.input;
    this.chatSendButton = uiElements.sendButton;
    this.searchButton = uiElements.searchButton;
    this.ui.updateSearchButtonState(this.initialWebSearchEnabled);
    this.syncPublicData();
  }
  /**
   * 同步公开数据（保持向后兼容）
   */
  syncPublicData() {
    this.currentChatMessages = this.state.getMessages();
    this.currentChatTitle = this.state.getTitle();
  }
  /**
   * 创建聊天界面（向后兼容方法）
   */
  createInterface() {
  }
  /**
   * 显示聊天
   */
  show() {
    this.ui.show();
  }
  /**
   * 隐藏聊天
   */
  hide() {
    this.ui.hide();
  }
  /**
   * 设置 LLM 客户端
   */
  setLLMClient(client) {
    this.dependencies.llmClient = client;
    console.log("[Chat View] LLM\u5BA2\u6237\u7AEF\u5DF2", client ? "\u8BBE\u7F6E" : "\u6E05\u7A7A");
  }
  /**
   * 设置 Whoogle 客户端
   */
  setWhoogleClient(client) {
    this.dependencies.whoogleClient = client;
    this.dependencies.toolExecutor.setWhoogleClient(client);
    console.log("[Chat View] Whoogle \u5BA2\u6237\u7AEF\u5DF2", client ? "\u8BBE\u7F6E" : "\u6E05\u7A7A");
  }
  /**
   * 设置 API 客户端（记忆图谱）
   */
  setAPIClient(client) {
    this.dependencies.toolExecutor.setAPIClient(client);
    console.log("[Chat View] API \u5BA2\u6237\u7AEF\u5DF2", client ? "\u8BBE\u7F6E" : "\u6E05\u7A7A");
  }
  /**
   * 设置上下文文件
   */
  setContextFile(fileName, content) {
    this.controller.setContextFile(fileName, content);
  }
  /**
   * 移除上下文文件
   */
  removeContextFile() {
    this.controller.removeContextFile();
  }
  /**
   * 获取样式 CSS
   */
  static getStyles() {
    return ChatUIManager.getStyles();
  }
  /**
   * 清理资源
   */
  unload() {
    this.markdownComponent.unload();
  }
};
__name(_ChatView, "ChatView");
var ChatView = _ChatView;

// src/utils/pages/search.css.ts
var searchPageStyles = `
	/* \u641C\u7D22\u754C\u9762\u5BB9\u5668 */
	.memory-search-view-container {
		flex: 1;
		display: flex;
		flex-direction: column;
		overflow: hidden;
	}

	/* \u6807\u7B7E\u9875\u6837\u5F0F */
	.memory-search-tabs {
		display: flex;
		gap: 8px;
		margin-bottom: 15px;
		border-bottom: 2px solid var(--background-modifier-border);
		padding-bottom: 8px;
		flex-shrink: 0;
	}

	.memory-search-tab {
		padding: 8px 16px;
		border: none;
		border-radius: 4px 4px 0 0;
		background: transparent;
		color: var(--text-muted);
		font-size: 14px;
		cursor: pointer;
		transition: all 0.2s;
		position: relative;
	}

	.memory-search-tab:hover {
		background: var(--background-modifier-hover);
		color: var(--text-normal);
	}

	.memory-search-tab.active {
		background: var(--interactive-accent);
		color: var(--text-on-accent);
		font-weight: 500;
	}

	.memory-search-tab.active::after {
		content: '';
		position: absolute;
		bottom: -10px;
		left: 0;
		right: 0;
		height: 2px;
		background: var(--interactive-accent);
	}

	/* \u641C\u7D22\u6846\u5BB9\u5668 */
	.memory-search-container {
		margin-bottom: 15px;
		display: flex;
		gap: 8px;
		align-items: center;
	}

	.memory-search-input {
		flex: 1;
		padding: 8px 12px;
		border: 1px solid var(--background-modifier-border);
		border-radius: 4px;
		background: var(--background-primary);
		color: var(--text-normal);
		font-size: 14px;
	}

	.memory-search-input:focus {
		outline: none;
		border-color: var(--interactive-accent);
	}

	.memory-search-button {
		padding: 8px 20px;
		border: none;
		border-radius: 4px;
		background: var(--interactive-accent);
		color: var(--text-on-accent);
		font-size: 14px;
		cursor: pointer;
		white-space: nowrap;
	}

	.memory-search-button:hover {
		background: var(--interactive-accent-hover);
	}

	.memory-search-button:disabled {
		opacity: 0.5;
		cursor: not-allowed;
	}

	/* \u641C\u7D22\u7ED3\u679C\u5BB9\u5668 */
	.memory-search-results {
		flex: 1;
		overflow-y: auto;
	}

	.memory-search-placeholder,
	.memory-search-loading,
	.memory-search-error,
	.memory-search-empty {
		text-align: center;
		padding: 20px;
		color: var(--text-muted);
	}

	.memory-search-error {
		color: var(--text-error);
	}

	/* \u7ED3\u679C\u8BA1\u6570 */
	.result-count {
		padding: 8px 12px;
		margin-bottom: 10px;
		font-size: 13px;
		color: var(--text-muted);
		border-bottom: 1px solid var(--background-modifier-border);
	}

	/* \u641C\u7D22\u7ED3\u679C\u9879 */
	.memory-search-result-item {
		padding: 12px;
		margin-bottom: 8px;
		border: 1px solid var(--background-modifier-border);
		border-radius: 4px;
		background: var(--background-secondary);
		cursor: pointer;
		transition: background 0.2s;
	}

	.memory-search-result-item:hover {
		background: var(--background-modifier-hover);
	}

	.result-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 8px;
		gap: 8px;
		flex-wrap: wrap;
	}

	.result-name {
		font-weight: 600;
		color: var(--text-normal);
		flex: 1;
	}

	.result-type {
		font-size: 12px;
		padding: 2px 8px;
		border-radius: 3px;
		background: var(--background-modifier-border);
		color: var(--text-muted);
	}

	.result-score {
		font-size: 12px;
		padding: 2px 8px;
		border-radius: 3px;
		background: var(--interactive-accent);
		color: var(--text-on-accent);
	}

	.result-observations {
		margin-top: 8px;
	}

	.observation-item {
		padding: 4px 0;
		font-size: 13px;
		color: var(--text-muted);
		border-left: 2px solid var(--background-modifier-border);
		padding-left: 8px;
		margin-bottom: 4px;
	}

	/* \u79FB\u52A8\u7AEF\u9002\u914D */
	@media (max-width: 768px) {
		.memory-search-tabs {
			margin-bottom: 0;
			padding: 6px 8px;
			gap: 4px;
		}

		.memory-search-tab {
			padding: 6px 12px;
			font-size: 13px;
		}
	}
`;

// src/utils/pages/search_ui.ts
var _SearchUIBuilder = class _SearchUIBuilder {
  constructor(container) {
    this.container = container;
  }
  /**
   * 创建搜索界面
   */
  createInterface() {
    this.container.empty();
    this.container.addClass("memory-search-view-container");
    const searchInputContainer = this.container.createDiv({ cls: "memory-search-container" });
    const searchInput = searchInputContainer.createEl("input", {
      type: "text",
      placeholder: "\u8F93\u5165\u641C\u7D22\u5185\u5BB9...",
      cls: "memory-search-input"
    });
    const searchButton = searchInputContainer.createEl("button", {
      text: "\u641C\u7D22",
      cls: "memory-search-button"
    });
    const resultsContainer = this.container.createDiv({ cls: "memory-search-results" });
    resultsContainer.createEl("div", {
      text: "\u8F93\u5165\u5173\u952E\u8BCD\u5E76\u70B9\u51FB\u641C\u7D22\u6309\u94AE",
      cls: "memory-search-placeholder"
    });
    return { searchInput, searchButton, resultsContainer };
  }
  /**
   * 显示容器
   */
  show() {
    this.container.style.display = "flex";
  }
  /**
   * 隐藏容器
   */
  hide() {
    this.container.style.display = "none";
  }
  /**
   * 设置搜索按钮状态
   */
  setSearchButtonState(button, disabled, text) {
    button.disabled = disabled;
    button.textContent = text;
  }
  /**
   * 显示加载状态
   */
  showLoading(resultsContainer) {
    resultsContainer.empty();
    resultsContainer.createEl("div", {
      text: "\u641C\u7D22\u4E2D...",
      cls: "memory-search-loading"
    });
  }
  /**
   * 显示错误
   */
  showError(resultsContainer, message) {
    resultsContainer.empty();
    resultsContainer.createEl("div", {
      text: message,
      cls: "memory-search-error"
    });
  }
  /**
   * 显示空结果
   */
  showEmptyResults(resultsContainer) {
    resultsContainer.createEl("div", {
      text: "\u672A\u627E\u5230\u76F8\u5173\u7ED3\u679C",
      cls: "memory-search-empty"
    });
  }
};
__name(_SearchUIBuilder, "SearchUIBuilder");
var SearchUIBuilder = _SearchUIBuilder;

// src/utils/pages/search_handler.ts
var import_obsidian14 = require("obsidian");
var _SearchHandler = class _SearchHandler {
  constructor(apiClient, uiBuilder) {
    this.apiClient = apiClient;
    this.uiBuilder = uiBuilder;
  }
  /**
   * 处理搜索
   */
  async handleSearch(query, searchType) {
    if (!query.trim()) {
      new import_obsidian14.Notice("\u8BF7\u8F93\u5165\u641C\u7D22\u5185\u5BB9");
      return { success: false, error: "\u8BF7\u8F93\u5165\u641C\u7D22\u5185\u5BB9" };
    }
    console.log("\u641C\u7D22\u5173\u952E\u8BCD:", query, "\u641C\u7D22\u7C7B\u578B:", searchType);
    if (!this.apiClient.isConnected()) {
      return { success: false, error: "API \u672A\u8FDE\u63A5\uFF0C\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E API \u5730\u5740" };
    }
    try {
      let results;
      if (searchType === "keyword") {
        results = await this.apiClient.searchNodes(query);
      } else {
        results = await this.apiClient.semanticSearch(query, 20);
      }
      console.log("\u641C\u7D22\u7ED3\u679C:", results);
      return { success: true, results };
    } catch (error) {
      console.error("\u641C\u7D22\u5931\u8D25:", error);
      return { success: false, error: error.message };
    }
  }
};
__name(_SearchHandler, "SearchHandler");
var SearchHandler = _SearchHandler;

// src/utils/pages/search_results.ts
var import_obsidian15 = require("obsidian");
var _SearchResultsDisplay = class _SearchResultsDisplay {
  constructor(plugin, entityManager) {
    this.plugin = plugin;
    this.entityManager = entityManager;
  }
  /**
   * 显示搜索结果
   */
  displayResults(resultsContainer, results, searchType, onEntityClick) {
    resultsContainer.empty();
    let entities = [];
    if (searchType === "keyword") {
      entities = results.entities || [];
    } else {
      entities = results.results || results.entities || results.data || [];
      if (Array.isArray(results)) {
        entities = results;
      }
    }
    if (entities.length === 0) {
      resultsContainer.createEl("div", {
        text: "\u672A\u627E\u5230\u76F8\u5173\u7ED3\u679C",
        cls: "memory-search-empty"
      });
      return;
    }
    const countDiv = resultsContainer.createDiv({ cls: "result-count" });
    countDiv.textContent = `\u627E\u5230 ${entities.length} \u4E2A\u7ED3\u679C`;
    entities.forEach((entity) => {
      this.createResultItem(resultsContainer, entity, searchType, onEntityClick);
    });
  }
  /**
   * 创建单个结果项
   */
  createResultItem(container, entity, searchType, onClick) {
    const resultItem = container.createDiv({ cls: "memory-search-result-item" });
    const header = resultItem.createDiv({ cls: "result-header" });
    header.createEl("span", {
      text: entity.name || entity.entity_name || "\u672A\u547D\u540D",
      cls: "result-name"
    });
    const type = entity.entity_type || entity.entityType || entity.type || "\u672A\u5206\u7C7B";
    header.createEl("span", { text: type, cls: "result-type" });
    if (searchType === "semantic" && entity.similarity !== void 0) {
      header.createEl("span", {
        text: `\u76F8\u4F3C\u5EA6: ${(entity.similarity * 100).toFixed(1)}%`,
        cls: "result-score"
      });
    }
    const observations = entity.observations || [];
    if (observations.length > 0) {
      const observationsDiv = resultItem.createDiv({ cls: "result-observations" });
      observations.forEach((obs) => {
        const obsText = typeof obs === "string" ? obs : obs.content || "";
        observationsDiv.createEl("div", { text: obsText, cls: "observation-item" });
      });
    }
    resultItem.addEventListener("click", async (e) => {
      onClick(entity, e);
    });
  }
  /**
   * 显示实体菜单
   */
  async showEntityMenu(entity, event, fileExists, onRefresh) {
    const entityName = entity.name || entity.entity_name || "\u672A\u547D\u540D";
    const syncFolder = this.plugin.settings.syncTargetFolder;
    const menu = new import_obsidian15.Menu();
    if (fileExists) {
      menu.addItem((item) => {
        item.setTitle("\u6253\u5F00").setIcon("file-text").onClick(async () => {
          const mdFilePath = `${syncFolder}/${entityName}/${entityName}.md`;
          const file = this.plugin.app.vault.getAbstractFileByPath(mdFilePath);
          if (file instanceof import_obsidian15.TFile) {
            await this.plugin.app.workspace.getLeaf(false).openFile(file);
          } else {
            new import_obsidian15.Notice(`\u6587\u4EF6\u4E0D\u5B58\u5728: ${mdFilePath}`);
          }
        });
      });
      menu.addItem((item) => {
        item.setTitle("\u518D\u6B21\u4E0B\u8F7D").setIcon("refresh-cw").onClick(async () => {
          await this.entityManager.resyncMarkdownFiles(entity);
        });
      });
    } else {
      menu.addItem((item) => {
        item.setTitle("\u751F\u6210\u672C\u5730 MarkDown").setIcon("file-plus").onClick(async () => {
          await this.entityManager.generateMarkdownFiles(entity);
        });
      });
    }
    menu.addItem((item) => {
      item.setTitle("\u5220\u9664").setIcon("trash").onClick(async () => {
        const confirmed = await this.confirmDelete(entityName);
        if (confirmed) {
          await this.entityManager.deleteEntity(entity, onRefresh);
        }
      });
    });
    menu.showAtMouseEvent(event);
  }
  /**
   * 确认删除对话框
   */
  async confirmDelete(entityName) {
    const modal = document.createElement("div");
    modal.style.cssText = `
			position: fixed;
			top: 0; left: 0; right: 0; bottom: 0;
			background: rgba(0, 0, 0, 0.5);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
		`;
    const dialog = document.createElement("div");
    dialog.style.cssText = `
			background: var(--background-primary);
			padding: 20px;
			border-radius: 8px;
			min-width: 300px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		`;
    dialog.innerHTML = `
			<h3 style="margin-top: 0; margin-bottom: 15px;">\u786E\u8BA4\u5220\u9664</h3>
			<p style="margin-bottom: 20px;">\u786E\u5B9A\u8981\u5220\u9664\u5B9E\u4F53 <strong>${entityName}</strong> \u5417\uFF1F</p>
			<p style="margin-bottom: 20px; color: var(--text-muted); font-size: 0.9em;">
				\u6B64\u64CD\u4F5C\u5C06\u5220\u9664\u5B9E\u4F53\u53CA\u5176\u6240\u6709\u5173\u8054\u5173\u7CFB\uFF0C\u672C\u5730 Markdown \u6587\u4EF6\u4E5F\u4F1A\u88AB\u5220\u9664\u3002
			</p>
			<div style="display: flex; gap: 10px; justify-content: flex-end;">
				<button id="cancel-btn" style="
					padding: 8px 16px;
					border: 1px solid var(--background-modifier-border);
					background: var(--background-secondary);
					border-radius: 4px;
					cursor: pointer;
				">\u53D6\u6D88</button>
				<button id="confirm-btn" style="
					padding: 8px 16px;
					border: none;
					background: var(--color-red);
					color: white;
					border-radius: 4px;
					cursor: pointer;
				">\u5220\u9664</button>
			</div>
		`;
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    return new Promise((resolve) => {
      const cancelBtn = dialog.querySelector("#cancel-btn");
      const confirmBtn = dialog.querySelector("#confirm-btn");
      const cleanup = /* @__PURE__ */ __name(() => {
        document.body.removeChild(modal);
      }, "cleanup");
      cancelBtn.onclick = () => {
        cleanup();
        resolve(false);
      };
      confirmBtn.onclick = () => {
        cleanup();
        resolve(true);
      };
      modal.onclick = (e) => {
        if (e.target === modal) {
          cleanup();
          resolve(false);
        }
      };
    });
  }
};
__name(_SearchResultsDisplay, "SearchResultsDisplay");
var SearchResultsDisplay = _SearchResultsDisplay;

// src/utils/pages/search_entity_manager.ts
var import_obsidian16 = require("obsidian");
var _SearchEntityManager = class _SearchEntityManager {
  constructor(app, plugin, apiClient) {
    this.app = app;
    this.plugin = plugin;
    this.apiClient = apiClient;
  }
  /**
   * 重新同步 Markdown 文件
   */
  async resyncMarkdownFiles(entity) {
    const entityName = entity.name || entity.entity_name || "\u672A\u547D\u540D";
    try {
      new import_obsidian16.Notice(`\u6B63\u5728\u83B7\u53D6 ${entityName} \u7684\u5B8C\u6574\u6570\u636E...`);
      const graphData = await this.apiClient.readGraph();
      const entities = graphData.entities || [];
      const fullEntity = entities.find(
        (e) => (e.name || e.entity_name) === entityName
      );
      if (!fullEntity) {
        new import_obsidian16.Notice(`\u672A\u627E\u5230\u5B9E\u4F53 ${entityName} \u7684\u5B8C\u6574\u6570\u636E`);
        return;
      }
      const entityType = fullEntity.entity_type || fullEntity.entityType || fullEntity.type || "\u672A\u5206\u7C7B";
      const observations = fullEntity.observations || [];
      const entityId = fullEntity.id || fullEntity.uuid || fullEntity.entity_id || "";
      const allRelations = graphData.relations || [];
      const relations = allRelations.filter(
        (r) => r.from === entityName || r.from_entity === entityName
      );
      new import_obsidian16.Notice(`\u6B63\u5728\u91CD\u65B0\u540C\u6B65 ${entityName} \u7684 MarkDown \u6587\u4EF6...`);
      const syncFolder = this.plugin.settings.syncTargetFolder;
      if (!syncFolder) {
        new import_obsidian16.Notice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u540C\u6B65\u76EE\u6807\u76EE\u5F55");
        return;
      }
      const entityFolderPath = `${syncFolder}/${entityName}`;
      const observationFolderPath = `${entityFolderPath}/\u89C2\u5BDF`;
      const observationFolder = this.app.vault.getAbstractFileByPath(observationFolderPath);
      if (observationFolder) {
        const files = this.app.vault.getFiles().filter((f) => f.path.startsWith(observationFolderPath));
        for (const file of files) {
          await this.app.vault.delete(file);
        }
      }
      if (!observationFolder) {
        await this.app.vault.createFolder(observationFolderPath);
      }
      const mainMdPath = `${entityFolderPath}/${entityName}.md`;
      const mainMdContent = this.generateMainEntityMarkdown(entityName, entityType, observations, entityId, relations);
      const mainFile = this.app.vault.getAbstractFileByPath(mainMdPath);
      if (mainFile instanceof import_obsidian16.TFile) {
        await this.app.vault.modify(mainFile, mainMdContent);
      } else {
        await this.app.vault.create(mainMdPath, mainMdContent);
      }
      for (const observation of observations) {
        const observationTitle = this.extractObservationTitle(observation);
        const observationMdPath = `${observationFolderPath}/${observationTitle}.md`;
        const observationMdContent = this.generateObservationMarkdown(observation, entityName);
        await this.app.vault.create(observationMdPath, observationMdContent);
      }
      new import_obsidian16.Notice(`\u2713 \u6210\u529F\u91CD\u65B0\u540C\u6B65 ${entityName} \u7684 MarkDown \u6587\u4EF6`);
      const updatedMainFile = this.app.vault.getAbstractFileByPath(mainMdPath);
      if (updatedMainFile instanceof import_obsidian16.TFile) {
        await this.app.workspace.getLeaf(false).openFile(updatedMainFile);
      }
    } catch (error) {
      console.error("[Resync MD] \u91CD\u65B0\u540C\u6B65\u5931\u8D25:", error);
      new import_obsidian16.Notice(`\u91CD\u65B0\u540C\u6B65\u5931\u8D25: ${error.message}`);
    }
  }
  /**
   * 生成新的 Markdown 文件
   */
  async generateMarkdownFiles(entity) {
    const entityName = entity.name || entity.entity_name || "\u672A\u547D\u540D";
    try {
      new import_obsidian16.Notice(`\u6B63\u5728\u83B7\u53D6 ${entityName} \u7684\u5B8C\u6574\u6570\u636E...`);
      const graphData = await this.apiClient.readGraph();
      const entities = graphData.entities || [];
      const fullEntity = entities.find(
        (e) => (e.name || e.entity_name) === entityName
      );
      if (!fullEntity) {
        new import_obsidian16.Notice(`\u672A\u627E\u5230\u5B9E\u4F53 ${entityName} \u7684\u5B8C\u6574\u6570\u636E`);
        return;
      }
      const entityType = fullEntity.entity_type || fullEntity.entityType || fullEntity.type || "\u672A\u5206\u7C7B";
      const observations = fullEntity.observations || [];
      const entityId = fullEntity.id || fullEntity.uuid || fullEntity.entity_id || "";
      const allRelations = graphData.relations || [];
      const relations = allRelations.filter(
        (r) => r.from === entityName || r.from_entity === entityName
      );
      new import_obsidian16.Notice(`\u6B63\u5728\u751F\u6210 ${entityName} \u7684 MarkDown \u6587\u4EF6...`);
      const syncFolder = this.plugin.settings.syncTargetFolder;
      if (!syncFolder) {
        new import_obsidian16.Notice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u540C\u6B65\u76EE\u6807\u76EE\u5F55");
        return;
      }
      const entityFolderPath = `${syncFolder}/${entityName}`;
      const entityFolder = this.app.vault.getAbstractFileByPath(entityFolderPath);
      if (!entityFolder) {
        await this.app.vault.createFolder(entityFolderPath);
      }
      const observationFolderPath = `${entityFolderPath}/\u89C2\u5BDF`;
      const observationFolder = this.app.vault.getAbstractFileByPath(observationFolderPath);
      if (!observationFolder) {
        await this.app.vault.createFolder(observationFolderPath);
      }
      const mainMdPath = `${entityFolderPath}/${entityName}.md`;
      const mainMdContent = this.generateMainEntityMarkdown(entityName, entityType, observations, entityId, relations);
      const existingMainFile = this.app.vault.getAbstractFileByPath(mainMdPath);
      if (existingMainFile instanceof import_obsidian16.TFile) {
        await this.app.vault.modify(existingMainFile, mainMdContent);
      } else {
        await this.app.vault.create(mainMdPath, mainMdContent);
      }
      for (const observation of observations) {
        const observationTitle = this.extractObservationTitle(observation);
        const observationMdPath = `${observationFolderPath}/${observationTitle}.md`;
        const observationMdContent = this.generateObservationMarkdown(observation, entityName);
        const existingObsFile = this.app.vault.getAbstractFileByPath(observationMdPath);
        if (existingObsFile instanceof import_obsidian16.TFile) {
          await this.app.vault.modify(existingObsFile, observationMdContent);
        } else {
          await this.app.vault.create(observationMdPath, observationMdContent);
        }
      }
      new import_obsidian16.Notice(`\u2713 \u6210\u529F\u751F\u6210 ${entityName} \u7684 MarkDown \u6587\u4EF6`);
      const mainFile = this.app.vault.getAbstractFileByPath(mainMdPath);
      if (mainFile instanceof import_obsidian16.TFile) {
        await this.app.workspace.getLeaf(false).openFile(mainFile);
      }
    } catch (error) {
      console.error("[Generate MD] \u751F\u6210\u5931\u8D25:", error);
      new import_obsidian16.Notice(`\u751F\u6210\u5931\u8D25: ${error.message}`);
    }
  }
  /**
   * 生成主实体 Markdown 内容
   */
  generateMainEntityMarkdown(entityName, entityType, observations, entityId, relations) {
    const now = /* @__PURE__ */ new Date();
    const dateStr = now.toISOString().split("T")[0];
    const keywords = this.extractKeywords(observations);
    let relationsFrontmatter = "";
    if (relations && relations.length > 0) {
      relationsFrontmatter = "relations:\n";
      for (const relation of relations) {
        const relationType = relation.relation_type || relation.relationType || relation.type || "\u5173\u8054";
        const targetEntity = relation.to_entity || relation.to || relation.target || "";
        const description = relation.description || "";
        const bidirectional = relation.bidirectional !== void 0 ? relation.bidirectional : false;
        relationsFrontmatter += `  - type: "${relationType}"
`;
        relationsFrontmatter += `    target: "${targetEntity}"
`;
        if (description) {
          relationsFrontmatter += `    description: "${description}"
`;
        }
        relationsFrontmatter += `    bidirectional: ${bidirectional}
`;
      }
    }
    let content = `---
title: ${entityName}
id: ${entityId || "unknown"}
category: MAIN_ENTITY
type: \u5B9E\u4F53
entity_class: ${entityType}
entity_label: ${entityName}
created_at: ${dateStr}
updated_at: ${dateStr}
tags:
  - ${entityType}
keywords:
${keywords.map((k) => `  - ${k}`).join("\n")}
${relationsFrontmatter}---

# ${entityName}

**\u5B9E\u4F53\u7C7B\u578B**: ${entityType}

## \u57FA\u672C\u4FE1\u606F
- **\u521B\u5EFA\u65F6\u95F4**: ${dateStr}
- **\u89C2\u5BDF\u6570\u91CF**: ${observations.length}

## \u5173\u8054\u5173\u7CFB
`;
    if (relations && relations.length > 0) {
      for (const relation of relations) {
        const relationType = relation.relation_type || relation.relationType || relation.type || "\u5173\u8054";
        const targetEntity = relation.to_entity || relation.to || relation.target || "";
        content += `- ${relationType}: [[${targetEntity}]]
`;
      }
    } else {
      content += `<!-- \u6682\u65E0\u5173\u8054\u5173\u7CFB -->
`;
    }
    content += `
### \u89C2\u5BDF
`;
    for (const observation of observations) {
      const title = this.extractObservationTitle(observation);
      content += `- [[${title}]]
`;
    }
    return content;
  }
  /**
   * 生成观察记录 Markdown 内容
   */
  generateObservationMarkdown(observation, entityName) {
    const obsText = typeof observation === "string" ? observation : observation.content || "";
    const obsId = typeof observation === "object" && observation.id ? observation.id : "";
    const now = /* @__PURE__ */ new Date();
    const dateStr = now.toISOString().split("T")[0];
    let content = "";
    if (obsId) {
      content = `---
id: ${obsId}
category: OBSERVATION
type: \u89C2\u5BDF
parent_entity: ${entityName}
created_at: ${dateStr}
---

`;
    } else {
      content = `---
category: OBSERVATION
type: \u89C2\u5BDF
parent_entity: ${entityName}
created_at: ${dateStr}
---

`;
    }
    content += `${obsText}

## \u5173\u8054\u5173\u7CFB
- \u5C5E\u4E8E: [[${entityName}]]
`;
    return content;
  }
  /**
   * 提取观察记录标题
   */
  extractObservationTitle(observation) {
    const obsText = typeof observation === "string" ? observation : observation.content || "";
    const firstLine = obsText.split("\n")[0].trim();
    const title = firstLine.length > 20 ? firstLine.substring(0, 20).trim() : firstLine;
    return title.replace(/[\/\\:*?"<>|]/g, "");
  }
  /**
   * 删除实体
   */
  async deleteEntity(entity, onRefresh) {
    var _a, _b;
    const entityName = entity.name || entity.entity_name || "\u672A\u547D\u540D";
    try {
      const result = await this.apiClient.delete.deleteEntities([entityName]);
      if (result.deleted_count > 0) {
        new import_obsidian16.Notice(`\u2713 \u6210\u529F\u5220\u9664\u5B9E\u4F53: ${entityName}`);
        const syncFolder = this.plugin.settings.syncTargetFolder;
        if (syncFolder) {
          const entityFolderPath = `${syncFolder}/${entityName}`;
          const entityFolder = this.app.vault.getAbstractFileByPath(entityFolderPath);
          if (entityFolder) {
            await this.app.vault.delete(entityFolder, true);
            new import_obsidian16.Notice(`\u2713 \u5DF2\u5220\u9664\u672C\u5730\u6587\u4EF6: ${entityFolderPath}`);
          }
        }
        if (onRefresh) {
          onRefresh();
        }
      } else {
        new import_obsidian16.Notice(`\u5220\u9664\u5931\u8D25: ${((_b = (_a = result.failed_entities) == null ? void 0 : _a[0]) == null ? void 0 : _b.error) || "\u672A\u77E5\u9519\u8BEF"}`);
      }
    } catch (error) {
      console.error("[Delete Entity] \u5220\u9664\u5931\u8D25:", error);
      new import_obsidian16.Notice(`\u5220\u9664\u5931\u8D25: ${error.message}`);
    }
  }
  /**
   * 提取关键词
   */
  extractKeywords(observations) {
    const keywords = /* @__PURE__ */ new Set();
    observations.forEach((obs) => {
      const obsText = typeof obs === "string" ? obs : obs.content || "";
      const words = obsText.match(/[\u4e00-\u9fa5]{2,}/g) || [];
      words.slice(0, 3).forEach((word) => keywords.add(word));
    });
    return Array.from(keywords).slice(0, 5);
  }
};
__name(_SearchEntityManager, "SearchEntityManager");
var SearchEntityManager2 = _SearchEntityManager;

// src/utils/pages/search.ts
var import_obsidian17 = require("obsidian");
var _SearchPageView = class _SearchPageView {
  constructor(app, plugin, apiClient, container) {
    __publicField(this, "app");
    __publicField(this, "plugin");
    __publicField(this, "apiClient");
    __publicField(this, "container");
    __publicField(this, "searchInput");
    __publicField(this, "searchButton");
    __publicField(this, "resultsContainer");
    // 模块化组件
    __publicField(this, "uiBuilder");
    __publicField(this, "searchHandler");
    __publicField(this, "resultsDisplay");
    __publicField(this, "entityManager");
    // 保存当前搜索类型和结果，用于刷新
    __publicField(this, "currentSearchType", "keyword");
    __publicField(this, "currentSearchResults", null);
    this.app = app;
    this.plugin = plugin;
    this.apiClient = apiClient;
    this.container = container;
    this.uiBuilder = new SearchUIBuilder(container);
    this.searchHandler = new SearchHandler(apiClient, this.uiBuilder);
    this.entityManager = new SearchEntityManager2(app, plugin, apiClient);
    this.resultsDisplay = new SearchResultsDisplay(plugin, this.entityManager);
  }
  createInterface() {
    const elements = this.uiBuilder.createInterface();
    this.searchInput = elements.searchInput;
    this.searchButton = elements.searchButton;
    this.resultsContainer = elements.resultsContainer;
    this.searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        this.handleSearch();
      }
    });
    this.searchButton.addEventListener("click", () => {
      this.handleSearch();
    });
  }
  show() {
    this.uiBuilder.show();
  }
  hide() {
    this.uiBuilder.hide();
  }
  async handleSearch(searchType = "keyword") {
    const query = this.searchInput.value.trim();
    this.currentSearchType = searchType;
    this.uiBuilder.showLoading(this.resultsContainer);
    this.uiBuilder.setSearchButtonState(this.searchButton, true, "\u641C\u7D22\u4E2D...");
    const result = await this.searchHandler.handleSearch(query, searchType);
    this.uiBuilder.setSearchButtonState(this.searchButton, false, "\u641C\u7D22");
    if (!result.success) {
      this.uiBuilder.showError(this.resultsContainer, `\u641C\u7D22\u5931\u8D25: ${result.error}`);
      new import_obsidian17.Notice(`\u641C\u7D22\u5931\u8D25: ${result.error}`);
      return;
    }
    this.currentSearchResults = result.results;
    this.resultsDisplay.displayResults(
      this.resultsContainer,
      result.results,
      searchType,
      (entity, event) => this.handleEntityClick(entity, event)
    );
  }
  /**
   * 刷新搜索结果
   */
  async refreshResults() {
    if (!this.currentSearchResults) {
      return;
    }
    this.resultsDisplay.displayResults(
      this.resultsContainer,
      this.currentSearchResults,
      this.currentSearchType,
      (entity, event) => this.handleEntityClick(entity, event)
    );
  }
  /**
   * 从搜索结果中移除实体
   */
  removeEntityFromResults(entityName) {
    if (!this.currentSearchResults) {
      return;
    }
    let entities = [];
    if (this.currentSearchType === "keyword") {
      entities = this.currentSearchResults.entities || [];
    } else {
      entities = this.currentSearchResults.results || this.currentSearchResults.entities || this.currentSearchResults.data || [];
      if (Array.isArray(this.currentSearchResults)) {
        entities = this.currentSearchResults;
      }
    }
    const filteredEntities = entities.filter((e) => {
      const name = e.name || e.entity_name || "";
      return name !== entityName;
    });
    if (this.currentSearchType === "keyword") {
      this.currentSearchResults.entities = filteredEntities;
    } else {
      if (this.currentSearchResults.results) {
        this.currentSearchResults.results = filteredEntities;
      } else if (this.currentSearchResults.entities) {
        this.currentSearchResults.entities = filteredEntities;
      } else if (this.currentSearchResults.data) {
        this.currentSearchResults.data = filteredEntities;
      }
    }
    this.refreshResults();
  }
  async handleEntityClick(entity, event) {
    const entityName = entity.name || entity.entity_name || "\u672A\u547D\u540D";
    console.log("[Entity Click] \u70B9\u51FB\u5B9E\u4F53:", entityName);
    const syncFolder = this.plugin.settings.syncTargetFolder;
    if (!syncFolder) {
      new import_obsidian17.Notice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u540C\u6B65\u76EE\u5F55");
      return;
    }
    const mdFilePath = `${syncFolder}/${entityName}/${entityName}.md`;
    const file = this.app.vault.getAbstractFileByPath(mdFilePath);
    const fileExists = file instanceof import_obsidian17.TFile;
    await this.resultsDisplay.showEntityMenu(
      entity,
      event,
      fileExists,
      () => this.removeEntityFromResults(entityName)
    );
  }
  static getStyles() {
    return searchPageStyles;
  }
};
__name(_SearchPageView, "SearchPageView");
var SearchPageView = _SearchPageView;

// src/utils/tools/whoogle.ts
var import_obsidian18 = require("obsidian");
var _WhoogleClient = class _WhoogleClient {
  constructor(config) {
    __publicField(this, "config");
    this.config = config;
    console.log("[Whoogle Client] \u521D\u59CB\u5316\uFF0CURL:", config.whoogleUrl, "\u8BA4\u8BC1:", config.authEnabled);
  }
  /**
   * 执行网络搜索
   *
   * @param params - 搜索参数
   * @returns 搜索结果
   * @throws 搜索失败时抛出错误
   */
  async search(params) {
    try {
      if (!this.config.whoogleUrl) {
        throw new Error("Whoogle URL \u672A\u914D\u7F6E");
      }
      const {
        query,
        pageno = 1,
        gl = "cn",
        hl = "zh-CN"
      } = params;
      const searchParams = new URLSearchParams({
        q: query,
        format: "json",
        gl,
        hl,
        pws: "0",
        cr: "countryCN",
        lr: "lang_zh-CN",
        page: pageno.toString()
      });
      const headers = {
        "Content-Type": "application/json"
      };
      if (this.config.authEnabled && this.config.authKey) {
        headers["Authorization"] = `Bearer ${this.config.authKey}`;
        console.log("[Whoogle Client] \u2713 \u5DF2\u6DFB\u52A0 Authorization Bearer Token");
      }
      const searchUrl = `${this.config.whoogleUrl.replace(/\/$/, "")}/search?${searchParams.toString()}`;
      console.log("[Whoogle Client] \u641C\u7D22 URL:", searchUrl);
      const response = await (0, import_obsidian18.requestUrl)({
        url: searchUrl,
        method: "GET",
        headers
      });
      if (response.status !== 200) {
        throw new Error(`HTTP \u9519\u8BEF: ${response.status}`);
      }
      const data = response.json;
      const results = {
        query,
        number_of_results: 0,
        page: pageno,
        results: []
      };
      const resultList = data.results || [];
      if (Array.isArray(resultList)) {
        results.number_of_results = resultList.length;
        for (const result of resultList) {
          const formattedResult = {
            title: result.title || "",
            url: result.href || result.url || result.link || "",
            content: result.content || result.snippet || result.description || "",
            engine: "whoogle"
          };
          if (result.publishedDate) {
            formattedResult.published_date = result.publishedDate;
          } else if (result.date) {
            formattedResult.published_date = result.date;
          }
          if (result.img_src) {
            formattedResult.image_url = result.img_src;
          } else if (result.image) {
            formattedResult.image_url = result.image;
          }
          results.results.push(formattedResult);
        }
      }
      if (data.infoboxes) {
        results.infoboxes = data.infoboxes;
      }
      if (data.suggestions) {
        results.suggestions = data.suggestions;
      }
      if (data.related) {
        results.related = data.related;
      }
      console.log("[Whoogle Client] \u2713 \u641C\u7D22\u5B8C\u6210:", results.number_of_results, "\u4E2A\u7ED3\u679C");
      return results;
    } catch (error) {
      console.error("[Whoogle Client] \u2717 \u641C\u7D22\u5931\u8D25:", error);
      if (error.message && error.message.includes("401")) {
        throw new Error("\u8BA4\u8BC1\u5931\u8D25: API Key \u65E0\u6548\u6216\u672A\u6388\u6743");
      } else if (error.message && error.message.includes("404")) {
        throw new Error("Whoogle \u670D\u52A1\u672A\u627E\u5230\uFF0C\u8BF7\u68C0\u67E5 URL \u914D\u7F6E");
      } else if (error.message && error.message.includes("timeout")) {
        throw new Error("\u8BF7\u6C42\u8D85\u65F6\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5");
      } else {
        throw new Error(`Whoogle \u641C\u7D22\u5931\u8D25: ${error.message || "\u672A\u77E5\u9519\u8BEF"}`);
      }
    }
  }
  /**
   * 测试 Whoogle 服务连接
   *
   * @returns 测试结果
   */
  async testConnection() {
    try {
      if (!this.config.whoogleUrl) {
        return {
          success: false,
          message: "\u8BF7\u5148\u914D\u7F6E Whoogle URL"
        };
      }
      const result = await this.search({
        query: "test",
        pageno: 1
      });
      return {
        success: true,
        message: `\u2713 Whoogle \u8FDE\u63A5\u6210\u529F\uFF0C\u627E\u5230 ${result.number_of_results} \u4E2A\u6D4B\u8BD5\u7ED3\u679C`
      };
    } catch (error) {
      console.error("[Whoogle Client] \u2717 \u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25:", error);
      return {
        success: false,
        message: `\u8FDE\u63A5\u5931\u8D25: ${error.message}`
      };
    }
  }
};
__name(_WhoogleClient, "WhoogleClient");
var WhoogleClient4 = _WhoogleClient;

// src/search_view.ts
var import_obsidian19 = require("obsidian");
var VIEW_TYPE_MEMORY_SEARCH = "memory-search-view";
var _MemorySearchView = class _MemorySearchView extends import_obsidian19.ItemView {
  constructor(leaf, plugin) {
    super(leaf);
    this.llmClient = null;
    this.whoogleClient = null;
    this.plugin = plugin;
    this.apiClient = new APIClient(this.app);
  }
  getViewType() {
    return VIEW_TYPE_MEMORY_SEARCH;
  }
  getDisplayText() {
    return "\u8BB0\u5FC6\u56FE\u8C31\u641C\u7D22";
  }
  getIcon() {
    return "brain";
  }
  async onOpen() {
    const container = this.containerEl.children[1];
    container.empty();
    container.addClass("memory-search-view");
    await this.initializeAPIClient();
    this.initializeLLMClient();
    this.initializeWhoogleClient();
    this.registerFileOpenListener();
    this.tabsContainer = container.createDiv({ cls: "memory-search-tabs" });
    const keywordTab = this.tabsContainer.createEl("button", {
      text: "\u5173\u952E\u8BCD\u641C\u7D22",
      cls: "memory-search-tab active"
    });
    keywordTab.setAttribute("data-type", "keyword");
    const semanticTab = this.tabsContainer.createEl("button", {
      text: "\u5411\u91CF\u641C\u7D22",
      cls: "memory-search-tab"
    });
    semanticTab.setAttribute("data-type", "semantic");
    const chatTab = this.tabsContainer.createEl("button", {
      text: "AI\u804A\u5929",
      cls: "memory-search-tab"
    });
    chatTab.setAttribute("data-type", "chat");
    const tabs = [keywordTab, semanticTab, chatTab];
    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.removeClass("active"));
        tab.addClass("active");
        this.switchView(tab.getAttribute("data-type") || "keyword");
      });
    });
    const searchContainer = container.createDiv();
    this.searchPageView = new SearchPageView(this.app, this.plugin, this.apiClient, searchContainer);
    this.searchPageView.createInterface();
    const initialWebSearchEnabled = this.plugin.settings.searchDefaultEnabled || false;
    this.chatView = new ChatView(container, this.app, this.llmClient || void 0, initialWebSearchEnabled);
    this.chatView.createInterface();
    if (this.whoogleClient) {
      this.chatView.setWhoogleClient(this.whoogleClient);
    }
    if (this.apiClient) {
      this.chatView.setAPIClient(this.apiClient);
    }
    this.chatView.hide();
    this.addStyles();
  }
  async onClose() {
  }
  async initializeAPIClient() {
    try {
      const settings = this.plugin.settings;
      if (settings.mcpApiUrl) {
        await this.apiClient.connect({
          apiUrl: settings.mcpApiUrl,
          apiKey: settings.mcpApiKey
        });
        console.log("[Search View] API \u5BA2\u6237\u7AEF\u521D\u59CB\u5316\u6210\u529F");
        if (this.chatView) {
          this.chatView.setAPIClient(this.apiClient);
        }
      } else {
        console.warn("[Search View] \u672A\u914D\u7F6E API \u5730\u5740");
      }
    } catch (error) {
      console.error("[Search View] API \u5BA2\u6237\u7AEF\u521D\u59CB\u5316\u5931\u8D25:", error);
    }
  }
  initializeLLMClient() {
    try {
      const settings = this.plugin.settings;
      if (settings.llmApiUrl && settings.llmApiKey && settings.llmModelName) {
        this.llmClient = new LLMClient({
          apiUrl: settings.llmApiUrl,
          apiKey: settings.llmApiKey,
          modelName: settings.llmModelName,
          apiType: settings.llmApiType,
          systemRules: settings.llmSystemRules,
          contextWindow: settings.llmContextWindow,
          maxOutputTokens: settings.llmMaxOutputTokens
        });
        console.log("[Search View] \u2713 LLM \u5BA2\u6237\u7AEF\u521D\u59CB\u5316\u6210\u529F");
        if (this.chatView) {
          this.chatView.setLLMClient(this.llmClient);
        }
      } else {
        console.warn("[Search View] \u672A\u5B8C\u6574\u914D\u7F6E LLM API\uFF0C\u804A\u5929\u529F\u80FD\u5C06\u4E0D\u53EF\u7528");
        this.llmClient = null;
      }
    } catch (error) {
      console.error("[Search View] LLM \u5BA2\u6237\u7AEF\u521D\u59CB\u5316\u5931\u8D25:", error);
      this.llmClient = null;
    }
  }
  initializeWhoogleClient() {
    try {
      const settings = this.plugin.settings;
      if (settings.searchWhoogleUrl) {
        this.whoogleClient = new WhoogleClient4({
          whoogleUrl: settings.searchWhoogleUrl,
          authEnabled: settings.searchAuthEnabled || false,
          authKey: settings.searchAuthKey || ""
        });
        console.log("[Search View] \u2713 Whoogle \u5BA2\u6237\u7AEF\u521D\u59CB\u5316\u6210\u529F");
        if (this.chatView) {
          this.chatView.setWhoogleClient(this.whoogleClient);
        }
      } else {
        console.warn("[Search View] \u672A\u914D\u7F6E Whoogle URL\uFF0C\u641C\u7D22\u529F\u80FD\u5C06\u4E0D\u53EF\u7528");
        this.whoogleClient = null;
      }
    } catch (error) {
      console.error("[Search View] Whoogle \u5BA2\u6237\u7AEF\u521D\u59CB\u5316\u5931\u8D25:", error);
      this.whoogleClient = null;
    }
  }
  switchView(viewType) {
    var _a;
    console.log("[Switch View] \u5207\u6362\u89C6\u56FE:", viewType);
    const activeTab = this.tabsContainer.querySelector(".memory-search-tab.active");
    const searchType = (activeTab == null ? void 0 : activeTab.getAttribute("data-type")) || "keyword";
    if (viewType === "chat") {
      this.initializeLLMClient();
      this.searchPageView.hide();
      this.chatView.show();
      setTimeout(() => {
        const input = this.chatView.chatInput;
        const inputContainer = this.chatView.chatInputContainer;
        const container = this.chatView.chatContainer;
        const containerRect = container == null ? void 0 : container.getBoundingClientRect();
        const inputRect = input == null ? void 0 : input.getBoundingClientRect();
        const inputContainerRect = inputContainer == null ? void 0 : inputContainer.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        const windowWidth = window.innerWidth;
        const debugInfo = [
          `\u7A97\u53E3: ${windowWidth}x${windowHeight}`,
          `\u5BB9\u5668\u4F4D\u7F6E: top=${containerRect == null ? void 0 : containerRect.top.toFixed(0)}, bottom=${containerRect == null ? void 0 : containerRect.bottom.toFixed(0)}`,
          `\u5BB9\u5668\u9AD8\u5EA6: ${containerRect == null ? void 0 : containerRect.height.toFixed(0)}px`,
          `\u8F93\u5165\u5BB9\u5668\u4F4D\u7F6E: top=${inputContainerRect == null ? void 0 : inputContainerRect.top.toFixed(0)}, bottom=${inputContainerRect == null ? void 0 : inputContainerRect.bottom.toFixed(0)}`,
          `\u8F93\u5165\u5BB9\u5668\u9AD8\u5EA6: ${inputContainerRect == null ? void 0 : inputContainerRect.height.toFixed(0)}px`,
          `\u8F93\u5165\u6846\u4F4D\u7F6E: top=${inputRect == null ? void 0 : inputRect.top.toFixed(0)}, bottom=${inputRect == null ? void 0 : inputRect.bottom.toFixed(0)}`,
          `\u8F93\u5165\u6846\u9AD8\u5EA6: ${inputRect == null ? void 0 : inputRect.height.toFixed(0)}px`
        ];
        new import_obsidian19.Notice(debugInfo.join("\n"), 1e4);
        if (input && inputRect && inputRect.bottom > windowHeight) {
          new import_obsidian19.Notice("\u8F93\u5165\u6846\u5728\u89C6\u53E3\u5916\uFF0C\u5C1D\u8BD5\u6EDA\u52A8...", 3e3);
          input.scrollIntoView({ behavior: "smooth", block: "end" });
        }
      }, 200);
    } else {
      this.searchPageView.show();
      this.chatView.hide();
      const oldButton = this.searchPageView.searchButton;
      if (oldButton) {
        const newButton = oldButton.cloneNode(true);
        (_a = oldButton.parentNode) == null ? void 0 : _a.replaceChild(newButton, oldButton);
        this.searchPageView.searchButton = newButton;
        newButton.addEventListener("click", () => {
          this.searchPageView.handleSearch(searchType);
        });
      }
    }
  }
  /**
   * 注册文件打开事件监听
   */
  registerFileOpenListener() {
    this.registerEvent(
      this.app.workspace.on("active-leaf-change", (leaf) => {
        if (!leaf || !leaf.view) return;
        const view = leaf.view;
        if (view.getViewType() === "markdown") {
          const markdownView = view;
          const file = markdownView.file;
          if (file && file.extension === "md") {
            this.injectFileToChat(file);
          }
        }
      })
    );
  }
  /**
   * 公开方法：重新初始化LLM客户端（当配置更新时调用）
   */
  reinitLLMClient() {
    console.log("[Search View] \u91CD\u65B0\u521D\u59CB\u5316 LLM \u5BA2\u6237\u7AEF");
    this.initializeLLMClient();
  }
  /**
   * 将文件内容注入到聊天上下文
   * 注意：现在只设置文件引用，不立即注入完整内容
   * AI 可以通过 read_doc 工具按需读取
   */
  async injectFileToChat(file) {
    try {
      const content = await this.app.vault.read(file);
      if (!content.trim()) {
        console.log("[Search View] \u6587\u4EF6\u5185\u5BB9\u4E3A\u7A7A\uFF0C\u4E0D\u6CE8\u5165\u4E0A\u4E0B\u6587");
        return;
      }
      if (this.chatView) {
        this.chatView.setContextFile(file.basename, content);
        console.log("[Search View] \u2713 \u5DF2\u8BBE\u7F6E\u6587\u6863\u5F15\u7528\uFF0CAI \u53EF\u901A\u8FC7 read_doc \u5DE5\u5177\u8BFB\u53D6:", file.basename);
      }
    } catch (error) {
      console.error("[Search View] \u8BFB\u53D6\u6587\u4EF6\u5931\u8D25:", error);
    }
  }
  addStyles() {
    const style = document.createElement("style");
    style.textContent = `
			.memory-search-view {
				padding: 10px;
				height: 100%;
				display: flex;
				flex-direction: column;
				position: relative;
			}

			/* \u79FB\u52A8\u7AEF\u9002\u914D\uFF1A\u5F3A\u5236\u79FB\u9664 Obsidian \u5BB9\u5668\u7684\u9ED8\u8BA4\u6837\u5F0F */
			@media (max-width: 768px) {
				/* \u79FB\u9664 Obsidian ItemView \u5BB9\u5668\u7684 padding */
				.memory-search-view,
				.memory-search-view > * {
					padding: 0 !important;
					margin: 0 !important;
				}

				.memory-search-view {
					height: 100dvh !important;
					max-height: 100dvh !important;
					min-height: 100dvh !important;
					display: flex !important;
					flex-direction: column !important;
					overflow: hidden !important;
				}

				.memory-search-tabs {
					flex-shrink: 0 !important;
				}

				/* \u79FB\u9664 Obsidian \u6DFB\u52A0\u7684\u4EFB\u4F55\u5176\u4ED6\u5BB9\u5668\u95F4\u8DDD */
				.workspace-leaf-content {
					padding: 0 !important;
				}
			}

			${SearchPageView.getStyles()}
			${ChatView.getStyles()}
		`;
    document.head.appendChild(style);
  }
};
__name(_MemorySearchView, "MemorySearchView");
var MemorySearchView = _MemorySearchView;

// src/hooks/file_watcher.ts
var import_obsidian20 = require("obsidian");
var _FileWatcher = class _FileWatcher {
  // 是否启用自动同步
  constructor(plugin) {
    __publicField(this, "plugin");
    __publicField(this, "syncFolder");
    __publicField(this, "debounceTimer");
    __publicField(this, "debounceDelay", 1e3);
    // 防抖延迟 1 秒
    __publicField(this, "isEnabled", false);
    this.plugin = plugin;
    this.syncFolder = plugin.settings.syncTargetFolder || "";
    this.debounceTimer = /* @__PURE__ */ new Map();
    this.isEnabled = plugin.settings.autoSyncObservations || false;
  }
  /**
   * 设置是否启用自动同步
   */
  setEnabled(enabled) {
    this.isEnabled = enabled;
    console.log("[File Watcher] \u81EA\u52A8\u540C\u6B65", enabled ? "\u5DF2\u542F\u7528" : "\u5DF2\u7981\u7528");
  }
  /**
   * 检查是否启用
   */
  isAutoSyncEnabled() {
    return this.isEnabled;
  }
  /**
   * 注册文件修改监听器
   */
  register() {
    console.log("[File Watcher] \u6CE8\u518C\u6587\u4EF6\u4FEE\u6539\u76D1\u542C\u5668");
    this.plugin.registerEvent(
      this.plugin.app.vault.on("modify", async (file) => {
        await this.onFileModified(file);
      })
    );
  }
  /**
   * 文件修改事件处理
   */
  async onFileModified(file) {
    if (!this.isEnabled) {
      return;
    }
    if (!(file instanceof import_obsidian20.TFile) || file.extension !== "md") {
      return;
    }
    if (!this.syncFolder || !file.path.startsWith(this.syncFolder)) {
      return;
    }
    if (this.debounceTimer.has(file.path)) {
      clearTimeout(this.debounceTimer.get(file.path));
    }
    const timer = setTimeout(async () => {
      await this.processFileModification(file);
      this.debounceTimer.delete(file.path);
    }, this.debounceDelay);
    this.debounceTimer.set(file.path, timer);
    console.log("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501");
    console.log("[File Watcher] \u{1F4DD} \u68C0\u6D4B\u5230\u6587\u4EF6\u4FEE\u6539\uFF08\u9632\u6296\u4E2D...\uFF09");
    console.log("[File Watcher] \u6587\u4EF6\u8DEF\u5F84:", file.path);
  }
  /**
   * 处理文件修改（防抖后执行）
   */
  async processFileModification(file) {
    console.log("[File Watcher] \u{1F680} \u5F00\u59CB\u5904\u7406\u6587\u4EF6\u4FEE\u6539");
    console.log("[File Watcher] \u6587\u4EF6\u8DEF\u5F84:", file.path);
    console.log("[File Watcher] \u6587\u4EF6\u5927\u5C0F:", file.stat.size, "bytes");
    console.log("[File Watcher] \u4FEE\u6539\u65F6\u95F4:", new Date(file.stat.mtime).toLocaleString());
    const isObservationFile = file.path.includes("/\u89C2\u5BDF/");
    if (isObservationFile) {
      console.log("[File Watcher] \u{1F4C4} \u6587\u4EF6\u7C7B\u578B: \u89C2\u5BDF\u6587\u4EF6");
      await this.handleObservationModified(file);
    } else {
      console.log("[File Watcher] \u{1F4C1} \u6587\u4EF6\u7C7B\u578B: \u4E3B\u5B9E\u4F53\u6587\u4EF6");
      await this.handleEntityModified(file);
    }
    console.log("\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501");
  }
  /**
   * 处理观察文件修改
   */
  async handleObservationModified(file) {
    try {
      console.log("[File Watcher] \u{1F4D6} \u8BFB\u53D6\u6587\u4EF6\u5185\u5BB9...");
      const content = await this.plugin.app.vault.read(file);
      const obsContent = this.extractObservationContent(content);
      const frontmatter = this.parseFrontmatter(content);
      console.log("[File Watcher] \u89E3\u6790 frontmatter:", frontmatter);
      console.log("[File Watcher] \u89C2\u5BDF\u5185\u5BB9\u957F\u5EA6:", obsContent.length, "\u5B57\u7B26");
      console.log("[File Watcher] \u89C2\u5BDF\u5185\u5BB9\u9884\u89C8:", obsContent.substring(0, 100) + "...");
      const observationId = frontmatter.id;
      const parentEntity = frontmatter.parent_entity;
      if (!observationId) {
        console.warn("[File Watcher] \u26A0\uFE0F \u7F3A\u5C11 id \u5B57\u6BB5\uFF0C\u8DF3\u8FC7\u540C\u6B65");
        return;
      }
      if (!parentEntity) {
        console.warn("[File Watcher] \u26A0\uFE0F \u7F3A\u5C11 parent_entity \u5B57\u6BB5\uFF0C\u8DF3\u8FC7\u540C\u6B65");
        return;
      }
      console.log("[File Watcher] \u89C2\u5BDF\u8BB0\u5F55 ID:", observationId);
      console.log("[File Watcher] \u6240\u5C5E\u5B9E\u4F53:", parentEntity);
      const oldHash = frontmatter.content_hash;
      const newHash = this.calculateHash(obsContent);
      console.log("[File Watcher] \u65E7\u5185\u5BB9\u54C8\u5E0C:", oldHash || "\uFF08\u9996\u6B21\u751F\u6210\uFF09");
      console.log("[File Watcher] \u65B0\u5185\u5BB9\u54C8\u5E0C:", newHash);
      if (oldHash === newHash) {
        console.log("[File Watcher] \u2705 \u5185\u5BB9\u672A\u53D8\u5316\uFF0C\u8DF3\u8FC7\u540C\u6B65");
        return;
      }
      console.log("[File Watcher] \u{1F504} \u68C0\u6D4B\u5230\u5185\u5BB9\u53D8\u5316\uFF0C\u51C6\u5907\u540C\u6B65\u5230\u670D\u52A1\u5668");
      new import_obsidian20.Notice(`\u{1F504} \u6B63\u5728\u540C\u6B65\u89C2\u5BDF\u8BB0\u5F55: ${file.name}`);
      const apiClient = this.getAPIClient();
      if (!apiClient) {
        console.error("[File Watcher] \u274C \u65E0\u6CD5\u83B7\u53D6 API \u5BA2\u6237\u7AEF");
        new import_obsidian20.Notice("\u274C \u65E0\u6CD5\u8FDE\u63A5\u5230\u670D\u52A1\u5668");
        return;
      }
      console.log("[File Watcher] \u{1F4E1} \u8C03\u7528 update_observations API");
      const updateResult = await apiClient.create.updateObservationsById([{
        observation_id: observationId,
        content: obsContent
      }]);
      console.log("[File Watcher] API \u54CD\u5E94:", updateResult);
      console.log("[File Watcher] \u{1F4BE} \u66F4\u65B0\u672C\u5730 content_hash");
      const updatedContent = this.updateContentHash(content, newHash);
      await this.plugin.app.vault.modify(file, updatedContent);
      console.log("[File Watcher] \u2705 \u540C\u6B65\u5B8C\u6210");
      new import_obsidian20.Notice(`\u2705 \u5DF2\u540C\u6B65\u89C2\u5BDF\u8BB0\u5F55: ${file.name}`);
    } catch (error) {
      console.error("[File Watcher] \u274C \u5904\u7406\u5931\u8D25:", error);
      new import_obsidian20.Notice(`\u274C \u540C\u6B65\u5931\u8D25: ${error.message}`);
    }
  }
  /**
   * 处理主实体文件修改
   */
  async handleEntityModified(file) {
    console.log("[File Watcher] \u{1F4D6} \u8BFB\u53D6\u4E3B\u5B9E\u4F53\u6587\u4EF6...");
    try {
      const content = await this.plugin.app.vault.read(file);
      const frontmatter = this.parseFrontmatter(content);
      console.log("[File Watcher] \u5B9E\u4F53\u540D\u79F0:", frontmatter.title);
      console.log("[File Watcher] \u5B9E\u4F53\u7C7B\u578B:", frontmatter.entity_class || frontmatter.type);
      console.log("[File Watcher] \u5B9E\u4F53 ID:", frontmatter.id);
    } catch (error) {
      console.error("[File Watcher] \u274C \u8BFB\u53D6\u5931\u8D25:", error);
    }
  }
  /**
   * 获取 API 客户端
   */
  getAPIClient() {
    const leaves = this.plugin.app.workspace.getLeavesOfType("memory-search");
    if (leaves.length > 0) {
      const view = leaves[0].view;
      return view.apiClient;
    }
    return null;
  }
  /**
   * 提取观察内容（去除 frontmatter 和关联关系）
   */
  extractObservationContent(content) {
    let text = content.replace(/^---\n[\s\S]+?\n---\n/, "");
    text = text.replace(/\n## 关联关系[\s\S]*$/, "");
    return text.trim();
  }
  /**
   * 解析 frontmatter
   */
  parseFrontmatter(content) {
    const match = content.match(/^---\n([\s\S]+?)\n---/);
    if (!match) return {};
    const frontmatter = {};
    match[1].split("\n").forEach((line) => {
      const colonIndex = line.indexOf(":");
      if (colonIndex > 0) {
        const key = line.substring(0, colonIndex).trim();
        const value = line.substring(colonIndex + 1).trim();
        frontmatter[key] = value;
      }
    });
    return frontmatter;
  }
  /**
   * 计算简单哈希
   */
  calculateHash(content) {
    let hash = 0;
    for (let i = 0; i < content.length; i++) {
      hash = (hash << 5) - hash + content.charCodeAt(i);
      hash = hash & hash;
    }
    return hash.toString(36);
  }
  /**
   * 更新 content_hash 字段
   */
  updateContentHash(content, newHash) {
    return content.replace(
      /^---\n([\s\S]+?)\n---/,
      (match, frontmatter) => {
        if (frontmatter.includes("content_hash:")) {
          return frontmatter.replace(
            /content_hash:\s*\S+/,
            `content_hash: ${newHash}`
          ) + "\n---";
        } else {
          return frontmatter + `content_hash: ${newHash}
---`;
        }
      }
    );
  }
};
__name(_FileWatcher, "FileWatcher");
var FileWatcher = _FileWatcher;

// src/main.ts
var import_obsidian21 = require("obsidian");
var _MemoryGraphPlugin = class _MemoryGraphPlugin extends import_obsidian21.Plugin {
  // FileWatcher 实例引用
  async onload() {
    console.log("Loading Memory Graph Plugin");
    await this.loadSettings();
    this.registerView(
      VIEW_TYPE_MEMORY_SEARCH,
      (leaf) => new MemorySearchView(leaf, this)
    );
    this.addSettingTab(new MemoryGraphSettingTab(this.app, this));
    this.addRibbonIcon("brain", "\u6253\u5F00\u8BB0\u5FC6\u56FE\u8C31", () => {
      this.activateView();
    });
    this.addCommand({
      id: "open-memory-graph",
      name: "\u6253\u5F00\u8BB0\u5FC6\u56FE\u8C31",
      callback: /* @__PURE__ */ __name(() => {
        this.activateView();
      }, "callback")
    });
    this.addCommand({
      id: "reload-plugin",
      name: "\u{1F504} \u91CD\u65B0\u52A0\u8F7D\u63D2\u4EF6 (\u5F00\u53D1\u7528)",
      callback: /* @__PURE__ */ __name(async () => {
        console.log("Reloading Memory Graph Plugin...");
        new import_obsidian21.Notice('\u8BF7\u4F7F\u7528\u547D\u4EE4\u9762\u677F\u4E2D\u7684 "Reload plugins without reloading app"');
      }, "callback")
    });
    this.addCommand({
      id: "sync-observations",
      name: "\u{1F504} \u624B\u52A8\u540C\u6B65\u89C2\u5BDF\u8BB0\u5F55",
      callback: /* @__PURE__ */ __name(async () => {
        await this.syncAllObservations();
      }, "callback")
    });
    this.fileWatcher = new FileWatcher(this);
    this.fileWatcher.register();
    this.registerEvent(
      this.app.workspace.on("editor-menu", (menu, editor, view) => {
        menu.addItem((item) => {
          item.setTitle("\u5206\u6790\u5E76\u4E0A\u4F20\u5230\u8BB0\u5FC6\u56FE\u8C31\u7CFB\u7EDF").setIcon("brain-circuit").onClick(async () => {
            await this.analyzeAndUploadFromEditor(editor, view);
          });
        });
        menu.addItem((item) => {
          item.setTitle("\u5728AI\u804A\u5929\u4E2D\u5F15\u5165").setIcon("message-square").onClick(async () => {
            await this.introduceToAIChatFromEditor(editor, view);
          });
        });
      })
    );
    this.registerEvent(
      this.app.workspace.on("file-menu", (menu, file, source) => {
        const abstractFile = this.app.vault.getAbstractFileByPath(file.path);
        if (abstractFile instanceof import_obsidian21.TFolder) {
          menu.addItem((item) => {
            item.setTitle("\u5206\u6790\u5E76\u4E0A\u4F20\u5230\u8BB0\u5FC6\u56FE\u8C31\u7CFB\u7EDF").setIcon("brain-circuit").onClick(async () => {
              await this.analyzeAndUploadFolder(abstractFile);
            });
          });
          menu.addItem((item) => {
            item.setTitle("\u5728AI\u804A\u5929\u4E2D\u5F15\u5165").setIcon("message-square").onClick(async () => {
              await this.introduceToAIChatFolder(abstractFile);
            });
          });
        } else if (abstractFile instanceof import_obsidian21.TFile) {
          menu.addItem((item) => {
            item.setTitle("\u5206\u6790\u5E76\u4E0A\u4F20\u5230\u8BB0\u5FC6\u56FE\u8C31\u7CFB\u7EDF").setIcon("brain-circuit").onClick(async () => {
              await this.analyzeAndUploadFile(abstractFile);
            });
          });
          menu.addItem((item) => {
            item.setTitle("\u5728AI\u804A\u5929\u4E2D\u5F15\u5165").setIcon("message-square").onClick(async () => {
              await this.introduceToAIChatFile(abstractFile);
            });
          });
        }
      })
    );
  }
  onunload() {
    console.log("Unloading Memory Graph Plugin");
    this.app.workspace.detachLeavesOfType(VIEW_TYPE_MEMORY_SEARCH);
  }
  async activateView() {
    const { workspace } = this.app;
    let leaf = null;
    const leaves = workspace.getLeavesOfType(VIEW_TYPE_MEMORY_SEARCH);
    if (leaves.length > 0) {
      leaf = leaves[0];
    } else {
      leaf = workspace.getRightLeaf(false);
      if (leaf) {
        await leaf.setViewState({
          type: VIEW_TYPE_MEMORY_SEARCH,
          active: true
        });
      }
    }
    if (leaf) {
      workspace.revealLeaf(leaf);
    }
  }
  /**
   * 从编辑器分析并上传内容
   */
  async analyzeAndUploadFromEditor(editor, view) {
    var _a;
    console.log("[Context Menu] \u4ECE\u7F16\u8F91\u5668\u5206\u6790\u5E76\u4E0A\u4F20");
    const selection = editor.getSelection();
    const content = selection || editor.getValue();
    if (!content.trim()) {
      new import_obsidian21.Notice("\u6CA1\u6709\u53EF\u5206\u6790\u7684\u5185\u5BB9");
      return;
    }
    new import_obsidian21.Notice("\u5206\u6790\u5E76\u4E0A\u4F20\u529F\u80FD\u5F00\u53D1\u4E2D...");
    console.log("[Context Menu] \u5F85\u5206\u6790\u5185\u5BB9\u957F\u5EA6:", content.length);
    console.log("[Context Menu] \u6587\u4EF6\u8DEF\u5F84:", (_a = view.file) == null ? void 0 : _a.path);
  }
  /**
   * 分析并上传单个文件
   */
  async analyzeAndUploadFile(file) {
    console.log("[Context Menu] \u5206\u6790\u5E76\u4E0A\u4F20\u6587\u4EF6:", file.path);
    try {
      const content = await this.app.vault.read(file);
      if (!content.trim()) {
        new import_obsidian21.Notice("\u6587\u4EF6\u5185\u5BB9\u4E3A\u7A7A");
        return;
      }
      new import_obsidian21.Notice(`\u6B63\u5728\u5206\u6790\u6587\u4EF6: ${file.name}`);
      console.log("[Context Menu] \u6587\u4EF6\u5185\u5BB9\u957F\u5EA6:", content.length);
      new import_obsidian21.Notice("\u5206\u6790\u5E76\u4E0A\u4F20\u529F\u80FD\u5F00\u53D1\u4E2D...");
    } catch (error) {
      console.error("[Context Menu] \u8BFB\u53D6\u6587\u4EF6\u5931\u8D25:", error);
      new import_obsidian21.Notice("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25");
    }
  }
  /**
   * 分析并上传文件夹中的所有文件
   */
  async analyzeAndUploadFolder(folder) {
    console.log("[Context Menu] \u5206\u6790\u5E76\u4E0A\u4F20\u6587\u4EF6\u5939:", folder.path);
    const files = this.getMarkdownFilesInFolder(folder);
    if (files.length === 0) {
      new import_obsidian21.Notice("\u6587\u4EF6\u5939\u4E2D\u6CA1\u6709 Markdown \u6587\u4EF6");
      return;
    }
    new import_obsidian21.Notice(`\u627E\u5230 ${files.length} \u4E2A\u6587\u4EF6\uFF0C\u51C6\u5907\u5206\u6790...`);
    console.log("[Context Menu] \u6587\u4EF6\u5217\u8868:", files.map((f) => f.path));
    new import_obsidian21.Notice("\u5206\u6790\u5E76\u4E0A\u4F20\u529F\u80FD\u5F00\u53D1\u4E2D...");
  }
  /**
   * 递归获取文件夹中的所有 Markdown 文件
   */
  getMarkdownFilesInFolder(folder) {
    const files = [];
    for (const child of folder.children) {
      if (child instanceof import_obsidian21.TFile && child.extension === "md") {
        files.push(child);
      } else if (child instanceof import_obsidian21.TFolder) {
        files.push(...this.getMarkdownFilesInFolder(child));
      }
    }
    return files;
  }
  /**
   * 获取 MemorySearchView 实例
   */
  getMemorySearchView() {
    const leaves = this.app.workspace.getLeavesOfType(VIEW_TYPE_MEMORY_SEARCH);
    if (leaves.length > 0) {
      return leaves[0].view;
    }
    return null;
  }
  /**
   * 从编辑器引入内容到 AI 聊天
   */
  async introduceToAIChatFromEditor(editor, view) {
    console.log("[Context Menu] \u4ECE\u7F16\u8F91\u5668\u5F15\u5165\u5230AI\u804A\u5929");
    const selection = editor.getSelection();
    const content = selection || editor.getValue();
    if (!content.trim()) {
      new import_obsidian21.Notice("\u6CA1\u6709\u53EF\u5F15\u5165\u7684\u5185\u5BB9");
      return;
    }
    await this.activateView();
    const searchView = this.getMemorySearchView();
    if (!searchView) {
      new import_obsidian21.Notice("\u65E0\u6CD5\u6253\u5F00AI\u804A\u5929\u754C\u9762");
      return;
    }
    const chatTab = searchView.tabsContainer.querySelector('[data-type="chat"]');
    if (chatTab) {
      chatTab.click();
    }
    setTimeout(() => {
      var _a;
      let displayName;
      if (selection) {
        const preview = content.substring(0, 10).trim();
        displayName = preview + "...";
      } else {
        displayName = ((_a = view.file) == null ? void 0 : _a.basename) || "\u672A\u547D\u540D";
      }
      searchView.chatView.setContextFile(displayName, content);
      searchView.chatView.chatInput.focus();
      new import_obsidian21.Notice(`\u5DF2\u5C06${selection ? "\u9009\u4E2D\u5185\u5BB9" : displayName}\u6CE8\u5165\u5230\u804A\u5929\u4E0A\u4E0B\u6587`);
    }, 100);
  }
  /**
   * 从文件引入内容到 AI 聊天
   */
  async introduceToAIChatFile(file) {
    console.log("[Context Menu] \u4ECE\u6587\u4EF6\u5F15\u5165\u5230AI\u804A\u5929:", file.path);
    try {
      const content = await this.app.vault.read(file);
      if (!content.trim()) {
        new import_obsidian21.Notice("\u6587\u4EF6\u5185\u5BB9\u4E3A\u7A7A");
        return;
      }
      await this.activateView();
      const searchView = this.getMemorySearchView();
      if (!searchView) {
        new import_obsidian21.Notice("\u65E0\u6CD5\u6253\u5F00AI\u804A\u5929\u754C\u9762");
        return;
      }
      const chatTab = searchView.tabsContainer.querySelector('[data-type="chat"]');
      if (chatTab) {
        chatTab.click();
      }
      setTimeout(() => {
        searchView.chatView.setContextFile(file.basename, content);
        searchView.chatView.chatInput.focus();
        new import_obsidian21.Notice(`\u5DF2\u5C06 ${file.name} \u6CE8\u5165\u5230\u804A\u5929\u4E0A\u4E0B\u6587`);
      }, 100);
    } catch (error) {
      console.error("[Context Menu] \u8BFB\u53D6\u6587\u4EF6\u5931\u8D25:", error);
      new import_obsidian21.Notice("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25");
    }
  }
  /**
   * 从文件夹引入内容到 AI 聊天
   */
  async introduceToAIChatFolder(folder) {
    console.log("[Context Menu] \u4ECE\u6587\u4EF6\u5939\u5F15\u5165\u5230AI\u804A\u5929:", folder.path);
    const files = this.getMarkdownFilesInFolder(folder);
    if (files.length === 0) {
      new import_obsidian21.Notice("\u6587\u4EF6\u5939\u4E2D\u6CA1\u6709 Markdown \u6587\u4EF6");
      return;
    }
    try {
      const fileContents = [];
      for (const file of files) {
        const content = await this.app.vault.read(file);
        if (content.trim()) {
          fileContents.push(`## ${file.path}

${content}`);
        }
      }
      if (fileContents.length === 0) {
        new import_obsidian21.Notice("\u6587\u4EF6\u5939\u4E2D\u6CA1\u6709\u6709\u6548\u5185\u5BB9");
        return;
      }
      await this.activateView();
      const searchView = this.getMemorySearchView();
      if (!searchView) {
        new import_obsidian21.Notice("\u65E0\u6CD5\u6253\u5F00AI\u804A\u5929\u754C\u9762");
        return;
      }
      const chatTab = searchView.tabsContainer.querySelector('[data-type="chat"]');
      if (chatTab) {
        chatTab.click();
      }
      setTimeout(() => {
        const combinedContent = fileContents.join("\n\n---\n\n");
        const folderName = `${folder.name} (${fileContents.length}\u4E2A\u6587\u4EF6)`;
        searchView.chatView.setContextFile(folderName, combinedContent);
        searchView.chatView.chatInput.focus();
        new import_obsidian21.Notice(`\u5DF2\u5C06\u6587\u4EF6\u5939 ${folder.name} \u7684 ${fileContents.length} \u4E2A\u6587\u4EF6\u6CE8\u5165\u5230\u804A\u5929\u4E0A\u4E0B\u6587`);
      }, 100);
    } catch (error) {
      console.error("[Context Menu] \u8BFB\u53D6\u6587\u4EF6\u5939\u5931\u8D25:", error);
      new import_obsidian21.Notice("\u8BFB\u53D6\u6587\u4EF6\u5939\u5931\u8D25");
    }
  }
  /**
   * 手动同步所有观察记录
   */
  async syncAllObservations() {
    console.log("[Manual Sync] \u5F00\u59CB\u624B\u52A8\u540C\u6B65\u6240\u6709\u89C2\u5BDF\u8BB0\u5F55");
    const syncFolder = this.settings.syncTargetFolder;
    if (!syncFolder) {
      new import_obsidian21.Notice("\u274C \u8BF7\u5148\u8BBE\u7F6E\u540C\u6B65\u76EE\u6807\u76EE\u5F55");
      return;
    }
    try {
      const allFiles = this.app.vault.getMarkdownFiles();
      const observationFiles = allFiles.filter(
        (f) => f.path.startsWith(syncFolder) && f.path.includes("/\u89C2\u5BDF/")
      );
      if (observationFiles.length === 0) {
        new import_obsidian21.Notice("\u672A\u627E\u5230\u89C2\u5BDF\u6587\u4EF6");
        return;
      }
      new import_obsidian21.Notice(`\u627E\u5230 ${observationFiles.length} \u4E2A\u89C2\u5BDF\u6587\u4EF6\uFF0C\u5F00\u59CB\u540C\u6B65...`);
      console.log(`[Manual Sync] \u627E\u5230 ${observationFiles.length} \u4E2A\u89C2\u5BDF\u6587\u4EF6`);
      new import_obsidian21.Notice("\u2705 \u540C\u6B65\u5B8C\u6210\uFF08\u529F\u80FD\u5F00\u53D1\u4E2D\uFF09");
    } catch (error) {
      console.error("[Manual Sync] \u540C\u6B65\u5931\u8D25:", error);
      new import_obsidian21.Notice(`\u274C \u540C\u6B65\u5931\u8D25: ${error.message}`);
    }
  }
  async loadSettings() {
    this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
  }
  async saveSettings() {
    await this.saveData(this.settings);
  }
};
__name(_MemoryGraphPlugin, "MemoryGraphPlugin");
var MemoryGraphPlugin7 = _MemoryGraphPlugin;
